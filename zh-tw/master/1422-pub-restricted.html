<!DOCTYPE HTML>
<html lang="zh_TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>1422-pub-restricted - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-c5bb60c5.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Feature Name: pub_restricted</li>
<li>Start Date: 2015-12-18</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/1422">rust-lang/rfcs#1422</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/32409">rust-lang/rust#32409</a></li>
</ul>
<h2 id="摘要"><a class="header" href="#摘要">摘要</a></h2>
<p>Expand the current <code>pub</code>/non-<code>pub</code> categorization of items with the ability to say “make this item visible <em>solely</em> to a (named) module tree.”</p>
<p>The current <code>crate</code> is one such tree, and would be expressed via: <code>pub(crate) item</code>. Other trees can be denoted via a path employed in a <code>use</code> statement, e.g. <code>pub(a::b) item</code>, or <code>pub(super) item</code>.</p>
<h2 id="動機"><a class="header" href="#動機">動機</a></h2>
<p>Right now, if you have a definition for an item <code>X</code> that you want to use in many places in a module tree, you can either (1.) define <code>X</code> at the root of the tree as a non-<code>pub</code> item, or (2.) you can define <code>X</code> as a <code>pub</code> item in some submodule (and import into the root of the module tree via <code>use</code>).</p>
<p>But: Sometimes neither of these options is really what you want.</p>
<p>There are scenarios where developers would like an item to be visible to a particular module subtree (or a whole crate in its entirety), but it is not possible to move the item’s (non-pub) definition to the root of that subtree (which would be the usual way to expose an item to a subtree without making it pub).</p>
<p>If the definition of <code>X</code> itself needs access to other private items within a submodule of the tree, then <code>X</code> <em>cannot</em> be put at the root of the module tree. Illustration:</p>
<pre><code class="language-rust">// Intent: `a` exports `I`, `bar`, and `foo`, but nothing else.
pub mod a {
    pub const I: i32 = 3;

    // `semisecret` will be used "many" places within `a`, but
    // is not meant to be exposed outside of `a`.
    fn semisecret(x: i32) -&gt; i32  { use self::b::c::J; x + J }

    pub fn bar(z: i32) -&gt; i32 { semisecret(I) * z }
    pub fn foo(y: i32) -&gt; i32 { semisecret(I) + y }

    mod b {
        mod c {
            const J: i32 = 4; // J is meant to be hidden from the outside world.
        }
    }
}</code></pre>
<p>(Note: the <code>pub mod a</code> is meant to be at the root of some crate.)</p>
<p>The latter code fails to compile, due to the privacy violation where the body of <code>fn semisecret</code> attempts to access <code>a::b::c::J</code>, which is not visible in the context of <code>a</code>.</p>
<p>A standard way to deal with this today is to use the second approach described above (labelled “(2.)”): move <code>fn semisecret</code> down into the place where it can access <code>J</code>, marking <code>fn semisecret</code> as <code>pub</code> so that it can still be accessed within the items of <code>a</code>, and then re-exporting <code>semisecret</code> as necessary up the module tree.</p>
<pre><code class="language-rust">// Intent: `a` exports `I`, `bar`, and `foo`, but nothing else.
pub mod a {
    pub const I: i32 = 3;

    // `semisecret` will be used "many" places within `a`, but
    // is not meant to be exposed outside of `a`.
    // (If we put `pub use` here, then *anyone* could access it.)
    use self::b::semisecret;

    pub fn bar(z: i32) -&gt; i32 { semisecret(I) * z }
    pub fn foo(y: i32) -&gt; i32 { semisecret(I) + y }

    mod b {
        pub use self::c::semisecret;
        mod c {
            const J: i32 = 4; // J is meant to be hidden from the outside world.
            pub fn semisecret(x: i32) -&gt; i32  { x + J }
        }
    }
}</code></pre>
<p>This works, but there is a serious issue with it: One cannot easily tell exactly how “public” <code>fn semisecret</code> is. In particular, understanding who can access <code>semisecret</code> requires reasoning about (1.) all of the <code>pub use</code>’s (aka re-exports) of <code>semisecret</code>, and (2.) the <code>pub</code>-ness of every module in a path leading to <code>fn semisecret</code> or one of its re-exports.</p>
<p>This RFC seeks to remedy the above problem via two main changes.</p>
<ol>
<li>
<p>Give the user a way to explicitly restrict the intended scope of where a <code>pub</code>-licized item can be used.</p>
</li>
<li>
<p>Modify the privacy rules so that <code>pub</code>-restricted items cannot be used nor re-exported outside of their respective restricted areas.</p>
</li>
</ol>
<h3 id="impact"><a class="header" href="#impact">Impact</a></h3>
<p>This difficulty in reasoning about the “publicness” of a name is not just a problem for users; it also complicates efforts within the compiler to verify that a surface API for a type does not itself use or expose any private names.</p>
<p><a href="https://github.com/rust-lang/rust/issues/18241">There</a> are <a href="https://github.com/rust-lang/rust/issues/28325">a</a> number <a href="https://github.com/rust-lang/rust/issues/28450">of</a> bugs <a href="https://github.com/rust-lang/rust/issues/28514">filed</a> against <a href="https://github.com/rust-lang/rust/issues/29668">privacy</a> checking; some are simply implementation issues, but the comment threads in the issues make it clear that in some cases, different people have very different mental models about how privacy interacts with aliases (e.g. <code>type</code> declarations) and re-exports.</p>
<p>In theory, we can add the changes of this RFC without breaking any old code. (That is, in principle the only affected code is that for item definitions that use <code>pub(restriction)</code>. This limited addition would still provide value to users in their reasoning about the visibility of such items.)</p>
<p>In practice, I expect that as part of the implementation of this RFC, we will probably fix pre-existing bugs in the parts of privacy checking verifying that surface API’s do not use or expose private names.</p>
<p>Important: No such fixes to such pre-existing bugs are being concretely proposed by this RFC; I am merely musing that by adding a more expressive privacy system, we will open the door to fix bugs whose exploits, under the old system, were the only way to express certain patterns of interest to developers.</p>
<!-- Trait re-exports fail due to privacy of containing module -->
<!-- Rules governing references to private types in public APIs not enforced in impls -->
<!-- Type alias can be used to bypass privacy check -->
<!-- Private trait's methods reachable through a public supertrait -->
<!-- Non-exported type in exported type signature does not error -->
<!-- Ban private items in public APIs -->
<!-- The original definition of public items was based on reachability rather than simply checking whether the item is declared pub or not. The RFC also did not describe how privacy and impl definitions are related. -->
<h2 id="詳細設計"><a class="header" href="#詳細設計">詳細設計</a></h2>
<p>The main problem identified in the <a href="#motivation">motivation</a> section is this:</p>
<p>From an module-internal definition like</p>
<pre><code class="language-rust">pub mod a { [...] mod b { [...] pub fn semisecret(x: i32) -&gt; i32  { x + J } [...] } }</code></pre>
<p>one cannot readily tell exactly how “public” the <code>fn semisecret</code> is meant to be.</p>
<p>As already stated, this RFC seeks to remedy the above problem via two main changes.</p>
<ol>
<li>
<p>Give the user a way to explicitly restrict the intended scope of where a <code>pub</code>-licized item can be used.</p>
</li>
<li>
<p>Modify the privacy rules so that <code>pub</code>-restricted items cannot be used nor re-exported outside of their respective restricted areas.</p>
</li>
</ol>
<h3 id="syntax"><a class="header" href="#syntax">Syntax</a></h3>
<p>The new feature is to restrict the scope by adding the module subtree (which acts as the restricted area) in parentheses after the <code>pub</code> keyword, like so:</p>
<pre><code class="language-rust">pub(a::b::c) item;</code></pre>
<p>The path in the restriction is resolved just like a <code>use</code> statement: it is resolved absolutely, from the crate root.</p>
<p>Just like <code>use</code> statements, one can also write relative paths, by starting them with <code>self</code> or a sequence of <code>super</code>’s.</p>
<pre><code class="language-rust">pub(super::super) item;
// or
pub(self) item; // (semantically equiv to no `pub`; see below)</code></pre>
<p>In addition to the forms analogous to <code>use</code>, there is one new form:</p>
<pre><code class="language-rust">pub(crate) item;</code></pre>
<p>In other words, the grammar is changed like so:</p>
<p>old:</p>
<pre><code>VISIBILITY ::= &lt;empty&gt; | `pub`
</code></pre>
<p>new:</p>
<pre><code>VISIBILITY ::= &lt;empty&gt; | `pub` | `pub` `(` USE_PATH `)` | `pub` `(` `crate` `)`
</code></pre>
<p>One can use these <code>pub(restriction)</code> forms anywhere that one can currently use <code>pub</code>. In particular, one can use them on item definitions, methods in an impl, the fields of a struct definition, and on <code>pub use</code> re-exports.</p>
<h3 id="semantics"><a class="header" href="#semantics">Semantics</a></h3>
<p>The meaning of <code>pub(restriction)</code> is as follows: The definition of every item, method, field, or name (e.g. a re-export) is associated with a restriction.</p>
<p>A restriction is either: the universe of all crates (aka “unrestricted”), the current crate, or an absolute path to a module sub-hierarchy in the current crate. A restricted thing cannot be directly “used” in source code outside of its restricted area.  (The term “used” here is meant to cover both direct reference in the source, and also implicit reference as the inferred type of an expression or pattern.)</p>
<ul>
<li>
<p><code>pub</code> written with no explicit restriction means that there is no restriction, or in other words, the restriction is the universe of all crates.</p>
</li>
<li>
<p><code>pub(crate)</code> means that the restriction is the current crate.</p>
</li>
<li>
<p><code>pub(&lt;path&gt;)</code> means that the restriction is the module sub-hierarchy denoted by <code>&lt;path&gt;</code>, resolved in the context of the occurrence of the <code>pub</code> modifier. (This is to ensure that <code>super</code> and <code>self</code> make sense in such paths.)</p>
</li>
</ul>
<p>As noted above, the definition means that <code>pub(self) item</code> is the same as if one had written just <code>item</code>.</p>
<ul>
<li>The main reason to support this level of generality (which is otherwise just “redundant syntax”) is macros: one can write a macro that expands to <code>pub($arg) item</code>, and a macro client can pass in <code>self</code> as the <code>$arg</code> to get the effect of a non-pub definition.</li>
</ul>
<p>NOTE: even if the restriction of an item or name indicates that it is accessible in some context, it may still be impossible to reference it. In particular, we will still keep our existing rules regarding <code>pub</code> items defined in non-<code>pub</code> modules; such items would have no restriction, but still may be inaccessible if they are not re-exported in some manner.</p>
<h3 id="revised-example"><a class="header" href="#revised-example">Revised Example</a></h3>
<p>In the running example, one could instead write:</p>
<pre><code class="language-rust">// Intent: `a` exports `I`, `bar`, and `foo`, but nothing else.
pub mod a {
    pub const I: i32 = 3;

    // `semisecret` will be used "many" places within `a`, but
    // is not meant to be exposed outside of `a`.
    // (`pub use` would be *rejected*; see Note 1 below)
    use self::b::semisecret;

    pub fn bar(z: i32) -&gt; i32 { semisecret(I) * z }
    pub fn foo(y: i32) -&gt; i32 { semisecret(I) + y }

    mod b {
        pub(a) use self::c::semisecret;
        mod c {
            const J: i32 = 4; // J is meant to be hidden from the outside world.

            // `pub(a)` means "usable within hierarchy of `mod a`, but not
            // elsewhere."
            pub(a) fn semisecret(x: i32) -&gt; i32  { x + J }
        }
    }
}</code></pre>
<p>Note 1: The compiler would reject the variation of the above written as:</p>
<pre><code class="language-rust">pub mod a { [...] pub use self::b::semisecret; [...] }</code></pre>
<p>because <code>pub(a) fn semisecret</code> says that it cannot be used outside of <code>a</code>, and therefore it be incorrect (or at least useless) to reexport <code>semisecret</code> outside of <code>a</code>.</p>
<p>Note 2: The most direct interpretation of the rules here leads me to conclude that <code>b</code>’s re-export of <code>semisecret</code> needs to be restricted to <code>a</code> as well. However, it may be possible to loosen things so that the re-export could just stay as <code>pub</code> with no extra restriction; see discussion of “IRS:PUNPM” in Unresolved Questions.</p>
<p>This richer notion of privacy does offer us some other ways to re-write the running example; instead of defining <code>fn semisecret</code> within <code>c</code> so that it can access <code>J</code>, we might instead expose <code>J</code> to <code>mod b</code> and then put <code>fn semisecret</code>, like so:</p>
<pre><code class="language-rust">pub mod a {
    [...]
    mod b {
        use self::c::J;
        pub(a) fn semisecret(x: i32) -&gt; i32  { x + J }
        mod c {
            pub(b) const J: i32 = 4;
        }
    }
}</code></pre>
<p>(This RFC takes no position on which of the above two structures is “better”; a toy example like this does not provide enough context to judge.)</p>
<h3 id="restrictions"><a class="header" href="#restrictions">Restrictions</a></h3>
<p>Lets discuss what the restrictions actually mean.</p>
<p>Some basic definitions: An item is just as it is declared in the Rust reference manual: a component of a crate, located at a fixed path (potentially at the “outermost” anonymous module) within the module tree of the crate.</p>
<p>Every item can be thought of as having some hidden implementation component(s) along with an exposed surface API.</p>
<p>So, for example, in <code>pub fn foo(x: Input) -&gt; Output { Body }</code>, the surface of <code>foo</code> includes <code>Input</code> and <code>Output</code>, while the <code>Body</code> is hidden.</p>
<p>The pre-existing privacy rules (both prior to and after this RFC) try to enforce two things: (1.) when a item references a path, all of the names on that path need to be visible (in terms of privacy) in the referencing context and, (2.) private items should not be exposed in the surface of public API’s.</p>
<ul>
<li>I am using the term “surface” rather than “signature” deliberately, since I think the term “signature” is too broad to be used to accurately describe the current semantics of rustc. See my recent <a href="http://blog.pnkfx.org/blog/2015/12/19/signatures-and-surfaces-thoughts-on-privacy-versus-dependency/">Surface blog post</a> for further discussion.</li>
</ul>
<p>This RFC is expanding the scope of (2.) above, so that the rules are now:</p>
<ol>
<li>
<p>when a item references a path (in its implementation or in its signature), all of the names on that path must be visible in the referencing context.</p>
</li>
<li>
<p>items <em>restricted</em> to an area R should not be exposed in the surface API of names or items that can themselves be exported beyond R. (Privacy is now a special case of this more general notion.)</p>
<p>For convenience, it is legal to declare a field (or inherent method) with a strictly larger area of restriction than its <code>self</code>. See discussion in the <a href="#fields-and-inherent-methods-more-public-than-self">examples</a>.</p>
</li>
</ol>
<p>In principle, validating (1.) can be done via the pre-existing privacy code. (However, it may make sense to do it by mapping each name to its associated restriction; I don’t think that will change the outcome, but it might make the checking code simpler. But I am not an expert on the current state of the privacy checking code.)</p>
<p>Validating (2.) requires traversing the surface API for each item and comparing the restriction for every reference to the restriction of the item itself.</p>
<h3 id="trait-methods"><a class="header" href="#trait-methods">Trait methods</a></h3>
<p>Currently, trait associated item syntax carries no <code>pub</code> modifier.</p>
<p>A question arises when trying to apply the terminology of this RFC: are trait associated items implicitly <code>pub</code>, in the sense that they are unrestricted?</p>
<p>The simple answer is: No, associated items are not implicitly <code>pub</code>; at least, not in general. (They are not in general implicitly <code>pub</code> today either, as discussed in <a href="https://github.com/rust-lang/rfcs/blob/master/text/0136-no-privates-in-public.md#when-is-an-item-public">RFC 136</a>.) (If they were implicitly <code>pub</code>, things would be difficult; further discussion in attached <a href="#associated-items-digression">appendix</a>.)</p>
<p>However, since this RFC is introducing multiple kinds of <code>pub</code>, we should address the topic of what <em>is</em> the <code>pub</code>-ness of associated items.</p>
<ul>
<li>
<p>When analyzing a trait definition, then associated items should be considered to inherit the <code>pub</code>-ness, if any, of their defining trait.</p>
<p>We want to make sure that this code continues to work:</p>
<pre><code class="language-rust">mod a {
    struct S(String);
    trait Trait {
        fn make_s(&amp;self) -&gt; S; // referencing `S` is ok, b/c `Trait` is not `pub`
    }
}</code></pre>
<p>And under this RFC, we now allow this as well:</p>
<pre><code class="language-rust">mod a {
    struct S(String);
    mod b {
        pub(a) trait Trait {
            fn mk_s(&amp;self) -&gt; ::a::S;
            // referencing `::a::S` is ok, b/c `Trait` is restricted to `::a`
        }
    }
    use self::b::Trait;
}</code></pre>
<p>Note that in stable Rust today, it is an error to declare the latter trait within <code>mod b</code> as non-<code>pub</code> (since the <code>use self::b::Trait</code> would be referencing a private item), <em>and</em> in the Rust nightly channel it is a warning to declare it as <code>pub trait Trait { ... }</code>.</p>
<p>The point of this RFC is to give users a sensible way to declare such traits within <code>b</code>, without allowing them to be exposed outside of <code>a</code>.</p>
</li>
<li>
<p>When analyzing an <code>impl Trait for Type</code>, there may be distinct restrictions assigned to the <code>Trait</code> and the <code>Type</code>. However, since both the <code>Trait</code> and the <code>Type</code> must be visible in the context of the module where the <code>impl</code> occurs, there should be a subtree relationship between the two restrictions; in other words, one restriction should be less than (or equal to) the other.</p>
<p>So just use the minimum of the two restrictions when analyzing the right-hand sides of the associated items in the impl.</p>
<p>Note: I am largely adopting this rule in an attempt to be consistent with <a href="https://github.com/rust-lang/rfcs/blob/master/text/0136-no-privates-in-public.md#when-is-an-item-public">RFC 136</a>. I invite discussion of whether this rule actually makes sense as phrased here.</p>
</li>
</ul>
<h3 id="more-examples"><a class="header" href="#more-examples">More examples!</a></h3>
<p>These examples meant to explore the syntax a bit. They are <em>not</em> meant to provide motivation for the feature (i.e. I am not claiming that the feature is making this code cleaner or easier to reason about).</p>
<h4 id="impl-item-example"><a class="header" href="#impl-item-example">Impl item example</a></h4>
<pre><code class="language-rust">pub struct S(i32);

mod a {
    pub fn call_foo(s: &amp;super::S) { s.foo(); }

    mod b {
        fn some_method_private_to_b() {
            println!("inside some_method_private_to_b");
        }

        impl super::super::S {
            pub(a) fn foo(&amp;self) {
                some_method_private_to_b();
                println!("only callable within `a`: {}", self.0);
            }
        }
    }
}

fn rejected(s: &amp;S) {
    s.foo(); //~ ERROR: `S::foo` not visible outside of module `a`
}</code></pre>
<p>(You may be wondering: “Could we move that <code>impl S</code> out to the top-level, out of <code>mod a</code>?” Well … see discussion in the <a href="#can-definition-site-fall-outside-restriction">unresolved questions</a>.)</p>
<h4 id="restricting-fields-example"><a class="header" href="#restricting-fields-example">Restricting fields example</a></h4>
<pre><code class="language-rust">mod a {
    #[derive(Default)]
    struct Priv(i32);

    pub mod b {
        use a::Priv as Priv_a;

        #[derive(Default)]
        pub struct F {
            pub    x: i32,
                   y: Priv_a,
            pub(a) z: Priv_a,
        }

        #[derive(Default)]
        pub struct G(pub i32, Priv_a, pub(a) Priv_a);

        // ... accesses to F.{x,y,z} ...
        // ... accesses to G.{0,1,2} ...
    }
    // ... accesses to F.{x,z} ...
    // ... accesses to G.{0,2} ...
}

mod k {
    use a::b::{F, G};
    // ... accesses to F and F.x ...
    // ... accesses to G and G.0 ...
}</code></pre>
<h4 id="fields-and-inherent-methods-more-public-than-self"><a class="header" href="#fields-and-inherent-methods-more-public-than-self">Fields and inherent methods more public than self</a></h4>
<p>In Rust today, one can write</p>
<pre><code class="language-rust">mod a { struct X { pub y: i32, } }</code></pre>
<p>This RFC was crafted to say that fields and inherent methods can have an associated restriction that is larger than the restriction of its <code>self</code>. This was both to keep from breaking the above code, and also because it would be annoying to be forced to write:</p>
<pre><code class="language-rust">mod a { struct X { pub(a) y: i32, } }</code></pre>
<p>(This RFC is not an attempt to resolve things like <a href="https://github.com/rust-lang/rust/issues/30079">Rust Issue 30079</a>; the decision of how to handle that issue can be dealt with orthogonally, in my opinion.)</p>
<p>So, under this RFC, the following is legal:</p>
<pre><code class="language-rust">mod a {
    pub use self::b::stuff_with_x;
    mod b {
        struct X { pub y: i32, pub(a) z: i32 }
        mod c {
            impl super::X {
                pub(c) fn only_in_c(&amp;mut self) { self.y += 1; }

                pub fn callanywhere(&amp;mut self) {
                    self.only_in_c();
                    println!("X.y is now: {}", self.y);
                }
            }
        }
        pub fn stuff_with_x() {
            let mut x = X { y: 10, z: 20};
            x.callanywhere();
        }
    }
}</code></pre>
<p>In particular:</p>
<ul>
<li>
<p>It is okay that the fields <code>y</code> and <code>z</code> and the inherent method <code>fn callanywhere</code> are more publicly visible than <code>X</code>.</p>
<p>(Just because we declare something <code>pub</code> does not mean it will actually be <em>possible</em> to reach it from arbitrary contexts. Whether or not such access is possible will depend on many things, including but not limited to the restriction attached and also future decisions about issues like <a href="https://github.com/rust-lang/rust/issues/30079">issue 30079</a>.)</p>
</li>
<li>
<p>We are allowed to restrict an inherent method, <code>fn only_in_c</code>, to a subtree of the module tree where <code>X</code> is itself visible.</p>
</li>
</ul>
<h4 id="re-exports"><a class="header" href="#re-exports">Re-exports</a></h4>
<p>Here is an example of a <code>pub use</code> re-export using the new feature, including both correct and invalid uses of the extended form.</p>
<pre><code class="language-rust">mod a {
    mod b {
        pub(a) struct X { pub y: i32, pub(a) z: i32 } // restricted to `mod a` tree
        mod c {
            pub mod d {
                pub(super) use a::b::X as P; // ok: a::b::c is submodule of `a`
            }

            fn swap_ok(x: d::P) -&gt; d::P { // ok: `P` accessible here
                X { z: x.y, y: x.z }
            }
        }

        fn swap_bad(x: c::d::P) -&gt; c::d::P { //~ ERROR: `c::d::P` not visible outside `a::b::c`
            X { z: x.y, y: x.z }
        }

        mod bad {
            pub use super::X; //~ ERROR: `X` cannot be reexported outside of `a`
        }
    }

    fn swap_ok2(x: X) -&gt; X { // ok: `X` accessible from `mod a`.
        X { z: x.y, y: x.z }
    }
}</code></pre>
<h4 id="crate-restricted-visibility"><a class="header" href="#crate-restricted-visibility">Crate restricted visibility</a></h4>
<p>This is a concrete illusration of how one might use the <code>pub(crate) item</code> form, (which is perhaps quite similar to Java’s default “package visibility”).</p>
<p>Crate <code>c1</code>:</p>
<pre><code class="language-rust">pub mod a {
    struct Priv(i32);

    pub(crate) struct R { pub y: i32, z: Priv } // ok: field allowed to be more public
    pub        struct S { pub y: i32, z: Priv }

    pub fn to_r_bad(s: S) -&gt; R { ... } //~ ERROR: `R` restricted solely to this crate

    pub(crate) fn to_r(s: S) -&gt; R { R { y: s.y, z: s.z } } // ok: restricted to crate
}

use a::{R, S}; // ok: `a::R` and `a::S` are both visible

pub use a::R as ReexportAttempt; //~ ERROR: `a::R` restricted solely to this crate</code></pre>
<p>Crate <code>c2</code>:</p>
<pre><code class="language-rust">extern crate c1;

use c1::a::S; // ok: `S` is unrestricted

use c1::a::R; //~ ERROR: `c1::a::R` not visible outside of its crate</code></pre>
<h3 id="precedent"><a class="header" href="#precedent">Precedent</a></h3>
<p>When I started on this I was not sure if this form of delimited access to a particular module subtree had a precedent; the closest thing I could think of was C++ <code>friend</code> modifiers (but <code>friend</code> is far more ad-hoc and free-form than what is being proposed here).</p>
<h4 id="scala"><a class="header" href="#scala">Scala</a></h4>
<p>It has since been pointed out to me that Scala has scoped access modifiers <code>protected[Y]</code> and <code>private[Y]</code>, which specify that access is provided upto <code>Y</code> (where <code>Y</code> can be a package, class or singleton object).</p>
<p>The feature proposed by this RFC appears to be similar in intent to Scala’s scoped access modifiers.</p>
<p>Having said that, I will admit that I am not clear on what distinction, if any, Scala draws between <code>protected[Y]</code> and <code>private[Y]</code> when <code>Y</code> is a package, which is the main analogy for our purposes, or if they just allow both forms as synonyms for convenience.</p>
<p>(I can imagine a hypothetical distinction in Scala when <code>Y</code> is a class, but my skimming online has not provided insight as to what the actual distinction is.)</p>
<p>Even if there is some distinction drawn between the two forms in Scala, I suspect Rust does not need an analogous distinction in it’s <code>pub(restricted)</code></p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p>Obviously, <code>pub(restriction) item</code> complicates the surface syntax of the language.</p>
<ul>
<li>However, my counter-argument to this drawback is that this feature in fact <em>simplifies</em> the developer’s mental model. It is easier to directly encode the expected visibility of an item via <code>pub(restriction)</code> than to figure out the right concoction via a mix of nested <code>mod</code> and <code>pub use</code> statements. And likewise, it is easier to read it too.</li>
</ul>
<p>Developers may misuse this form and make it hard to access the tasty innards of other modules.</p>
<ul>
<li>
<p>This is true, but I claim it is irrelevant.</p>
<p>The effect of this change is solely on the visibility of items <em>within</em> a crate. No rules for inter-crate access change.</p>
<p>From the perspective of cross-crate development, this RFC changes nothing, except that it may lead some crate authors to make some things no longer universally <code>pub</code> that they were forced to make visible before due to earlier limitations. I claim that in such cases, those crate authors probably always intended for such items to be non-<code>pub</code>, but language limitations were forcing their hand.</p>
<p>As for intra-crate access: My expectation is that an individual crate will be made by a team of developers who can work out what mutual visibility they want and how it should evolve over time. This feature may affect their work flow to some degree, but they can choose to either use it or not, based on their own internal policies.</p>
</li>
</ul>
<h2 id="替代方案"><a class="header" href="#替代方案">替代方案</a></h2>
<h3 id="do-not-extend-the-language"><a class="header" href="#do-not-extend-the-language">Do not extend the language!</a></h3>
<ul>
<li>
<p>Change privacy rules and make privacy analysis “smarter” (e.g. global reachabiliy analysis)</p>
<p>The main problem with this approach is that we tried it, and it did not work well: The implementation was buggy, and the user-visible error messages were hard to understand.</p>
<p>See discussion when the team was discussing the <a href="https://github.com/rust-lang/meeting-minutes/blob/master/weekly-meetings/2014-09-16.md#rfc-public-items">public items amendment</a></p>
</li>
<li>
<p>“Fix” the mental model of privacy (if necessary) without extending the language.</p>
<p>The alternative is basically saying: “Our existing system is fine; all of the problems with it are due to bugs in the implementation”</p>
<p>I am sympathetic to this response. However, I think it doesn’t quite hold up. Some users want to be able to define items that are exposed outside of their module but still restrict the scope of where they can be referenced, as discussed in the <a href="#motivation">motivation</a> section, and I do not think the current model can be “fixed” to support that use case, at least not without adding some sort of global reachability analysis as discussed in the previous bullet.</p>
</li>
</ul>
<p>In addition, these two alternatives do not address the main point being made in the <a href="#motivation">motivation</a> section: one cannot tell exactly how “public” a <code>pub</code> item is, without working backwards through the module tree for all of its re-exports.</p>
<h3 id="curb-your-ambitions"><a class="header" href="#curb-your-ambitions">Curb your ambitions!</a></h3>
<ul>
<li>
<p>Instead of adding support for restricting to arbitrary module subtrees, narrow the feature to just <code>pub(crate) item</code>, so that one chooses either “module private” (by adding no modifier), or “universally visible” (by adding <code>pub</code>), or “visible to just the current crate” (by adding <code>pub(crate)</code>).</p>
<p>This would be somewhat analogous to Java’s relatively coarse grained privacy rules, where one can choose <code>public</code>, <code>private</code>, <code>protected</code>, or the unnamed “package” visibility.</p>
<p>I am all for keeping the implementation simple. However, the reason that we should support arbitrary module subtrees is that doing so will enable certain refactorings. Namely, if I decide I want to inline the definition for one or more crates <code>A1</code>, <code>A2</code>, … into client crate <code>C</code> (i.e. replacing <code>extern crate A1;</code> with an suitably defined <code>mod A1 { ... }</code>, but I do not want to worry about whether doing so will risk future changes violating abstraction boundaries that were previously being enforced via <code>pub(crate)</code>, then I believe allowing <code>pub(path)</code> will allow a mechanical tool to do the inline refactoring, rewriting each <code>pub(crate)</code> as <code>pub(A1)</code> as necessary.</p>
</li>
</ul>
<h3 id="be-more-ambitious"><a class="header" href="#be-more-ambitious">Be more ambitious!</a></h3>
<p>This feature could be extended in various ways.</p>
<p>For example:</p>
<ul>
<li>
<p>As mentioned on the RFC comment thread, we could allow multiple paths in the restriction-specification: <code>pub(path1, path2, path3)</code>.</p>
<p>This, for better or worse, would start to look a lot like <code>friend</code> declarations from C++.</p>
</li>
<li>
<p>Also as mentioned on the RFC comment thread, the <code>pub(restricted)</code> form does not have any variant where the restrction-specification denotes the whole universe. In other words, there’s no current way to get the same effect as <code>pub item</code> via <code>pub(restricted) item</code>; you cannot say <code>pub(universe) item</code> (even though I do so in a tongue-in-cheek manner elsewhere in this RFC).</p>
<p>Some future syntaxes to support this have been proposed in the RFC comment thread, such as <code>pub(::)</code>. But this RFC is leaving the actual choice to add such an extension (and what syntax to use for it) up to a later amendment in the future.</p>
</li>
</ul>
<h2 id="未解決的問題"><a class="header" href="#未解決的問題">未解決的問題</a></h2>
<h3 id="can-definition-site-fall-outside-restriction"><a class="header" href="#can-definition-site-fall-outside-restriction">Can definition site fall outside restriction?</a></h3>
<p>For example, is it illegal to do the following:</p>
<pre><code class="language-rust">mod a {
  mod child { }
  mod b { pub(super::child) const J: i32 = 3; }
}</code></pre>
<p>Or does it just mean that <code>J</code>, despite being defined in <code>mod b</code>, is itself not accessible in <code>mod b</code>?</p>
<p>pnkfelix is personally inclined to make this sort of thing illegal, mainly because he finds it totally unintuitive, but is interested in hearing counter-arguments.</p>
<h3 id="implicit-restriction-satisfaction-irspunpm"><a class="header" href="#implicit-restriction-satisfaction-irspunpm">Implicit Restriction Satisfaction (IRS:PUNPM)</a></h3>
<p>If a re-export occurs within a non-<code>pub</code> module, can we treat it as implicitly satisfying a restriction to <code>super</code> imposed by the item it is re-exporting?</p>
<p>In particular, the <a href="#revised-example">revised example</a> included:</p>
<pre><code class="language-rust">// Intent: `a` exports `I` and `foo`, but nothing else.
pub mod a {
    [...]
    mod b {
        pub(a) use self::c::semisecret;
        mod c { pub(a) fn semisecret(x: i32) -&gt; i32  { x + J } }
    }
}</code></pre>
<p>However, since <code>b</code> is non-<code>pub</code>, its <code>pub</code> items and re-exports are solely accessible via the subhierarchy of its module parent (i.e., <code>mod a</code>, as long as no entity attempts to re-export them to a broader scope.</p>
<p>In other words, in some sense <code>mod b { pub use item; }</code> <em>could</em> implicitly satisfy a restriction to <code>super</code> imposed by <code>item</code> (if we chose to allow it).</p>
<p>Note: If it were <code>pub mod b</code> or <code>pub(restrict) mod b</code>, then the above reasoning would not hold.  Therefore, this discussion is limited to re-exports from non-<code>pub</code> modules.</p>
<p>If we do not allow such implicit restriction satisfaction for <code>pub use</code> re-exports from non-<code>pub</code> modules (IRS:PUNPM), then:</p>
<pre><code class="language-rust">pub mod a {
    [...]
    mod b {
        pub use self::c::semisecret;
        mod c { pub(a) fn semisecret(x: i32) -&gt; i32  { x + J } }
    }
}</code></pre>
<p>would be rejected, and one would be expected to write either:</p>
<pre><code class="language-rust">        pub(super) use self::c::semisecret;</code></pre>
<p>or</p>
<pre><code class="language-rust">        pub(a) use self::c::semisecret;</code></pre>
<p>(Side note: I am <em>not</em> saying that under IRS:PUNPM, the two forms <code>pub use item</code> and <code>pub(super) use item</code> would be considered synonymous, even in the context of a non-pub module like <code>mod b</code>. In particular, <code>pub(super) use item</code> may be imposing a new restriction on the re-exported name that was not part of its original definition.)</p>
<h3 id="interaction-with-globs"><a class="header" href="#interaction-with-globs">Interaction with Globs</a></h3>
<p>Glob re-exports currently only re-export <code>pub</code> (as in <code>pub(universe)</code> items).</p>
<p>What should glob-reepxorts do with respect to <code>pub(restricted)</code>?</p>
<p>Here is an illustrating example pointed out by petrochenkov in the comment thread:</p>
<pre><code class="language-rust">mod m {
    /*priv*/ pub(m) struct S1;
    pub(super) S2;
    pub(foo::bar) S3;
    pub S4;

    mod n {

        // What is reexported here?
        // Just `S4`?
        // Anything in `m` visible
        //  to `n` (which is not consistent with the current treatment of
        `pub` by globs).

        pub use m::*;
    }
}

// What is reexported here?
pub use m::*;
pub(baz::qux) use m::*;</code></pre>
<p>This remains an unresolved question, but my personal inclination, at least for the initial implementation, is to make globs only import purely <code>pub</code> items; no non-<code>pub</code>, and no <code>pub(restricted)</code>.</p>
<p>After we get more experience with <code>pub(restricted)</code> (and perhaps make other changes that may come in future RFCs), we will be in a better position to evaluate what to do here.</p>
<h2 id="appendices"><a class="header" href="#appendices">Appendices</a></h2>
<h3 id="associated-items-digression"><a class="header" href="#associated-items-digression">Associated Items Digression</a></h3>
<p>If associated items were implicitly <code>pub</code>, in the sense that they are unrestricted, then that would conflict with the rules imposed by this RFC, in the sense that the surface API of a non-<code>pub</code> trait is composed of its associated items, and so if all associated items were implicitly <code>pub</code> and unrestricted, then this code would be rejected:</p>
<pre><code class="language-rust">mod a {
    struct S(String);
    trait Trait {
        fn mk_s(&amp;self) -&gt; S; // is this implicitly `pub` and unrestricted?
    }
    impl Trait for () { fn mk_s(&amp;self) -&gt; S { S(format!("():()")) } }
    impl Trait for i32 { fn mk_s(&amp;self) -&gt; S { S(format!("{}:i32", self)) } }
    pub fn foo(x:i32) -&gt; String { format!("silly{}{}", ().mk_s().0, x.mk_s().0) }
}</code></pre>
<p>If associated items were implicitly <code>pub</code> and unrestricted, then the above code would be rejected under direct interpretation of the rules of this RFC (because <code>fn make_s</code> is implicitly unrestricted, but the surface of <code>fn make_s</code> references <code>S</code>, a non-<code>pub</code> item). This would be backwards-incompatible (and just darn inconvenient too).</p>
<p>So, to be clear, this RFC is <em>not</em> suggesting that associated items be implicitly <code>pub</code> and unrestricted.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="1419-slice-copy.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="1432-replace-slice.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="1419-slice-copy.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="1432-replace-slice.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
