<!DOCTYPE HTML>
<html lang="zh_TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>1789-as-cell - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-c5bb60c5.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Feature Name: as_cell</li>
<li>Start Date: 2016-11-13</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/1789">rust-lang/rfcs#1789</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/43038">rust-lang/rust#43038</a></li>
</ul>
<h2 id="摘要"><a class="header" href="#摘要">摘要</a></h2>
<ul>
<li>Change <code>Cell&lt;T&gt;</code> to allow <code>T: ?Sized</code>.</li>
<li>Guarantee that <code>T</code> and <code>Cell&lt;T&gt;</code> have the same memory layout.</li>
<li>Enable the following conversions through the std lib:
<ul>
<li><code>&amp;mut T -&gt; &amp;Cell&lt;T&gt; where T: ?Sized</code></li>
<li><code>&amp;Cell&lt;[T]&gt; -&gt; &amp;[Cell&lt;T&gt;]</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>Note: https://github.com/rust-lang/rfcs/pull/1651 has been accepted recently, so no <code>T: Copy</code> bound is needed anymore.</p>
</blockquote>
<h2 id="動機"><a class="header" href="#動機">動機</a></h2>
<p>Rust’s iterators offer a safe, fast way to iterate over collections while avoiding additional bound checks.</p>
<p>However, due to the borrow checker, they run into issues if we try to have more than one iterator into the same data structure while mutating elements in it.</p>
<p>Wanting to do this is not that unusual for many low level algorithms that deal with integers, floats or similar primitive data types.</p>
<p>For example, an algorithm might…</p>
<ul>
<li>For each element, access each other element.</li>
<li>For each element, access an element a number of elements before or after it.</li>
</ul>
<p>Todays answer for algorithms like that is to fall back to C-style for loops and indexing, which might look like this…</p>
<pre><code class="language-rust">
let v: Vec&lt;i32&gt; = ...;

// example 1
for i in 0..v.len() {
    for j in 0..v.len() {
        v[j] = f(v[i], v[j]);
    }
}

// example 2
for i in n..v.len() {
    v[i] = g(v[i - n]);
}
</code></pre>
<p>…but this reintroduces potential bound-checking costs.</p>
<p>The alternative, short of changing the actual algorithms involved, is to use internal mutability to enable safe mutations even with overlapping shared views into the data:</p>
<pre><code class="language-rust">let v: Vec&lt;Cell&lt;i32&gt;&gt; = ...;

// example 1
for i in &amp;v {
    for j in &amp;v {
        j.set(f(i.get(), j.get()));
    }
}

// example 2
for (i, j) in v[n..].iter().zip(&amp;v) {
    i.set(g(g.get()));
}
</code></pre>
<p>This has the advantages of allowing both bound-check free iteration and aliasing references, but comes with restrictions that makes it not generally applicable, namely:</p>
<ul>
<li>The need to change the definition of the data structure containing the data (Which is not always possible because it might come from external code).</li>
<li>Loss of the ability to directly hand out <code>&amp;T</code> and <code>&amp;mut T</code> references to the data.</li>
</ul>
<p>This RFC proposes a way to address these in cases where <code>Cell&lt;T&gt;</code> could be used by introducing simple conversions functions to the standard library that allow the creation of shared borrowed <code>Cell&lt;T&gt;</code>s from mutably borrowed <code>T</code>s.</p>
<p>This in turn allows the original data structure to remain unchanged, while allowing to temporary opt-in to the <code>Cell</code> API as needed. As an example, given <code>Cell::from_mut_slice(&amp;mut [T]) -&gt; &amp;[Cell&lt;T&gt;]</code>, the previous examples can be written as this:</p>
<pre><code class="language-rust">let mut v: Vec&lt;i32&gt; = ...;

// convert the mutable borrow
let v_slice: &amp;[Cell&lt;T&gt;] = Cell::from_mut_slice(&amp;mut v);

// example 1
for i in v_slice {
    for j in v_slice {
        j.set(f(i.get(), j.get()));
    }
}

// example 2
for (i, j) in v_slice[n..].iter().zip(v_slice) {
    i.set(g(g.get()));
}
</code></pre>
<h2 id="詳細設計"><a class="header" href="#詳細設計">詳細設計</a></h2>
<h3 id="language"><a class="header" href="#language">Language</a></h3>
<p>The core of this proposal is the ability to convert a <code>&amp;T</code> to a <code>&amp;Cell&lt;T&gt;</code>, so in order for it to be safe, <strong>it needs to be guaranteed that <code>T</code> and <code>Cell&lt;T&gt;</code> have the same memory layout</strong>, and that there are no codegen issues based on viewing a reference to a type that does not contain a <code>UnsafeCell</code> as a reference to a type that does contain a <code>UnsafeCell</code>.</p>
<p>As far as the author is aware, both should already implicitly fall out of the semantic of <code>Cell</code> and Rusts/llvms notion of aliasing:</p>
<ul>
<li><code>Cell</code> is safe interior mutability based on memcopying the <code>T</code>, and thus does not need additional fields or padding.</li>
<li><code>&amp;mut T -&gt; &amp;U</code> is a sub borrow, which prevents access to the original <code>&amp;mut T</code> for its duration, thus no aliasing.</li>
</ul>
<h3 id="std-library"><a class="header" href="#std-library">Std library</a></h3>
<h4 id="from_mut"><a class="header" href="#from_mut"><code>from_mut</code></a></h4>
<p>We add a constructor to the cell API that enables the <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> conversion, implemented with the equivalent of a <code>transmute()</code> of the two pointers:</p>
<pre><code class="language-rust">impl&lt;T&gt; Cell&lt;T&gt; {
    fn from_mut&lt;'a&gt;(t: &amp;'a mut T) -&gt; &amp;'a Cell&lt;T&gt; {
        unsafe {
            &amp;*(t as *mut T as *const Cell&lt;T&gt;)
        }
    }
}</code></pre>
<p>In the future this could also be provided through <code>AsRef</code>, <code>Into</code> or <code>From</code> impls.</p>
<h4 id="unsized-cellt"><a class="header" href="#unsized-cellt">Unsized <code>Cell&lt;T&gt;</code></a></h4>
<p>We extend <code>Cell&lt;T&gt;</code> to allow <code>T: ?Sized</code>, and move all compatible methods to a less restricted impl block:</p>
<pre><code class="language-rust">pub struct Cell&lt;T: ?Sized&gt; {
    value: UnsafeCell&lt;T&gt;,
}

impl&lt;T: ?Sized&gt; Cell&lt;T&gt; {
    pub fn as_ptr(&amp;self) -&gt; *mut T;
    pub fn get_mut(&amp;mut self) -&gt; &amp;mut T;
    pub fn from_mut(value: &amp;mut T) -&gt; &amp;Cell&lt;T&gt;;
}</code></pre>
<p>This is purely done to enable cell slicing below, and should otherwise have no effect on any existing code.</p>
<h4 id="cell-slicing"><a class="header" href="#cell-slicing">Cell Slicing</a></h4>
<p>We enable a conversion from <code>&amp;Cell&lt;[T]&gt;</code> to <code>&amp;[Cell&lt;T&gt;]</code>. This seems like it violates the “no interior references” API of <code>Cell</code> at first glance, but is actually safe:</p>
<ul>
<li>A slice represents a number of elements next to each other. Thus, if <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> is ok, then <code>&amp;mut [T] -&gt; &amp;[Cell&lt;T&gt;]</code> would be as well. <code>&amp;mut [T] -&gt; &amp;Cell&lt;[T]&gt;</code> follows from <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> through substitution, so <code>&amp;Cell&lt;[T]&gt; &lt;-&gt; &amp;[Cell&lt;T&gt;]</code> has to be valid.</li>
<li>The API of a <code>Cell&lt;T&gt;</code> is to allow internal mutability through single-threaded memcopies only. Since a memcopy is just a copy of all bits that make up a type, it does not matter if we logically do a memcopy to all elements of a slice through a <code>&amp;Cell&lt;[T]&gt;</code>, or just a memcopy to a single element through a <code>&amp;Cell&lt;T&gt;</code>.</li>
<li>Yet another way to look at it is that if we created a <code>&amp;mut T</code> to each element of a <code>&amp;mut [T]</code>, and converted each of them to a <code>&amp;Cell&lt;T&gt;</code>, their addresses would allow “stitching” them back together to a single <code>&amp;[Cell&lt;T&gt;]</code></li>
</ul>
<p>For convenience, we expose this conversion by implementing <code>Index</code> for <code>Cell&lt;[T]&gt;</code>:</p>
<pre><code class="language-rust">impl&lt;T&gt; Index&lt;RangeFull&gt; for Cell&lt;[T]&gt; {
    type Output = [Cell&lt;T&gt;];

    fn index(&amp;self, _: RangeFull) -&gt; &amp;[Cell&lt;T&gt;] {
        unsafe {
            &amp;*(self as *const Cell&lt;[T]&gt; as *const [Cell&lt;T&gt;])
        }
    }
}

impl&lt;T&gt; Index&lt;Range&lt;usize&gt;&gt; for Cell&lt;[T]&gt; {
    type Output = [Cell&lt;T&gt;];

    fn index(&amp;self, idx: Range&lt;usize&gt;) -&gt; &amp;[Cell&lt;T&gt;] {
        &amp;self[..][idx]
    }
}

impl&lt;T&gt; Index&lt;RangeFrom&lt;usize&gt;&gt; for Cell&lt;[T]&gt; {
    type Output = [Cell&lt;T&gt;];

    fn index(&amp;self, idx: RangeFrom&lt;usize&gt;) -&gt; &amp;[Cell&lt;T&gt;] {
        &amp;self[..][idx]
    }
}

impl&lt;T&gt; Index&lt;RangeTo&lt;usize&gt;&gt; for Cell&lt;[T]&gt; {
    type Output = [Cell&lt;T&gt;];

    fn index(&amp;self, idx: RangeTo&lt;usize&gt;) -&gt; &amp;[Cell&lt;T&gt;] {
        &amp;self[..][idx]
    }
}

impl&lt;T&gt; Index&lt;usize&gt; for Cell&lt;[T]&gt; {
    type Output = Cell&lt;T&gt;;

    fn index(&amp;self, idx: usize) -&gt; &amp;Cell&lt;T&gt; {
        &amp;self[..][idx]
    }
}</code></pre>
<p>Using this, the motivation example can be written as such:</p>
<pre><code class="language-rust">let mut v: Vec&lt;i32&gt; = ...;

// convert the mutable borrow
let v_slice: &amp;[Cell&lt;T&gt;] = &amp;Cell::from_mut(&amp;mut v[..])[..];

// example 1
for i in v_slice {
    for j in v_slice {
        j.set(f(i.get(), j.get()));
    }
}

// example 2
for (i, j) in v_slice[n..].iter().zip(v_slice) {
    i.set(g(g.get()));
}
</code></pre>
<h3 id="possible-extensions"><a class="header" href="#possible-extensions">Possible extensions</a></h3>
<p>The proposal only covers the base case <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> and the trivially implementable extension to <code>[T]</code>, but in theory this conversion could be enabled for many “higher level mutable reference” types, like for example mutable iterators (with the goal of making them cloneable through this).</p>
<p>See https://play.rust-lang.org/?gist=d012cebf462841887323185cff8ccbcc&amp;version=stable&amp;backtrace=0 for an example implementation and a more complex use case, and https://crates.io/crates/alias for an existing crate providing these features.</p>
<h2 id="how-we-teach-this"><a class="header" href="#how-we-teach-this">How We Teach This</a></h2>
<blockquote>
<p>What names and terminology work best for these concepts and why? How is this idea best presented—as a continuation of existing Rust patterns, or as a wholly new one?</p>
</blockquote>
<p>The API could be described as “temporarily opting-in to internal mutability”. It would be a more flexible continuation of the existing usage of <code>Cell&lt;T&gt;</code> since the <code>Cell&lt;T&gt;</code> no longer needs to exist in the original location if you have mutable access to it.</p>
<blockquote>
<p>Would the acceptance of this proposal change how Rust is taught to new users at any level? How should this feature be introduced and taught to existing Rust users?</p>
</blockquote>
<p>As it is, the API just provides a few neat conversion functions. Nevertheless, with the legalization of the <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> conversion there is the potential for a major change in how accessors to data structures are provided:</p>
<p>In todays Rust, there are generally three different ways:</p>
<ul>
<li>Owned access that starts off with a <code>T</code> and yield <code>U</code>.</li>
<li>Shared borrowed access that starts off with a <code>&amp;T</code> and yields <code>&amp;U</code>.</li>
<li>Mutable borrowed access that starts off with a <code>&amp;mut T</code> and yields <code>&amp;mut U</code>.</li>
</ul>
<p>With this change, it would be possible in many cases to add a fourth accessor:</p>
<ul>
<li>Shared borrowed cell access that starts off with a <code>&amp;mut T</code> and yields <code>&amp;Cell&lt;U&gt;</code>.</li>
</ul>
<p>For example, today there exist:</p>
<ul>
<li><code>Vec&lt;T&gt; -&gt; std::vec::IntoIter&lt;T&gt;</code>, which yields <code>T</code> values and is cloneable.</li>
<li><code>&amp;[T] -&gt; std::slice::Iter&lt;T&gt;</code>, which yields <code>&amp;T</code> values and is cloneable because it does a shared borrow.</li>
<li><code>&amp;mut [T] -&gt; std::slice::IterMut&lt;T&gt;</code>, which yields <code>&amp;mut T</code> values and is not cloneable because it does a mutable borrow.</li>
</ul>
<p>We could then add a fourth iterator like this:</p>
<ul>
<li><code>&amp;mut [T] -&gt; std::slice::CellIter&lt;T&gt;</code>, which yields <code>&amp;Cell&lt;T&gt;</code> values and is cloneable because it does a shared borrow.</li>
</ul>
<p>So there is the potential that we go away from teaching the “rule of three” of ownership and change it to a “rule of four”.</p>
<blockquote>
<p>What additions or changes to the Rust Reference, <em>The Rust Programming Language</em>, and/or <em>Rust by Example</em> does it entail?</p>
</blockquote>
<ul>
<li>The reference should explain that the <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> conversion, or specifically the <code>&amp;mut T -&gt; &amp;UnsafeCell&lt;T&gt;</code> conversion is fine.</li>
<li>The book could use the API introduced here if it talks about internal mutability, and use it as a “temporary opt-in” example.</li>
<li>Rust by Example could have a few basic examples of situations where this API is useful, eg the ones mention in the motivation section above.</li>
</ul>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<blockquote>
<p>Why should we <em>not</em> do this?</p>
</blockquote>
<ul>
<li>More complexity around the <code>Cell</code> API.</li>
<li><code>T</code> -&gt; <code>Cell&lt;T&gt;</code> transmute compatibility might not be a desired guarantee.</li>
</ul>
<h2 id="替代方案"><a class="header" href="#替代方案">替代方案</a></h2>
<h3 id="removing-cell-slicing"><a class="header" href="#removing-cell-slicing">Removing cell slicing</a></h3>
<p>Instead of allowing unsized types in <code>Cell</code> and adding the <code>Index</code> impls, there could just be a single <code>&amp;mut [T] -&gt; &amp;[Cell&lt;T&gt;]</code> conversions function:</p>
<pre><code class="language-rust">impl&lt;T&gt; Cell&lt;T&gt; {
    /// [...]

    fn from_mut_slice&lt;'a&gt;(t: &amp;'a mut [T]) -&gt; &amp;'a [Cell&lt;T&gt;] {
        unsafe {
            &amp;*(t as *mut [T] as *const [Cell&lt;T&gt;])
        }
    }
}</code></pre>
<p>Usage:</p>
<pre><code class="language-rust">let mut v: Vec&lt;i32&gt; = ...;

// convert the mutable borrow
let v_slice: &amp;[Cell&lt;T&gt;] = Cell::from_mut_slice(&amp;mut v);

// example 1
for i in v_slice {
    for j in v_slice {
        j.set(f(i.get(), j.get()));
    }
}

// example 2
for (i, j) in v_slice[n..].iter().zip(v_slice) {
    i.set(g(g.get()));
}</code></pre>
<p>This would be less modular than the <code>&amp;mut [T] -&gt; &amp;Cell&lt;[T]&gt; -&gt; &amp;[Cell&lt;T&gt;]</code> conversions steps, while still offering essentially the same API.</p>
<h3 id="just-the-language-guarantee"><a class="header" href="#just-the-language-guarantee">Just the language guarantee</a></h3>
<p>The conversion could be guaranteed as correct, but not be provided by std itself. This would serve as legitimization of external implementations like <a href="https://crates.io/crates/alias">alias</a>.</p>
<h3 id="no-guarantees"><a class="header" href="#no-guarantees">No guarantees</a></h3>
<p>If the safety guarantees of the conversion can not be granted, code would have to use direct indexing as today, with either possible bound checking costs or the use of unsafe code to avoid them.</p>
<h3 id="replacing-index-impls-with-deref"><a class="header" href="#replacing-index-impls-with-deref">Replacing <code>Index</code> impls with <code>Deref</code></a></h3>
<p>Instead of the <code>Index</code> impls, have only this <code>Deref</code> impl:</p>
<pre><code class="language-rust">impl&lt;T&gt; Deref for Cell&lt;[T]&gt; {
    type Target = [Cell&lt;T&gt;];

    fn deref(&amp;self) -&gt; &amp;[Cell&lt;T&gt;] {
        unsafe {
            &amp;*(self as *const Cell&lt;[T]&gt; as *const [Cell&lt;T&gt;])
        }
    }
}</code></pre>
<p>Pro:</p>
<ul>
<li>Automatic conversion due to deref coercions and auto deref.</li>
<li>Less redundancy since we don’t repeat the slicing impls of <code>[T]</code>.</li>
</ul>
<p>Cons:</p>
<ul>
<li><code>Cell&lt;[T]&gt; -&gt; [Cell&lt;T&gt;]</code> conversion does not seem like a good usecase for <code>Deref</code>, since <code>Cell&lt;[T]&gt;</code> isn’t a smartpointer.</li>
</ul>
<h3 id="cast-to-mut-cellt-instead-of-cellt"><a class="header" href="#cast-to-mut-cellt-instead-of-cellt">Cast to <code>&amp;mut Cell&lt;T&gt;</code> instead of <code>&amp;Cell&lt;T&gt;</code></a></h3>
<p>Nothing that makes the <code>&amp;mut T -&gt; &amp;Cell&lt;T&gt;</code> conversion safe would prevent <code>&amp;mut T -&gt; &amp;mut Cell&lt;T&gt;</code> from being safe either, and the latter can be trivially turned into a <code>&amp;Cell&lt;T&gt;</code> while also allowing mutable access - eg to call <code>Cell::as_mut()</code> to conversion back again.</p>
<p>Similar to that, there could also be a way to turn a <code>&amp;mut [Cell&lt;T&gt;]</code> back into a <code>&amp;mut [T]</code>.</p>
<p>However, this does not seem to be actually useful since the only reason to use this API is to make use of shared internal mutability.</p>
<h3 id="exposing-the-functions-differently"><a class="header" href="#exposing-the-functions-differently">Exposing the functions differently</a></h3>
<p>Instead of <code>Cell</code> constructors, we could just have freestanding functions in, say, <code>std::cell</code>:</p>
<pre><code class="language-rust">fn ref_as_cell&lt;T&gt;(t: &amp;mut T) -&gt; &amp;Cell&lt;T&gt; {
    unsafe {
        &amp;*(t as *mut T as *const Cell&lt;T&gt;)
    }
}

fn cell_slice&lt;T&gt;(t: &amp;Cell&lt;[T]&gt;) -&gt; &amp;[Cell&lt;T&gt;] {
    unsafe {
        &amp;*(t as *const Cell&lt;[T]&gt; as *const [Cell&lt;T&gt;])
    }
}</code></pre>
<p>On the opposite spectrum, and should this feature end up being used somewhat commonly, we could provide the conversions by dedicated traits, possibly in the prelude, or use the std coherence hack to implement them directly on <code>&amp;mut T</code> and <code>&amp;mut [T]</code>:</p>
<pre><code class="language-rust">trait AsCell {
    type Cell;
    fn as_cell(self) -&gt; Self::Cell;
}

impl&lt;'a, T&gt; AsCell for &amp;'a mut T {
    type Cell = &amp;'a Cell&lt;T&gt;;
    fn as_cell(self) -&gt; Self::Cell {
        unsafe {
            &amp;*(self as *mut T as *const Cell&lt;T&gt;)
        }
    }
}</code></pre>
<p>But given the issues of adding methods to pointer-like types, this approach in general would probably be not a good idea (See the situation with <code>Rc</code> and <code>Arc</code>).</p>
<h2 id="未解決的問題"><a class="header" href="#未解決的問題">未解決的問題</a></h2>
<p>None so far.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="1774-roadmap-2017.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="1824-crates.io-default-ranking.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="1774-roadmap-2017.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="1824-crates.io-default-ranking.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
