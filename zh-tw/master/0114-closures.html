<!DOCTYPE HTML>
<html lang="zh_TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0114-closures - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-c5bb60c5.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2014-07-29</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/114">rust-lang/rfcs#114</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/16095">rust-lang/rust#16095</a></li>
</ul>
<h2 id="摘要"><a class="header" href="#摘要">摘要</a></h2>
<ul>
<li>Convert function call <code>a(b, ..., z)</code> into an overloadable operator via the traits <code>Fn&lt;A,R&gt;</code>, <code>FnShare&lt;A,R&gt;</code>, and <code>FnOnce&lt;A,R&gt;</code>, where <code>A</code> is a tuple <code>(B, ..., Z)</code> of the types <code>B...Z</code> of the arguments <code>b...z</code>, and <code>R</code> is the return type. The three traits differ in their self argument (<code>&amp;mut self</code> vs <code>&amp;self</code> vs <code>self</code>).</li>
<li>Remove the <code>proc</code> expression form and type.</li>
<li>Remove the closure types (though the form lives on as syntactic sugar, see below).</li>
<li>Modify closure expressions to permit specifying by-reference vs by-value capture and the receiver type:
<ul>
<li>Specifying by-reference vs by-value closures:
<ul>
<li><code>ref |...| expr</code> indicates a closure that captures upvars from the environment by reference. This is what closures do today and the behavior will remain unchanged, other than requiring an explicit keyword.</li>
<li><code>|...| expr</code> will therefore indicate a closure that captures upvars from the environment by value. As usual, this is either a copy or move depending on whether the type of the upvar implements <code>Copy</code>.</li>
</ul>
</li>
<li>Specifying receiver mode (orthogonal to capture mode above):
<ul>
<li><code>|a, b, c| expr</code> is equivalent to <code>|&amp;mut: a, b, c| expr</code></li>
<li><code>|&amp;mut: ...| expr</code> indicates that the closure implements <code>Fn</code></li>
<li><code>|&amp;: ...| expr</code> indicates that the closure implements <code>FnShare</code></li>
<li><code>|: a, b, c| expr</code> indicates that the closure implements <code>FnOnce</code>.</li>
</ul>
</li>
</ul>
</li>
<li>Add syntactic sugar where <code>|T1, T2| -&gt; R1</code> is translated to a reference to one of the fn traits as follows:
<ul>
<li><code>|T1, ..., Tn| -&gt; R</code> is translated to <code>Fn&lt;(T1, ..., Tn), R&gt;</code></li>
<li><code>|&amp;mut: T1, ..., Tn| -&gt; R</code> is translated to <code>Fn&lt;(T1, ..., Tn), R&gt;</code></li>
<li><code>|&amp;: T1, ..., Tn| -&gt; R</code> is translated to <code>FnShare&lt;(T1, ..., Tn), R&gt;</code></li>
<li><code>|: T1, ..., Tn| -&gt; R</code> is translated to <code>FnOnce&lt;(T1, ..., Tn), R&gt;</code></li>
</ul>
</li>
</ul>
<p>One aspect of closures that this RFC does <em>not</em> describe is that we must permit trait references to be universally quantified over regions as closures are today. A description of this change is described below under <em>Unresolved questions</em> and the details will come in a forthcoming RFC.</p>
<h2 id="動機"><a class="header" href="#動機">動機</a></h2>
<p>Over time we have observed a very large number of possible use cases for closures. The goal of this RFC is to create a unified closure model that encompasses all of these use cases.</p>
<p>Specific goals (explained in more detail below):</p>
<ol>
<li>Give control over inlining to users.</li>
<li>Support closures that bind by reference and closures that bind by value.</li>
<li>Support different means of accessing the closure environment, corresponding to <code>self</code>, <code>&amp;self</code>, and <code>&amp;mut self</code> methods.</li>
</ol>
<p>As a side benefit, though not a direct goal, the RFC reduces the size/complexity of the language’s core type system by unifying closures and traits.</p>
<h3 id="the-core-idea-unifying-closures-and-traits"><a class="header" href="#the-core-idea-unifying-closures-and-traits">The core idea: unifying closures and traits</a></h3>
<p>The core idea of the RFC is to unify closures, procs, and traits. There are a number of reasons to do this. First, it simplifies the language, because closures, procs, and traits already served similar roles and there was sometimes a lack of clarity about which would be the appropriate choice. However, in addition, the unification offers increased expressiveness and power, because traits are a more generic model that gives users more control over optimization.</p>
<p>The basic idea is that function calls become an overridable operator. Therefore, an expression like <code>a(...)</code> will be desugar into an invocation of one of the following traits:</p>
<pre><code>trait Fn&lt;A,R&gt; {
    fn call(&amp;mut self, args: A) -&gt; R;
}

trait FnShare&lt;A,R&gt; {
    fn call_share(&amp;self, args: A) -&gt; R;
}

trait FnOnce&lt;A,R&gt; {
    fn call_once(self, args: A) -&gt; R;
}
</code></pre>
<p>Essentially, <code>a(b, c, d)</code> becomes sugar for one of the following:</p>
<pre><code>Fn::call(&amp;mut a, (b, c, d))
FnShare::call_share(&amp;a, (b, c, d))
FnOnce::call_once(a, (b, c, d))
</code></pre>
<p>To integrate with this, closure expressions are then translated into a fresh struct that implements one of those three traits. The precise trait is currently indicated using explicit syntax but may eventually be inferred.</p>
<p>This change gives user control over virtual vs static dispatch.  This works in the same way as generic types today:</p>
<pre><code>fn foo(x: &amp;mut Fn&lt;(int,),int&gt;) -&gt; int {
    x(2) // virtual dispatch
}

fn foo&lt;F:Fn&lt;(int,),int&gt;&gt;(x: &amp;mut F) -&gt; int {
    x(2) // static dispatch
}
</code></pre>
<p>The change also permits returning closures, which is not currently possible (the example relies on the proposed <code>impl</code> syntax from rust-lang/rfcs#105):</p>
<pre><code>fn foo(x: impl Fn&lt;(int,),int&gt;) -&gt; impl Fn&lt;(int,),int&gt; {
    |v| x(v * 2)
}
</code></pre>
<p>Basically, in this design there is nothing special about a closure. Closure expressions are simply a convenient way to generate a struct that implements a suitable <code>Fn</code> trait.</p>
<h3 id="bind-by-reference-vs-bind-by-value"><a class="header" href="#bind-by-reference-vs-bind-by-value">Bind by reference vs bind by value</a></h3>
<p>When creating a closure, it is now possible to specify whether the closure should capture variables from its environment (“upvars”) by reference or by value. The distinction is indicated using the leading keyword <code>ref</code>:</p>
<pre><code>|| foo(a, b)      // captures `a` and `b` by value

ref || foo(a, b)  // captures `a` and `b` by reference, as today
</code></pre>
<h4 id="reasons-to-bind-by-value"><a class="header" href="#reasons-to-bind-by-value">Reasons to bind by value</a></h4>
<p>Bind by value is useful when creating closures that will escape from the stack frame that created them, such as task bodies (<code>spawn(|| ...)</code>) or combinators. It is also useful for moving values out of a closure, though it should be possible to enable that with bind by reference as well in the future.</p>
<h4 id="reasons-to-bind-by-reference"><a class="header" href="#reasons-to-bind-by-reference">Reasons to bind by reference</a></h4>
<p>Bind by reference is useful for any case where the closure is known not to escape the creating stack frame. This frequently occurs when using closures to encapsulate common control-flow patterns:</p>
<pre><code>map.insert_or_update_with(key, value, || ...)
opt_val.unwrap_or_else(|| ...)
</code></pre>
<p>In such cases, the closure frequently wishes to read or modify local variables on the enclosing stack frame. Generally speaking, then, such closures should capture variables by-reference – that is, they should store a reference to the variable in the creating stack frame, rather than copying the value out. Using a reference allows the closure to mutate the variables in place and also avoids moving values that are simply read temporarily.</p>
<p>The vast majority of closures in use today are should be “by reference” closures. The only exceptions are those closures that wish to “move out” from an upvar (where we commonly use the so-called “option dance” today). In fact, even those closures could be “by reference” closures, but we will have to extend the inference to selectively identify those variables that must be moved and take those “by value”.</p>
<h2 id="詳細設計"><a class="header" href="#詳細設計">詳細設計</a></h2>
<h3 id="closure-expression-syntax"><a class="header" href="#closure-expression-syntax">Closure expression syntax</a></h3>
<p>Closure expressions will have the following form (using EBNF notation, where <code>[]</code> denotes optional things and <code>{}</code> denotes a comma-separated list):</p>
<pre><code>CLOSURE = ['ref'] '|' [SELF] {ARG} '|' ['-&gt;' TYPE] EXPR
SELF    =  ':' | '&amp;' ':' | '&amp;' 'mut' ':'
ARG     = ID [ ':' TYPE ]
</code></pre>
<p>The optional keyword <code>ref</code> is used to indicate whether this closure captures <em>by reference</em> or <em>by value</em>.</p>
<p>Closures are always translated into a fresh struct type with one field per upvar. In a by-value closure, the types of these fields will be the same as the types of the corresponding upvars (modulo <code>&amp;mut</code> reborrows, see below). In a by-reference closure, the types of these fields will be a suitable reference (<code>&amp;</code>, <code>&amp;mut</code>, etc) to the variables being borrowed.</p>
<h4 id="by-value-closures"><a class="header" href="#by-value-closures">By-value closures</a></h4>
<p>The default form for a closure is by-value. This implies that all upvars which are referenced are copied/moved into the closure as appropriate. There is one special case: if the type of the value to be moved is <code>&amp;mut</code>, we will “reborrow” the value when it is copied into the closure. That is, given an upvar <code>x</code> of type <code>&amp;'a mut T</code>, the value which is actually captured will have type <code>&amp;'b mut T</code> where <code>'b &lt;= 'a</code>. This rule is consistent with our general treatment of <code>&amp;mut</code>, which is to aggressively reborrow wherever possible; moreover, this rule cannot introduce additional compilation errors, it can only make more programs successfully typecheck.</p>
<h4 id="by-reference-closures"><a class="header" href="#by-reference-closures">By-reference closures</a></h4>
<p>A <em>by-reference</em> closure is a convenience form in which values used in the closure are converted into references before being captured. By-reference closures are always rewritable into by-value closures if desired, but the rewrite can often be cumbersome and annoying.</p>
<p>Here is a (rather artificial) example of a by-reference closure in use:</p>
<pre><code>let in_vec: Vec&lt;int&gt; = ...;
let mut out_vec: Vec&lt;int&gt; = Vec::new();
let opt_int: Option&lt;int&gt; = ...;

opt_int.map(ref |v| {
    out_vec.push(v);
    in_vec.fold(v, |a, &amp;b| a + b)
});
</code></pre>
<p>This could be rewritten into a by-value closure as follows:</p>
<pre><code>let in_vec: Vec&lt;int&gt; = ...;
let mut out_vec: Vec&lt;int&gt; = Vec::new();
let opt_int: Option&lt;int&gt; = ...;

opt_int.map({
    let in_vec = &amp;in_vec;
    let out_vec = &amp;mut in_vec;
    |v| {
        out_vec.push(v);
        in_vec.fold(v, |a, &amp;b| a + b)
    }
})
</code></pre>
<p>In this case, the capture closed over two variables, <code>in_vec</code> and <code>out_vec</code>. As you can see, the compiler automatically infers, for each variable, how it should be borrowed and inserts the appropriate capture.</p>
<p>In the body of a <code>ref</code> closure, the upvars continue to have the same type as they did in the outer environment. For example, the type of a reference to <code>in_vec</code> in the above example is always <code>Vec&lt;int&gt;</code>, whether or not it appears as part of a <code>ref</code> closure. This is not only convenient, it is required to make it possible to infer whether each variable is borrowed as an <code>&amp;T</code> or <code>&amp;mut T</code> borrow.</p>
<p>Note that there are some cases where the compiler internally employs a form of borrow that is not available in the core language, <code>&amp;uniq</code>. This borrow does not permit aliasing (like <code>&amp;mut</code>) but does not require mutability (like <code>&amp;</code>). This is required to allow transparent closing over of <code>&amp;mut</code> pointers as <a href="http://smallcultfollowing.com/babysteps/blog/2014/05/13/focusing-on-ownership/">described in this blog post</a>.</p>
<p><strong>Evolutionary note:</strong> It is possible to evolve by-reference closures in the future in a backwards compatible way. The goal would be to cause more programs to type-check by default. Two possible extensions follow:</p>
<ul>
<li>Detect when values are <em>moved</em> and hence should be taken by value rather than by reference. (This is only applicable to once closures.)</li>
<li>Detect when it is only necessary to borrow a sub-path. Imagine a closure like <code>ref || use(&amp;context.variable_map)</code>. Currently, this closure will borrow <code>context</code>, even though it only <em>uses</em> the field <code>variable_map</code>. As a result, it is sometimes necessary to rewrite the closure to have the form <code>{let v = &amp;context.variable_map; || use(v)}</code>.  In the future, however, we could extend the inference so that rather than borrowing <code>context</code> to create the closure, we would borrow <code>context.variable_map</code> directly.</li>
</ul>
<h3 id="closure-sugar-in-trait-references"><a class="header" href="#closure-sugar-in-trait-references">Closure sugar in trait references</a></h3>
<p>The current type for closures, <code>|T1, T2| -&gt; R</code>, will be repurposed as syntactic sugar for a reference to the appropriate <code>Fn</code> trait. This shorthand be used any place that a trait reference is appropriate. The full type will be written as one of the following:</p>
<pre><code>&lt;'a...'z&gt; |T1...Tn|: K -&gt; R
&lt;'a...'z&gt; |&amp;mut: T1...Tn|: K -&gt; R
&lt;'a...'z&gt; |&amp;: T1...Tn|: K -&gt; R
&lt;'a...'z&gt; |: T1...Tn|: K -&gt; R
</code></pre>
<p>Each of which would then be translated into the following trait references, respectively:</p>
<pre><code>&lt;'a...'z&gt; Fn&lt;(T1...Tn), R&gt; + K
&lt;'a...'z&gt; Fn&lt;(T1...Tn), R&gt; + K
&lt;'a...'z&gt; FnShare&lt;(T1...Tn), R&gt; + K
&lt;'a...'z&gt; FnOnce&lt;(T1...Tn), R&gt; + K
</code></pre>
<p>Note that the bound lifetimes <code>'a...'z</code> are not in scope for the bound <code>K</code>.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p>This model is more complex than the existing model in some respects (but the existing model does not serve the full set of desired use cases).</p>
<h2 id="替代方案"><a class="header" href="#替代方案">替代方案</a></h2>
<p>There is one aspect of the design that is still under active discussion:</p>
<p><strong>Introduce a more generic sugar.</strong> It was proposed that we could introduce <code>Trait(A, B) -&gt; C</code> as syntactic sugar for <code>Trait&lt;(A,B),C&gt;</code> rather than retaining the form <code>|A,B| -&gt; C</code>. This is appealing but removes the correspondence between the expression form and the corresponding type. One (somewhat open) question is whether there will be additional traits that mirror fn types that might benefit from this more general sugar.</p>
<p><strong>Tweak trait names.</strong> In conjunction with the above, there is some concern that the type name <code>fn(A) -&gt; B</code> for a bare function with no environment is too similar to <code>Fn(A) -&gt; B</code> for a closure.  To remedy that, we could change the name of the trait to something like <code>Closure(A) -&gt; B</code> (naturally the other traits would be renamed to match).</p>
<p>Then there are a large number of permutations and options that were largely rejected:</p>
<p><strong>Only offer by-value closures.</strong> We tried this and found it required a lot of painful rewrites of perfectly reasonable code.</p>
<p><strong>Make by-reference closures the default.</strong> We felt this was inconsistent with the language as a whole, which tends to make “by value” the default (e.g., <code>x</code> vs <code>ref x</code> in patterns, <code>x</code> vs <code>&amp;x</code> in expressions, etc.).</p>
<p><strong>Use a capture clause syntax that borrows individual variables.</strong> “By value” closures combined with <code>let</code> statements already serve this role. Simply specifying “by-reference closure” also gives us room to continue improving inference in the future in a backwards compatible way. Moreover, the syntactic space around closures expressions is extremely constrained and we were unable to find a satisfactory syntax, particularly when combined with self-type annotations. Finally, if we decide we <em>do</em> want the ability to have “mostly by-value” closures, we can easily extend the current syntax by writing something like <code>(ref x, ref mut y) || ...</code> etc.</p>
<p><strong>Retain the proc expression form.</strong> It was proposed that we could retain the <code>proc</code> expression form to specify a by-value closure and have <code>||</code> expressions be by-reference. Frankly, the main objection to this is that nobody likes the <code>proc</code> keyword.</p>
<p><strong>Use variadic generics in place of tuple arguments.</strong> While variadic generics are an interesting addition in their own right, we’d prefer not to introduce a dependency between closures and variadic generics. Having all arguments be placed into a tuple is also a simpler model overall. Moreover, native ABIs on platforms of interest treat a structure passed by value identically to distinct arguments. Finally, given that trait calls have the “Rust” ABI, which is not specified, we can always tweak the rules if necessary (though there are advantages for tooling when the Rust ABI closely matches the native ABI).</p>
<p><strong>Use inference to determine the self type of a closure rather than an annotation.</strong> We retain this option for future expansion, but it is not clear whether we can always infer the self type of a closure. Moreover, using inference rather a default raises the question of what to do for a type like <code>|int| -&gt; uint</code>, where inference is not possible.</p>
<p><strong>Default to something other than <code>&amp;mut self</code>.</strong> It is our belief that this is the most common use case for closures.</p>
<h2 id="transition-plan"><a class="header" href="#transition-plan">Transition plan</a></h2>
<p>TBD. pcwalton is working furiously as we speak.</p>
<h2 id="未解決的問題"><a class="header" href="#未解決的問題">未解決的問題</a></h2>
<p><strong>What relationship should there be between the closure traits?</strong> On the one hand, there is clearly a relationship between the traits.  For example, given a <code>FnShare</code>, one can easily implement <code>Fn</code>:</p>
<pre><code>impl&lt;A,R,T:FnShare&lt;A,R&gt;&gt; Fn&lt;A,R&gt; for T {
    fn call(&amp;mut self, args: A) -&gt; R {
        (&amp;*self).call_share(args)
    }
}
</code></pre>
<p>Similarly, given a <code>Fn</code> or <code>FnShare</code>, you can implement <code>FnOnce</code>. From this, one might derive a subtrait relationship:</p>
<pre><code>trait FnOnce { ... }
trait Fn : FnOnce { ... }
trait FnShare : Fn { ... }
</code></pre>
<p>Employing this relationship, however, would require that any manual implement of <code>FnShare</code> or <code>Fn</code> must implement adapters for the other two traits, since a subtrait cannot provide a specialized default of supertrait methods (yet?). On the other hand, having no relationship between the traits limits reuse, at least without employing explicit adapters.</p>
<p>Other alternatives that have been proposed to address the problem:</p>
<ul>
<li>
<p>Use impls to implement the fn traits in terms of one another, similar to what is shown above. The problem is that we would need to implement <code>FnOnce</code> both for all <code>T</code> where <code>T:Fn</code> and for all <code>T</code> where <code>T:FnShare</code>. This will yield coherence errors unless we extend the language with a means to declare traits as mutually exclusive (which might be valuable, but no such system has currently been proposed nor agreed upon).</p>
</li>
<li>
<p>Have the compiler implement multiple traits for a single closure. As with supertraits, this would require manual implements to implement multiple traits. It would also require generic users to write <code>T:Fn+FnMut</code> or else employ an explicit adapter. On the other hand, it preserves the “one method per trait” rule described below.</p>
</li>
</ul>
<p><strong>Can we optimize away the trait vtable?</strong> The runtime representation of a reference <code>&amp;Trait</code> to a trait object (and hence, under this proposal, closures as well) is a pair of pointers <code>(data, vtable)</code>. It has been proposed that we might be able to optimize this representation to <code>(data, fnptr)</code> so long as <code>Trait</code> has a single function. This slightly improves the performance of invoking the function as one need not indirect through the vtable. The actual implications of this on performance are unclear, but it might be a reason to keep the closure traits to a single method.</p>
<h3 id="closures-that-are-quantified-over-lifetimes"><a class="header" href="#closures-that-are-quantified-over-lifetimes">Closures that are quantified over lifetimes</a></h3>
<p>A separate RFC is needed to describe bound lifetimes in trait references. For example, today one can write a type like <code>&lt;'a&gt; |&amp;'a A| -&gt; &amp;'a B</code>, which indicates a closure that takes and returns a reference with the same lifetime specified by the caller at each call-site. Note that a trait reference like <code>Fn&lt;(&amp;'a A), &amp;'a B&gt;</code>, while syntactically similar, does <em>not</em> have the same meaning because it lacks the universal quantifier <code>&lt;'a&gt;</code>. Therefore, in the second case, <code>'a</code> refers to some specific lifetime <code>'a</code>, rather than being a lifetime parameter that is specified at each callsite. The high-level summary of the change therefore is to permit trait references like <code>&lt;'a&gt; Fn&lt;(&amp;'a A), &amp;'a B&gt;</code>; in this case, the value of <code>&lt;'a&gt;</code> will be specified each time a method or other member of the trait is accessed.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0112-remove-cross-borrowing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="0115-rm-integer-fallback.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0112-remove-cross-borrowing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="0115-rm-integer-fallback.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
