<!DOCTYPE HTML>
<html lang="zh_TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>3662-mergeable-rustdoc-cross-crate-info - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-c5bb60c5.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2024-06-18</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/3662">rust-lang/rfcs#3662</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/130676">rust-lang/rust#130676</a></li>
</ul>
<h2 id="摘要"><a class="header" href="#摘要">摘要</a></h2>
<p>This RFC discusses mergeable cross-crate information in rustdoc. It facilitates the generation of documentation indexes in workspaces with many crates by allowing each crate to write to an independent output directory. The final documentation is rendered by combining these independent directories with a lightweight merge step. When provided with <code>--parts-out-dir</code>, this proposal writes a <code>doc.parts</code> directory to hold pre-merge cross-crate information. Currently, rustdoc requires global mutable access to a single output directory to generate cross-crate information, which is an obstacle to integrating rustdoc in build systems that enforce the independence of build actions.</p>
<h2 id="動機"><a class="header" href="#動機">動機</a></h2>
<p>The main goal of this proposal is to facilitate users producing a documentation bundle of every crate in a large environment. When a crate needs to be re-documented, only a relatively lightweight merge step will be needed to produce an updated documentation bundle. This proposal is to facilitate the creation and updating of these bundles.</p>
<p>This proposal also targets documenting individual crates and their dependencies in non-cargo build systems. As will be explained, doc targets in non-cargo build systems often do not support cross-crate information.</p>
<p>There are some files in the rustdoc output directory that are read and overwritten during every invocation of rustdoc. This proposal refers to these files as <strong>cross-crate information</strong>, or <strong>CCI</strong>, as in <a href="https://rustc-dev-guide.rust-lang.org/rustdoc.html#multiple-runs-same-output-directory">https://rustc-dev-guide.rust-lang.org/rustdoc.html#multiple-runs-same-output-directory</a>.</p>
<p>Build systems may run build actions in a distributed environment across separate logical filesystems. It might also be desirable to run rustdoc in a lock-free parallel mode, where every rustdoc process writes to a disjoint set of files.</p>
<p>Cross-crate information is supported in Cargo. It calls rustdoc with a single <code>--out-dir</code>, which requires global read-write access to the doc root (e.g. <code>target/doc</code>). There are significant scalability issues with this approach. Global mutable access to the files that encode this cross-crate information has implications for caching, reproducible builds, and content hashing. By adding an option to avoid this mutation, rustdoc will serve as a first-class citizen in non-cargo build systems.</p>
<p>These considerations motivate adding an option for outputting partial CCI (parts), which are merged (linked) with a later step.</p>
<p>This RFC has the goal of enabling the future deprecation of the default (called <code>--merge=shared</code> here) practice of appending to cross-crate information files in the doc root.</p>
<h2 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h2>
<h3 id="new-flag-summary"><a class="header" href="#new-flag-summary">New flag summary</a></h3>
<p>More details are in the Reference-level explanation.</p>
<ul>
<li><code>--merge=none</code>: Do not write cross-crate information to the <code>--out-dir</code>. The flag <code>--parts-out-dir</code> may instead be provided with the destination of the current crate’s cross-crate information parts.</li>
<li><code>--parts-out-dir=path/to/doc.parts/&lt;crate-name&gt;</code>: Write cross-crate linking information to the given directory (only usable with the <code>--merge=none</code> mode). This information allows linking the current crate’s documentation with other documentation at a later rustdoc invocation.</li>
<li><code>--include-parts-dir=path/to/doc.parts/&lt;crate-name&gt;</code>: Include cross-crate information from this previously written <code>doc.parts</code> directories into a collection that will be written by the current invocation of rustdoc. May only be provided with <code>--merge=finalize</code>. May be provided any number of times.</li>
<li><code>--merge=shared</code> (default): Append information from the current crate to any info files found in the <code>--out-dir</code>.</li>
<li><code>--merge=finalize</code>: Write cross-crate information from the current crate and any crates included via <code>--include-parts-dir</code> to the <code>--out-dir</code>, overwriting conflicting files. This flag may be used with or without an input crate root, in which case it only links crates included via <code>--include-parts-dir</code>.</li>
</ul>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<p>In this example, there is a crate <code>trait-crate</code> which defines a trait <code>Trait</code>, and a crate <code>struct-crate</code> which defines a struct <code>Struct</code> that implements <code>Trait</code>. Our goal in this demo is for <code>Struct</code> to appear as an implementer in <code>Trait</code>’s docs, even if <code>struct-crate</code> and <code>trait-crate</code> are documented independently.</p>
<pre><code class="language-shell">mkdir -p trait-crate/src struct-crate/src merged/doc
echo "pub trait Trait {}" &gt; trait-crate/src/lib.rs
echo "pub struct Struct; impl trait-crate::Trait for Struct {}" &gt; struct-crate/src/lib.rs
MERGED=file://$(realpath merged/doc)
</code></pre>
<p>Compile <code>trait-crate</code>, so that <code>struct-crate</code> can depend on its <code>.rmeta</code> file.</p>
<pre><code class="language-shell">rustc \
    --crate-name=trait-crate \
    --crate-type=lib \
    --edition=2021 \
    --emit=metadata \
    --out-dir=trait-crate/target \
    trait-crate/src/lib.rs
</code></pre>
<p>Document <code>struct-crate</code> and <code>trait-crate</code> independently, providing <code>--merge=none</code>, and <code>--parts-out-dir</code>.</p>
<pre><code class="language-shell">rustdoc \
    --crate-name=trait-crate \
    --crate-type=lib \
    --edition=2021 \
    --out-dir=trait-crate/target/doc \
    --extern-html-root-url trait-crate=$MERGED \
    --merge=none \
    --parts-out-dir=trait-crate/target/doc.parts/trait-crate \
    trait-crate/src/lib.rs
rustdoc \
    --crate-name=struct-crate \
    --crate-type=lib \
    --edition=2021 \
    --out-dir=struct-crate/target/doc \
    --extern-html-root-url struct-crate=$MERGED \
    --extern-html-root-url trait-crate=$MERGED \
    --merge=none \
    --parts-out-dir=struct-crate/target/doc.parts/struct-crate \
    --extern trait-crate=trait-crate/target/libt.rmeta \
    struct-crate/src/lib.rs
</code></pre>
<p>Link everything with a final invocation of rustdoc. We will provide <code>--merge=finalize</code>, and <code>--include-parts-dir</code>. See the Reference-level explanation about these flags. Notice that this invocation is given no source input file.</p>
<pre><code class="language-shell">rustdoc \
    --enable-index-page \
    --include-parts-dir=trait-crate/target/doc.parts/trait-crate \
    --include-parts-dir=struct-crate/target/doc.parts/struct-crate \
    --out-dir=merged/doc \
    --merge=finalize
</code></pre>
<p>Copy the docs from the given <code>--out-dir</code>s to a central location.</p>
<pre><code class="language-shell">cp -r struct-crate/target/doc/* trait-crate/target/doc/* merged/doc
</code></pre>
<p>Browse <code>merged/doc/index.html</code> with cross-crate information.</p>
<p>In general, instead of two crates in the environment (<code>struct-crate</code> and <code>trait-crate</code>) a user could have thousands. Upon any changes, only the crates that change have to be re-documented.</p>
<details>
<summary>Click here for a directory listing after running the example above.</summary>
<pre>
$ tree . -a
.
├── merged
│   └── doc
│       ├── crates.js
│       ├── help.html
│       ├── index.html
│       ├── struct-crate
│       │   ├── all.html
│       │   ├── index.html
│       │   ├── sidebar-items.js
│       │   └── struct.Struct.html
│       ├── search.desc
│       │   ├── struct-crate
│       │   │   └── struct-crate-desc-0-.js
│       │   └── trait-crate
│       │       └── trait-crate-desc-0-.js
│       ├── search-index.js
│       ├── settings.html
│       ├── src
│       │   ├── struct-crate
│       │   │   └── lib.rs.html
│       │   └── trait-crate
│       │       └── lib.rs.html
│       ├── src-files.js
│       ├── static.files
│           │   ├── COPYRIGHT-23e9bde6c69aea69.txt
│           │   ├── favicon-2c020d218678b618.svg
│           │   └── &lt;rest of the contents excluded&gt;
│       ├── trait-crate
│       │   ├── all.html
│       │   ├── index.html
│       │   ├── sidebar-items.js
│       │   └── trait.Trait.html
│       └── trait.impl
│           ├── core
│           │   ├── marker
│           │   │   ├── trait.Freeze.js
│           │   │   ├── trait.Send.js
│           │   │   ├── trait.Sync.js
│           │   │   └── trait.Unpin.js
│           │   └── panic
│           │       └── unwind_safe
│           │           ├── trait.RefUnwindSafe.js
│           │           └── trait.UnwindSafe.js
│           └── trait-crate
│               └── trait.Trait.js
├── struct-crate
│   ├── src
│   │   └── lib.rs
│   └── target
│       ├── doc
│       │   ├── help.html
│       │   ├── .lock
│       │   ├── struct-crate
│       │   │   ├── all.html
│       │   │   ├── index.html
│       │   │   ├── sidebar-items.js
│       │   │   └── struct.Struct.html
│       │   ├── search.desc
│       │   │   └── struct-crate
│       │   │       └── struct-crate-desc-0-.js
│       │   ├── settings.html
│       │   └── src
│       │       └── struct-crate
│       │           └── lib.rs.html
│       ├── doc.parts
│       │   └── struct-crate
│       │       └── crate-info
│       └── libs.rmeta
└── trait-crate
    ├── src
    │   └── lib.rs
    └── target
        ├── doc
        │   ├── help.html
        │   ├── .lock
        │   ├── search.desc
        │   │   └── trait-crate
        │   │       └── trait-crate-desc-0-.js
        │   ├── settings.html
        │   ├── src
        │   │   └── trait-crate
        │   │       └── lib.rs.html
        │   └── trait-crate
        │       ├── all.html
        │       ├── index.html
        │       ├── sidebar-items.js
        │       └── trait.Trait.html
        ├── doc.parts
        │   └── trait-crate
        │       └── crate-info
        └── libt.rmeta
</pre>

</details>
<h3 id="suggested-workflows"><a class="header" href="#suggested-workflows">Suggested workflows</a></h3>
<p>With this proposal, there are three modes of invoking rustdoc: <code>--merge=shared</code>, <code>--merge=none</code>, and <code>--merge=finalize</code>.</p>
<h4 id="default-workflow-mutate-shared-directory---mergeshared"><a class="header" href="#default-workflow-mutate-shared-directory---mergeshared">Default workflow: mutate shared directory: <code>--merge=shared</code></a></h4>
<p>In this workflow, we document a single crate, or a collection of crates into a shared output directory that is continuously updated. Files in this output directory are modified by multiple rustdoc invocations. Use <code>--merge=shared</code>, and specify the same <code>--out-dir</code> to every invocation of rustdoc. <code>--merge=shared</code> will be the default value if <code>--merge</code> is not provided. This is the workflow that Cargo uses, and only mode of invoking rustdoc before this RFC. This RFC is intended to enable the future deprecation of this mode.</p>
<h4 id="document-crates-delaying-generation-of-cross-crate-information---mergenone"><a class="header" href="#document-crates-delaying-generation-of-cross-crate-information---mergenone">Document crates, delaying generation of cross-crate information: <code>--merge=none</code></a></h4>
<p>Document crates using a dedicated HTML output directory and a dedicated “parts” output directory. No cross-crate data nor rendered HTML output is included from other crates.</p>
<p>This mode only renders the HTML item documentation for the current crate. It does not produce a search index, cross-crate trait implementations, or an index page. It is expected that users follow this mode with ‘Link documentation’ if these cross-crate features are desired.</p>
<p>In this mode, a user will provide <code>--parts-out-dir=&lt;path to crate-specific directory&gt;</code> and <code>--merge=none</code> to each crate’s rustdoc invocation. The user should provide <code>--extern-html-root-url</code>, and specify a absolute final destination for the docs, as a URL. The <code>--extern-html-root-url</code> flag should be provided for each crate’s rustdoc invocation, for every dependency.</p>
<p>A user may select a different <code>--out-dir</code> for each crate’s rustdoc invocation.</p>
<p>The same <code>--out-dir</code> may also be used for multiple parallel rustdoc invocations, as rustdoc will continue to acquire an flock on the <code>--out-dir</code> to address conflicts. This is in anticipation of the possibility of deprecating <code>--merge=shared</code>, and Cargo adopting a <code>--merge=none</code> + <code>--merge=finalize</code> workflow. Cargo is expected continue using the same <code>--out-dir</code> for all crates in a workspace, as this eliminates the operations needed to merge multiple <code>--out-dirs</code>.</p>
<h4 id="link-documentation---mergefinalize"><a class="header" href="#link-documentation---mergefinalize">Link documentation: <code>--merge=finalize</code></a></h4>
<p>In this mode, rendered HTML and <em>finalized</em> cross-crate information are generated into a <code>doc</code> folder. No <em>incremental</em> parts are generated (i.e., no <code>target/doc.parts/my-final-crate</code>).</p>
<p>This flag can be used with or without an target crate root. When used with a target crate, the parts for the target crate are included in the final docs. Otherwise, this mode functions merely to merge the input docs.</p>
<p>When a user documents the final crate, they will provide  <code>--include-parts-dir=&lt;crate-specific path selected previously&gt;</code> for each crate whose documentation is being combined, and <code>--merge=finalize</code>.</p>
<p>The user must merge every distinct <code>--out-dir</code> selected during the <code>--merge=none</code>, (e.g. <code>cp -r crate1/doc crate2/doc crate3/doc destination</code>). Most workspaces are expected to use a single <code>--out-dir</code>, so no manual merging is needed.</p>
<h2 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h2>
<p>The existing cross-crate information files, like <code>search-index.js</code>, all are lists of elements, rendered in an specified way (e.g. as a JavaScript file with a JSON array or an HTML index page containing an unordered list). The current rustdoc (in <code>write_shared</code>) pushes the current crate’s version of the CCI into the one that is already found in <code>doc</code>, and renders a new version. The rest of the proposal uses the term <strong>part</strong> to refer to the pre-merged, pre-rendered element of the CCI. This proposal does not add any new CCI or change their contents (modulo sorting order, whitespace).</p>
<h3 id="new-flag---mergenonesharedfinalize"><a class="header" href="#new-flag---mergenonesharedfinalize">New flag: <code>--merge=none|shared|finalize</code></a></h3>
<p>This flag corresponds to the three modes of invoking rustdoc described in ‘Suggested workflows’. It controls two internal paramaters: <code>read_rendered_cci</code>, and <code>write_rendered_cci</code>. It also gates whether the user is allowed to provide the <code>--parts-out-dir</code> and <code>--include-parts-dir</code> flags. It can be provided at most once.</p>
<p>When <code>write_rendered_cci</code> is active, rustdoc outputs the rendered parts to the doc root (<code>--out-dir</code>). Rustdoc will generate files like <code>doc/search-index.js</code>, <code>doc/search.desc</code>, <code>doc/index.html</code>, etc if and only if this parameter is true.</p>
<p>When <code>read_rendered_cci</code> is active, rustdoc will look in the <code>--out-dir</code> for rendered cross-crate info files. These files will be used as the base. Any new parts that rustdoc generates with its current invocation and any parts fetched with <code>include-parts-dir</code> will be appended to these base files. When it is disabled, the cross-crate info files start empty and are populated with the current crate’s info and any crates fetched with <code>--include-parts-dir</code>.</p>
<ul>
<li><code>--merge=shared</code> (<code>read_rendered_cci &amp;&amp; write_rendered_cci</code>) is the default, and reflects the current behavior of rustdoc. Rustdoc will look in its <code>--out-dir</code> for pre-existing cross-crate information files, and append information to these files from the current crate. The user is not allowed to provide <code>--parts-out-dir</code> or <code>--include-parts-dir</code> in this mode.</li>
<li><code>--merge=none</code> (<code>!read_rendered_cci &amp;&amp; !write_rendered_cci</code>) means that rustdoc will ignore the cross-crate files in the doc root. It only generates item docs. The user is optionally allowed to include <code>--parts-out-dir</code>, but not <code>--include-parts-dir</code>.</li>
<li><code>--merge=finalize</code> (<code>!read_rendered_cci &amp;&amp; write_rendered_cci</code>) outputs crate info based only on the current crate and <code>--include-parts-dir</code>’ed crates. The user is optionally allowed to include <code>--include-parts-dir</code>, but not <code>--parts-out-dir</code>.</li>
<li>A (<code>read_rendered_cci &amp;&amp; !write_rendered_cci</code>) mode would be useless, since the data that is read would be ignored and not written.</li>
</ul>
<p>The use of <code>--include-parts-dir</code> and <code>--parts-out-dir</code> is gated by <code>--merge</code> in order to prevent meaningless invocations, detect user error, and to provide for future changes to the interface.</p>
<h3 id="new-directory-docparts"><a class="header" href="#new-directory-docparts">New directory: <code>doc.parts/</code></a></h3>
<p><code>doc.parts</code> is the suggested name for the parent of the subdirectory that the user provides to <code>--parts-out-dir</code> and <code>--include-parts-dir</code>. A unique subdirectory for each crate must be provided to <code>--parts-out-dir</code> and <code>--include-parts-dir</code>. The user is encouraged to chose a directory outside of the <code>--out-dir</code>, as <code>--parts-out-dir</code> writes intermediate information that is not intended to be served on a static doc server.</p>
<p>Rustdoc only guarantees that it will accept <code>doc.parts</code> files written by the same version of rustdoc. Rustdoc is the only explicitly supported consumer of <code>doc.parts</code>. In the initial implementation, rustdoc will write a file called <code>crate-info</code> as a child of the directory provided to <code>--parts-out-dir</code>, and an reasonable effort will be made for this to continue to be the structure of the subdirectory. However, the contents of <code>--parts-out-dir</code> are considered formally unstable, leaving open the possible future addition of other related files. Non-normatively, there are several pieces of information that <code>doc.parts</code> may contain:</p>
<ul>
<li>Partial source file index for generating <code>doc/src-files.js</code>.</li>
<li>Partial search index for generating <code>doc/search-index.js</code>.</li>
<li>Crate name for generating <code>doc/crates.js</code>.</li>
<li>Crate name and information for generating <code>doc/index.html</code>.</li>
<li>Trait implementation list for generating <code>doc/trait.impl/**/*.js</code>.</li>
<li>Type implementation list for generating <code>doc/type.impl/**/*.js</code>.</li>
<li>The file may include versioning information intended to assist in generating error messages if an incompatible <code>doc.parts</code> is provided through <code>--include-parts-dir</code>.</li>
<li>The file may contain other information related to cross-crate information that is added in the future.</li>
</ul>
<h3 id="new-flag---parts-out-dirpathtodocpartscrate-name"><a class="header" href="#new-flag---parts-out-dirpathtodocpartscrate-name">New flag: <code>--parts-out-dir=path/to/doc.parts/&lt;crate-name&gt;</code></a></h3>
<p>When this flag is provided, the unmerged parts for the current crate will be written to <code>path/to/doc.parts/&lt;crate-name&gt;</code>. A typical argument is <code>./target/doc.parts/rand</code>.</p>
<p>This flag may only be used in the <code>--merge=none</code> mode. It is optional, and may be provided at most one time.</p>
<p>Crates <code>--include-parts-dir</code>ed will not appear in <code>doc.parts</code>, as <code>doc.parts</code> only includes the CCI parts for the current crate.</p>
<p>If this flag is not provided, no <code>doc.parts</code> will be written.</p>
<p>The output generated by this flag may be consumed by a future invocation to rustdoc that provides <code>--include-parts-dir=path/to/doc.parts/&lt;crate-name&gt;</code>.</p>
<h3 id="new-flag---include-parts-dirpathtodocpartscrate-name"><a class="header" href="#new-flag---include-parts-dirpathtodocpartscrate-name">New flag: <code>--include-parts-dir=path/to/doc.parts/&lt;crate-name&gt;</code></a></h3>
<p>If this flag is provided, rustdoc will expect that a previous invocation of rustdoc was made with <code>--parts-out-dir=path/to/doc.parts/&lt;crate-name&gt;</code>. It will append the parts from the previous invocation to the ones it will render in the doc root (<code>--out-dir</code>). The info that’s included is not written to its own <code>doc.parts</code>, as <code>doc.parts</code> only holds the CCI parts for the current crate.</p>
<p>This flag may only be used in the <code>--merge=finalize</code> mode. It is optional, and can be provided any number of times (once per crate whose documentation is merged).</p>
<p>In the Guide-level explanation, for example, the final invocation of rustdoc needs to identify the location of the <code>struct-crate</code>’s parts. Since they could be located in an arbitrary directory, the final invocation must be instructed on where to fetch them. In this example, the <code>struct-crate</code>’s parts happen to be in <code>./struct-crate/target/doc.parts/struct-crate</code>, so rustdoc is called with <code>--include-parts-dir=struct-crate/target/doc.parts/struct-crate</code>.</p>
<p>This flag is similar to <code>--extern-html-root-url</code> in that it only needs to be provided for externally documented crates. The flag <code>--extern-html-root-url</code> controls hyperlink generation. The hyperlink provided in <code>--extern-html-root-url</code> never accessed by rustdoc, and represents the final destination of the documentation. The new flag <code>--include-parts-dir</code> tells rustdoc where to search for the <code>doc.parts</code> directory at documentation-time. It must not be a URL.</p>
<h3 id="merge-step"><a class="header" href="#merge-step">Merge step</a></h3>
<p>This proposal is capable of addressing two primary use cases. It allows developers to enable CCI in these scenarios:</p>
<ul>
<li>Documenting a crate and its transitive dependencies in parallel in build systems that require build actions to be independent</li>
<li>Producing a documentation index of every crate in a workspace, in such a way that if one crate is updated, only the updated crates and an index have to be redocumented. This scenario is demonstrated in the Guide-level explanation.</li>
</ul>
<p>CCI is not automatically enabled in either situation. A combination of the <code>--include-parts-dir</code>, <code>--merge</code>, and <code>--parts-out-dir</code> flags are needed to produce this behavior. This RFC provides a minimal set of tools that allow developers of build systems, like Bazel and Buck2, to create rules for these scenarios.</p>
<p>With separate <code>--out-dir</code>s, copying item docs to an output destination is needed. Rustdoc will never support the entire breadth of workflows needed to merge arbitrary directories, and will rely on users to run external commands like <code>mv</code>, <code>cp</code>, <code>rsync</code>, <code>scp</code>, etc. for these purposes. Most users are expected to continue to use a single <code>--out-dir</code> for all crates, in which case these external tools are not needed. It is expected that build systems with the need to be hermetic will use separate <code>--out-dir</code>s for <code>--merge=none</code>, while Cargo will continue to use the same <code>--out-dir</code> for every rustdoc invocation.</p>
<h3 id="compatibility"><a class="header" href="#compatibility">Compatibility</a></h3>
<p>This RFC does not alter previous compatibility guarantees made about the output of rustdoc. In particular it does not stabilize the presence of the rendered cross-crate information files, their content, or the HTML generated by rustdoc.</p>
<p>The content of <code>doc.parts</code> will be considered unstable. Between versions of rustdoc, breaking changes to the content of <code>doc.parts</code> should be expected. Only the presence of a <code>doc.parts</code> directory is promised, under <code>--parts-out-dir</code>. Merging cross-crate information generated by disparate versions of rustdoc is not supported. To detect whether <code>doc.parts</code> is compatible, rustdoc includes a version number in these files (see New directory: <code>doc.parts</code>).</p>
<p>The implementation of the RFC itself is designed to produce only minimal changes to cross-crate info files and the HTML output of rustdoc. Exhaustively, the implementation is allowed to</p>
<ul>
<li>Change the sorting order of trait implementations, type implementations, and other cross-crate info in the HTML output of rustdoc.</li>
<li>Add a comment on the last line of generated HTML pages, to store metadata relevant to appending items to them.</li>
<li>Refactor the JavaScript contents of cross-crate information files, in ways that do not change their overall behavior. If the JavaScript fragment declared an array called <code>ALL_CRATES</code> with certain contents, it will continue to do so.</li>
</ul>
<p>Changes this minimal are intended to avoid breaking tools that use the output of rustdoc, like Cargo, docs.rs, and rustdoc’s JavaScript frontend, in the near-term. Going forward, rustdoc will not make formal guarantees about the content of cross-crate info files.</p>
<h3 id="note-about-the-existing-flag---extern-html-root-url"><a class="header" href="#note-about-the-existing-flag---extern-html-root-url">Note about the existing flag <code>--extern-html-root-url</code></a></h3>
<p>For the purpose of generating cross-crate links, rustdoc classifies the location of crates as external, local, or unknown (relative to the crate in the current invocation of rustdoc). Local crates are the crates that share the same <code>--out-dir</code>. External crates have documentation that could not be found in the current <code>--out-dir</code>, but otherwise have a known location. Item links are not generated to crates with an unknown location. When the <code>--extern-html-root-url=&lt;crate name&gt;=&lt;url&gt;</code> flag is provided, an otherwise unknown crate <code>&lt;crate name&gt;</code> becomes an externally located crate, forcing it to generate item links.</p>
<p>This is of relevance to this proposal, because users who document crates with separate <code>--out-dir</code>s may still expect cross-crate links to work. Currently, <code>--extern-html-root-url</code> is the exclusive command line option for specifying link destinations for crates who would otherwise have an unknown location. We will expect users to provide <code>--extern-html-root-url</code> for all direct dependencies of a crate they are documenting, if they use separate <code>--out-dir</code>s. Example usage of this flag is in the Guide-level explanation.</p>
<p>The limitation of <code>--extern-html-root-url</code> is that it needs to be provided with an absolute URL for the final docs destination. If your docs are hosted on <code>https://example.com/docs/</code>, this URL must be <em>known at documentation time</em>, and provided through <code>--extern-html-root-url=&lt;crate name&gt;=https://example.com/docs/</code>. <em>Absolute URLs</em>, instead of relative URLs, are generated for items in externally located crates. A future proposal may address this limitation by providing a command line option that generates relative URLs (like is done between items in the current crate, or other locally documented crates) for selected external crates, assuming that these crates will end up in the same bundle. The existing <code>--extern-html-root-url</code> is sufficient for the use cases envisioned by this RFC, despite the limitation.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p>The implementation may change the sorting order of the elements in the CCI. It does not change the content of the documentation, and is intended to work without modifying Cargo and docs.rs.</p>
<h2 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h2>
<p>Running rustdoc in parallel is essential in enabling the tool to scale to large projects. The approach implemented by Cargo is to run rustdoc in parallel by locking the CCI files. There are some workspaces where having synchronized access to the CCI is impossible. This proposal implements a reasonable approach to shared rustdoc, because it cleanly enables the addition of new kinds of CCI without changing existing documentation.</p>
<h2 id="prior-art"><a class="header" href="#prior-art">Prior art</a></h2>
<p>Prior art for linking and merging independently generated documentation was <strong>not</strong> identified in Javadoc, Godoc, Doxygen, Sphinx (intersphinx), nor any documentation system for other languages. Analogs of cross-crate information were not found, but a more thorough investigation or experience with other systems may be needed.</p>
<p>However, the issues presented here have been encountered in multiple build systems that interact with rustdoc. They limit the usefulness of rustdoc in large workspaces.</p>
<h3 id="bazel"><a class="header" href="#bazel">Bazel</a></h3>
<p>Bazel has <code>rules_rust</code> for building Rust targets and rustdoc documentation.</p>
<ul>
<li><a href="https://bazelbuild.github.io/rules_rust/rust_doc.html">https://bazelbuild.github.io/rules_rust/rust_doc.html</a></li>
<li><a href="https://github.com/bazelbuild/rules_rust/blob/67b3571d7e5e341de337317d84a6bec6b9d02ed7/rust/private/rustdoc.bzl#L174">https://github.com/bazelbuild/rules_rust/blob/67b3571d7e5e341de337317d84a6bec6b9d02ed7/rust/private/rustdoc.bzl#L174</a></li>
</ul>
<p>It does not document crates’ dependencies. <code>search-index.js</code>, for example, is both a dependency and an output file for rustdoc in multi-crate documentation workspaces. If it is declared as a dependency in this way, Bazel could not build docs for the members of an environment in parallel with a single output directory, as it strictly enforces hermiticity. For a recursive, parallel rustdoc to ever serve as a first-class citizen in Bazel, changes similar to the ones described in this proposal would be needed.</p>
<p>There is an <a href="https://github.com/bazelbuild/rules_rust/issues/1837">open issue</a> raised about the fact that Bazel does not document crates dependencies. The comments in the issue discuss a pull request on Bazel that documents each crates dependencies in a separate output directory. It is noted in the discussion that this solution, being implemented under the current rustdoc, “doesn’t scale well and it should be implemented in a different manner long term.” In order to get CCI in a mode like this, rustdoc would need to adopt changes, like the ones in this proposal, for merging cross-crate information.</p>
<h3 id="buck2"><a class="header" href="#buck2">Buck2</a></h3>
<p>The Buck2 build system has rules for building and testing rust binaries and libraries. <a href="https://buck2.build/docs/prelude/globals/#rust_library">https://buck2.build/docs/prelude/globals/#rust_library</a></p>
<p>It has a subtarget, <code>[doc]</code>, for generating rustdoc for a crate.</p>
<p>You can provide <code>extern-html-root-url</code>. You can document all crates independently and manually merge them but no cross-crate information would be shared.</p>
<p>buck2 does not natively merge rustdoc from separate targets. The buck2 maintainers have a <a href="https://rust-lang.zulipchat.com/#narrow/stream/266220-t-rustdoc/topic/mergable.20rustdoc.20proposal/near/445952204">proprietary search backend</a> that merges and parses <code>search-index.js</code> files from separately documented crates. Their proprietary tooling does not handle cross-crate trait implementations from upstream crates. By implementing this merging directly in rustdoc, we could avoid fragmentation and bring cross-crate information to more consumers.</p>
<p><a href="https://github.com/facebook/buck2/blob/d390e31632d3b4a726aaa2aaf3c9f1f63935e069/prelude/rust/build.bzl#L213">https://github.com/facebook/buck2/blob/d390e31632d3b4a726aaa2aaf3c9f1f63935e069/prelude/rust/build.bzl#L213</a></p>
<h3 id="ninja-gn--fuchsia"><a class="header" href="#ninja-gn--fuchsia">Ninja <a href="https://fuchsia.dev/fuchsia-src/development/build/build_system/intro">(GN)</a> + Fuchsia</a></h3>
<p>Currently, the Fuchsia project runs rustdoc on all of their crates to generate a <a href="https://fuchsia-docs.firebaseapp.com/rust/rustdoc_index/">documentation index</a>. This index is effectively generated as an <a href="https://cs.opensource.google/fuchsia/fuchsia/+/4eefc272d36835959f2e44be6e06a6fbb504e418:tools/devshell/contrib/lib/rust/rustdoc.py">atomic step</a> in the build system. It takes <a href="https://ci.chromium.org/ui/p/fuchsia/builders/global.ci/firebase-docs/b8744777376580022225/overview">3 hours</a> to document the ~2700 crates in the environment. With this proposal, building each crate’s documentation could be done as separate build actions, which would have a number of benefits. These include parallelism, caching (avoid rebuilding docs unnecessarily), and robustness (automatically reject pull requests that break documentation).</p>
<h2 id="未解決的問題"><a class="header" href="#未解決的問題">未解決的問題</a></h2>
<h3 id="unconditionally-generating-the-docparts-files"><a class="header" href="#unconditionally-generating-the-docparts-files">Unconditionally generating the <code>doc.parts</code> files?</a></h3>
<p>Generate no extra files (current) vs. unconditionally creating <code>doc.parts</code> to enable more complex future CCI (should consider).</p>
<p>The current version of rustdoc performs merging by <a href="https://github.com/rust-lang/rust/blob/c25ac9d6cc285e57e1176dc2da6848b9d0163810/src/librustdoc/html/render/write_shared.rs#L166">collecting JSON</a> blobs from the contents of the already-rendered CCI. This proposal proposes to continue reading from the rendered cross-crate information under the default <code>--merge=shared</code>. It can also read <code>doc.parts</code> directories, under <code>--include-parts-dir</code>. However, there are several issues with reading from the rendered CCI that must be stated:</p>
<ul>
<li>Every rustdoc process outputs the CCI to the same doc root by default</li>
<li>It is difficult to extract the items in a diverse set of rendered HTML files. This is anticipating of the CCI to include HTML files that, for example, statically include type+trait implementations directly</li>
<li>Reading exclusively from <code>doc.parts</code> is simpler than the existing <code>serde_json</code> dependency for extracting the blobs, as opposed to handwritten CCI-type specific parsing (current)</li>
<li>With this proposal, there will be duplicate logic to read from both <code>doc.parts</code> files and rendered CCI.</li>
</ul>
<p><a href="https://github.com/rust-lang/rfcs/pull/3662#issuecomment-2184077829">@jsha proposes</a> unconditionally generating and reading from <code>doc.parts</code>, with no appending to the rendered crate info.</p>
<h2 id="future-possibilities"><a class="header" href="#future-possibilities">Future possibilities</a></h2>
<p>This RFC is primarily intended be followed by the deprecation of the now-default <code>--merge=shared</code> mode. This will reduce complexity in the long term. Changes to Cargo, docs.rs and other tools that directly invoke rustdoc will be required. To verify that the <code>--merge=none</code> -&gt; <code>--merge=finalize</code> workflow is sufficient for real use cases, the deprecation of <code>--merge=shared</code> will be delayed to a future RFC.</p>
<p>This change could begin to facilitate trait implementations being statically compiled as part of the .html documentation, instead of being loaded as separate JavaScript files. Each trait implementation could be stored as an HTML part, which are then merged into the regular documentation. Implementations of traits on type aliases should remain separate, as they serve as a <a href="https://github.com/rust-lang/rust/pull/116471">size hack</a>.</p>
<p>Another possibility is for <code>doc.parts</code> to be distributed on <code>docs.rs</code> along with the regular documentation. This would facilitate a mode where documentation of the dependencies could be downloaded externally, instead of being rebuilt locally.</p>
<p>The changes in this proposal are intended to work with no changes to Cargo and docs.rs. However, there may be benefits to using <code>--merge=finalize</code> with Cargo, as it would remove the need for locking the output directory. More of the documentation process could happen in parallel, which may speed up execution time.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="3660-crates-io-crate-deletions.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="3668-async-closures.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="3660-crates-io-crate-deletions.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="3668-async-closures.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
