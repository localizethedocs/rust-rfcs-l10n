<!DOCTYPE HTML>
<html lang="zh_CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0474-path-reform - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-b61d75f0.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2014-11-12</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/474">rust-lang/rfcs#474</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/20034">rust-lang/rust#20034</a></li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>This RFC reforms the design of the <code>std::path</code> module in preparation for API stabilization. The path API must deal with many competing demands, and the current design handles many of them, but suffers from some significant problems given in “Motivation” below. The RFC proposes a redesign modeled loosely on the current API that addresses these problems while maintaining the advantages of the current design.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>The design of a path abstraction is surprisingly hard. Paths work radically differently on different platforms, so providing a cross-platform abstraction is challenging. On some platforms, paths are not required to be in Unicode, posing ergonomic and semantic difficulties for a Rust API. These difficulties are compounded if one also tries to provide efficient path manipulation that does not, for example, require extraneous copying. And, of course, the API should be easy and pleasant to use.</p>
<p>The current <code>std::path</code> module makes a strong effort to balance these design constraints, but over time a few key shortcomings have emerged.</p>
<h3 id="semantic-problems"><a class="header" href="#semantic-problems">Semantic problems</a></h3>
<p>Most importantly, the current <code>std::path</code> module makes some semantic assumptions about paths that have turned out to be incorrect.</p>
<h4 id="normalization"><a class="header" href="#normalization">Normalization</a></h4>
<p>Paths in <code>std::path</code> are always <em>normalized</em>, meaning that <code>a/../b</code> is treated like <code>b</code> (among other things). Unfortunately, this kind of normalization changes the meaning of paths when symbolic links are present: if <code>a</code> is a symbolic link, then the relative paths <code>a/../b</code> and <code>b</code> may refer to completely different locations. See <a href="https://github.com/rust-lang/rust/issues/14028">this issue</a> for more detail.</p>
<p>For this reason, most path libraries do <em>not</em> perform full normalization of paths, though they may normalize paths like <code>a/./b</code> to <code>a/b</code>. Instead, they offer (1) methods to optionally normalize and (2) methods to normalize based on the contents of the underlying file system.</p>
<p>Since our current normalization scheme can silently and incorrectly alter the meaning of paths, it needs to be changed.</p>
<h4 id="unicode-and-windows"><a class="header" href="#unicode-and-windows">Unicode and Windows</a></h4>
<p>In the original <code>std::path</code> design, it was assumed that all paths on Windows were Unicode. However, it <a href="https://github.com/rust-lang/rust/issues/12056">turns out</a> that the Windows filesystem APIs actually work with <a href="http://en.wikipedia.org/wiki/UTF-16">UCS-2</a>, which roughly means that they accept arbitrary sequences of <code>u16</code> values but interpret them as UTF-16 when it is valid to do so.</p>
<p>The current <code>std::path</code> implementation is built around the assumption that Windows paths can be represented as Rust string slices, and will need to be substantially revised.</p>
<h3 id="ergonomic-problems"><a class="header" href="#ergonomic-problems">Ergonomic problems</a></h3>
<p>Because paths in general are not in Unicode, the <code>std::path</code> module cannot rely on an internal string or string slice representation. That in turn causes trouble for methods like <code>dirname</code> that are intended to extract a subcomponent of a path -- what should it return?</p>
<p>There are basically three possible options, and today’s <code>std::path</code> module chooses <em>all</em> of them:</p>
<ul>
<li>Yield a byte sequence: <code>dirname</code> yields an <code>&amp;[u8]</code></li>
<li>Yield a string slice, accounting for potential non-UTF-8 values: <code>dirname_str</code> yields an <code>Option&lt;&amp;str&gt;</code></li>
<li>Yield another path: <code>dir_path</code> yields a <code>Path</code></li>
</ul>
<p>This redundancy is present for most of the decomposition methods. The saving grace is that, in general, path methods consume <code>BytesContainer</code> values, so one can use the <code>&amp;[u8]</code> variant but continue to work with other path methods. But in general <code>&amp;[u8]</code> values are not ergonomic to work with, and the explosion in methods makes the module more (superficially) complex than one might expect.</p>
<p>You might be tempted to provide only the third option, but <code>Path</code> values are <em>owned</em> and <em>mutable</em>, so that would imply cloning on every decomposition operation. For applications like Cargo that work heavily with paths, this would be an unfortunate (and seemingly unnecessary) overhead.</p>
<h3 id="organizational-problems"><a class="header" href="#organizational-problems">Organizational problems</a></h3>
<p>Finally, the <code>std::path</code> module presents a somewhat complex API organization:</p>
<ul>
<li>The <code>Path</code> type is a direct alias of a platform-specific path type.</li>
<li>The <code>GenericPath</code> trait provides most of the common API expected on both platforms.</li>
<li>The <code>GenericPathUnsafe</code> trait provides a few unsafe/unchecked functions for performance reasons.</li>
<li>The <code>posix</code> and <code>windows</code> submodules provide their own <code>Path</code> types and a handful of platform-specific functionality (in particular, <code>windows</code> provides support for working with volumes and “verbatim” paths prefixed with <code>\\?\</code>)</li>
</ul>
<p>This organization needs to be updated to match current conventions and simplified if possible.</p>
<p>One thing to note: with the current organization, it is possible to work with non-native paths, which can sometimes be useful for interoperation. The new design should retain this functionality.</p>
<h2 id="detailed-design"><a class="header" href="#detailed-design">Detailed design</a></h2>
<p>Note: this design is influenced by the <a href="www.boost.org/doc/libs/1_57_0/libs/filesystem/doc/reference.html">Boost filesystem library</a> and <a href="http://s48.org/1.8/manual/manual-Z-H-6.html#node_sec_5.15">Scheme48</a> and <a href="http://plt.eecs.northwestern.edu/snapshots/current/doc/reference/windowspaths.html#%28part._windowspathrep%29">Racket’s</a> approach to encoding issues on windows.</p>
<h3 id="overview"><a class="header" href="#overview">Overview</a></h3>
<p>The basic design uses DST to follow the same pattern as <code>Vec&lt;T&gt;/[T]</code> and <code>String/str</code>: there is a <code>PathBuf</code> type for owned, mutable paths and an unsized <code>Path</code> type for slices. The various “decomposition” methods for extracting components of a path all return slices, and <code>PathBuf</code> itself derefs to <code>Path</code>.</p>
<p>The result is an API that is both efficient and ergonomic: there is no need to allocate/copy when decomposing a path, but there is also no need to provide multiple variants of methods to extract bytes versus Unicode strings. For example, the <code>Path</code> slice type provides a <em>single</em> method for converting to a <code>str</code> slice (when applicable).</p>
<p>A key aspect of the design is that there is no internal normalization of paths at all. Aside from solving the symbolic link problem, this choice also has useful ramifications for the rest of the API, described below.</p>
<p>The proposed API deals with the other problems mentioned above, and also brings the module in line with current Rust patterns and conventions. These details will be discussed after getting a first look at the core API.</p>
<h3 id="the-cross-platform-api"><a class="header" href="#the-cross-platform-api">The cross-platform API</a></h3>
<p>The proposed core, cross-platform API provided by the new <code>std::path</code> is as follows:</p>
<pre><code class="language-rust">// A sized, owned type akin to String:
pub struct PathBuf { .. }

// An unsized slice type akin to str:
pub struct Path { .. }

// Some ergonomics and generics, following the pattern in String/str and Vec&lt;T&gt;/[T]
impl Deref&lt;Path&gt; for PathBuf { ... }
impl BorrowFrom&lt;PathBuf&gt; for Path { ... }

// A replacement for BytesContainer; used to cut down on explicit coercions
pub trait AsPath for Sized? {
    fn as_path(&amp;self) -&gt; &amp;Path;
}

impl&lt;Sized? P&gt; PathBuf where P: AsPath {
    pub fn new&lt;T: IntoString&gt;(path: T) -&gt; PathBuf;

    pub fn push(&amp;mut self, path: &amp;P);
    pub fn pop(&amp;mut self) -&gt; bool;

    pub fn set_file_name(&amp;mut self, file_name: &amp;P);
    pub fn set_extension(&amp;mut self, extension: &amp;P);
}

// These will ultimately replace the need for `push_many`
impl&lt;Sized? P&gt; FromIterator&lt;P&gt; for PathBuf where P: AsPath { .. }
impl&lt;Sized? P&gt; Extend&lt;P&gt; for PathBuf where P: AsPath { .. }

impl&lt;Sized? P&gt; Path where P: AsPath {
    pub fn new(path: &amp;str) -&gt; &amp;Path;

    pub fn as_str(&amp;self) -&gt; Option&lt;&amp;str&gt;
    pub fn to_str_lossy(&amp;self) -&gt; Cow&lt;String, str&gt;; // Cow will replace MaybeOwned
    pub fn to_owned(&amp;self) -&gt; PathBuf;

    // iterate over the components of a path
    pub fn iter(&amp;self) -&gt; Iter;

    pub fn is_absolute(&amp;self) -&gt; bool;
    pub fn is_relative(&amp;self) -&gt; bool;
    pub fn is_ancestor_of(&amp;self, other: &amp;P) -&gt; bool;

    pub fn path_relative_from(&amp;self, base: &amp;P) -&gt; Option&lt;PathBuf&gt;;
    pub fn starts_with(&amp;self, base: &amp;P) -&gt; bool;
    pub fn ends_with(&amp;self, child: &amp;P) -&gt; bool;

    // The "root" part of the path, if absolute
    pub fn root_path(&amp;self) -&gt; Option&lt;&amp;Path&gt;;

    // The "non-root" part of the path
    pub fn relative_path(&amp;self) -&gt; &amp;Path;

    // The "directory" portion of the path
    pub fn dir_path(&amp;self) -&gt; &amp;Path;

    pub fn file_name(&amp;self) -&gt; Option&lt;&amp;Path&gt;;
    pub fn file_stem(&amp;self) -&gt; Option&lt;&amp;Path&gt;;
    pub fn extension(&amp;self) -&gt; Option&lt;&amp;Path&gt;;

    pub fn join(&amp;self, path: &amp;P) -&gt; PathBuf;

    pub fn with_file_name(&amp;self, file_name: &amp;P) -&gt; PathBuf;
    pub fn with_extension(&amp;self, extension: &amp;P) -&gt; PathBuf;
}

pub struct Iter&lt;'a&gt; { .. }

impl&lt;'a&gt; Iterator&lt;&amp;'a Path&gt; for Iter&lt;'a&gt; { .. }

pub const SEP: char = ..
pub const ALT_SEPS: &amp;'static [char] = ..

pub fn is_separator(c: char) -&gt; bool { .. }</code></pre>
<p>There is plenty of overlap with today’s API, and the methods being retained here largely have the same semantics.</p>
<p>But there are also a few potentially surprising aspects of this design that merit comment:</p>
<ul>
<li>
<p><strong>Why does <code>PathBuf::new</code> take <code>IntoString</code>?</strong> It needs an owned buffer internally, and taking a string means that Unicode input is guaranteed, which works on all platforms. (In general, the assumption is that non-Unicode paths are most commonly produced by <em>reading</em> a path from the filesystem, rather than creating now ones. As we’ll see below, there are <em>platform-specific</em> ways to crate non-Unicode paths.)</p>
</li>
<li>
<p><strong>Why no <code>Path::as_bytes</code> method?</strong> There is no cross-platform way to expose paths directly in terms of byte sequences, because each platform extends beyond Unicode in its own way. In particular, Unix platforms accept arbitrary u8 sequences, while Windows accepts arbitrary <em>u16</em> sequences (both modulo disallowing interior 0s). The u16 sequences provided by Windows do not have a canonical encoding as bytes; this RFC proposed to use <a href="http://simonsapin.github.io/wtf-8/">WTF-8</a> (see below), but does not reveal that choice.</p>
</li>
<li>
<p><strong>What about interior nulls?</strong> Currently various Rust system APIs will panic when given strings containing interior null values because, while these are valid UTF-8, it is not possible to send them as-is to C APIs that expect null-terminated strings. The API here follows the same approach, panicking if given a path with an interior null.</p>
</li>
<li>
<p><strong>Why do <code>file_name</code> and <code>extension</code> operations work with <code>Path</code> rather than some other type?</strong> In particular, it may seem strange to view an extension as a path. But doing so allows us to not reveal platform differences about the various character sets used in paths. By and large, extensions in practice will be valid Unicode, so the various methods going to and from <code>str</code> will suffice. But as with paths in general, there are platform-specific ways of working with non-Unicode data, explained below.</p>
</li>
<li>
<p><strong>Where did <code>push_many</code> and friends go?</strong> They’re replaced by implementing <code>FromIterator</code> and <code>Extend</code>, following a similar pattern with the <code>Vec</code> type. (Some work will be needed to retain full efficiency when doing so.)</p>
</li>
<li>
<p><strong>How does <code>Path::new</code> work?</strong> The ability to directly get a <code>&amp;Path</code> from an <code>&amp;str</code> (i.e., with no allocation or other work) is a key part of the representation choices, which are described below.</p>
</li>
<li>
<p><strong>Where is the <code>normalize</code> method?</strong> Since the path type no longer internally normalizes, it may be useful to explicitly request normalization. This can be done by writing <code>let normalized: PathBuf = p.iter().collect()</code> for a path <code>p</code>, because the iterator performs some on-the-fly normalization (see below). *<em>NOTE</em> this normalization does <em>not</em> include removing <code>..</code>, for the reasons explained at the beginning of the RFC.</p>
</li>
<li>
<p><strong>What does the iterator yield?</strong> Unlike today’s <code>components</code>, the <code>iter</code> method here will begin with <code>root_path</code> if there is one. Thus, <code>a/b/c</code> will yield <code>a</code>, <code>b</code> and <code>c</code>, while <code>/a/b/c</code> will yield <code>/</code>, <code>a</code>, <code>b</code> and <code>c</code>.</p>
</li>
</ul>
<h3 id="important-semantic-rules"><a class="header" href="#important-semantic-rules">Important semantic rules</a></h3>
<p>The path API is designed to satisfy several semantic rules described below. <strong>Note that <code>==</code> here is <em>lazily</em> normalizing</strong>, treating <code>./b</code> as <code>b</code> and <code>a//b</code> as <code>a/b</code>; see the next section for more details.</p>
<p>Suppose <code>p</code> is some <code>&amp;Path</code> and <code>dot == Path::new(".")</code>:</p>
<pre><code class="language-rust">p == p.join(dot)
p == dot.join(p)

p == p.root_path().unwrap_or(dot)
      .join(p.relative_path())

p.relative_path() == match p.root_path() {
    None =&gt; p,
    Some(root) =&gt; p.path_relative_from(root).unwrap()
}

p == p.dir_path()
      .join(p.file_name().unwrap_or(dot))

p == p.iter().collect()

p == match p.file_name() {
    None =&gt; p,
    Some(name) =&gt; p.with_file_name(name)
}

p == match p.extension() {
    None =&gt; p,
    Some(ext) =&gt; p.with_extension(ext)
}

p == match (p.file_stem(), p.extension()) {
    (Some(stem), Some(ext)) =&gt; p.with_file_name(name).with_extension(ext),
    _ =&gt; p
}</code></pre>
<h3 id="representation-choices-unicode-and-normalization"><a class="header" href="#representation-choices-unicode-and-normalization">Representation choices, Unicode, and normalization</a></h3>
<p>A lot of the design in this RFC depends on a key property: both Unix and Windows paths can be easily represented as a flat byte sequence “compatible” with UTF-8. For Unix platforms, this is trivial: they accept any byte sequence, and will generally interpret the byte sequences as UTF-8 when valid to do so. For Windows, this representation involves a clever hack – proposed formally as <a href="http://simonsapin.github.io/wtf-8/">WTF-8</a> – that encodes its native UCS-2 in a generalization of UTF-8. This RFC will not go into the details of that hack; please read Simon’s excellent writeup if you’re interested.</p>
<p>The upshot of all of this is that we can uniformly represent path slices as newtyped byte slices, and any UTF-8 encoded data will “do the right thing” on all platforms.</p>
<p>Furthermore, by not doing any internal, up-front normalization, it’s possible to provide a <code>Path::new</code> that goes from <code>&amp;str</code> to <code>&amp;Path</code> with no intermediate allocation or validation. In the common case that you’re working with Rust strings to construct paths, there is zero overhead. It also means that <code>Path::new(some_str).as_str = Some(some_str)</code>.</p>
<p>The main downside of this choice is that some of the path functionality must cope with non-normalized paths. So, for example, the iterator must skip <code>.</code> path components (unless it is the entire path), and similarly for methods like <code>pop</code>. In general, methods that yield new path slices are expected to work as if:</p>
<ul>
<li><code>./b</code> is just <code>b</code></li>
<li><code>a//b</code> is just <code>a/b</code></li>
</ul>
<p>and comparisons between paths should also behave as if the paths had been normalized in this way.</p>
<h3 id="organization-and-platform-specific-apis"><a class="header" href="#organization-and-platform-specific-apis">Organization and platform-specific APIs</a></h3>
<p>Finally, the proposed API is organized as <code>std::path</code> with <code>unix</code> and <code>windows</code> submodules, as today. However, there is no <code>GenericPath</code> or <code>GenericPathUnsafe</code>; instead, the API given above is implemented as a trivial wrapper around path implementations provided by either the <code>unix</code> or the <code>windows</code> submodule (based on <code>#[cfg]</code>). In other words:</p>
<ul>
<li><code>std::path::windows::Path</code> works with Windows-style paths</li>
<li><code>std::path::unix::Path</code> works with Unix-style paths</li>
<li><code>std::path::Path</code> is a thin newtype wrapper around the current platform’s path implementation</li>
</ul>
<p>This organization makes it possible to manipulate foreign paths by working with the appropriate submodule.</p>
<p>In addition, each submodule defines some extension traits, explained below, that supplement the path API with functionality relevant to its variant of path.</p>
<p>But what if you’re writing a platform-specific application and wish to use the extended functionality directly on <code>std::path::Path</code>? In this case, you will be able to import the appropriate extension trait via <code>os::unix</code> or <code>os::windows</code>, depending on your platform. This is part of a new, general strategy for explicitly “opting-in” to platform-specific features by importing from <code>os::some_platform</code> (where the <code>some_platform</code> submodule is available only on that platform.)</p>
<h4 id="unix"><a class="header" href="#unix">Unix</a></h4>
<p>On Unix platforms, the only additional functionality is to let you work directly with the underlying byte representation of various path types:</p>
<pre><code class="language-rust">pub trait UnixPathBufExt {
    fn from_vec(path: Vec&lt;u8&gt;) -&gt; Self;
    fn into_vec(self) -&gt; Vec&lt;u8&gt;;
}

pub trait UnixPathExt {
    fn from_bytes(path: &amp;[u8]) -&gt; &amp;Self;
    fn as_bytes(&amp;self) -&gt; &amp;[u8];
}</code></pre>
<p>This is acceptable because the platform supports arbitrary byte sequences (usually interpreted as UTF-8).</p>
<h4 id="windows"><a class="header" href="#windows">Windows</a></h4>
<p>On Windows, the additional APIs allow you to convert to/from UCS-2 (roughly, arbitrary <code>u16</code> sequences interpreted as UTF-16 when applicable); because the name “UCS-2” does not have a clear meaning, these APIs use <code>u16_slice</code> and will be carefully documented. They also provide the remaining Windows-specific path decomposition functionality that today’s path module supports.</p>
<pre><code class="language-rust">pub trait WindowsPathBufExt {
    fn from_u16_slice(path: &amp;[u16]) -&gt; Self;
    fn make_non_verbatim(&amp;mut self) -&gt; bool;
}

pub trait WindowsPathExt {
    fn is_cwd_relative(&amp;self) -&gt; bool;
    fn is_vol_relative(&amp;self) -&gt; bool;
    fn is_verbatim(&amp;self) -&gt; bool;
    fn prefix(&amp;self) -&gt; PathPrefix;
    fn to_u16_slice(&amp;self) -&gt; Vec&lt;u16&gt;;
}

enum PathPrefix&lt;'a&gt; {
    Verbatim(&amp;'a Path),
    VerbatimUNC(&amp;'a Path, &amp;'a Path),
    VerbatimDisk(&amp;'a Path),
    DeviceNS(&amp;'a Path),
    UNC(&amp;'a Path, &amp;'a Path),
    Disk(&amp;'a Path),
}</code></pre>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p>The DST/slice approach is conceptually more complex than today’s API, but in practice seems to yield a much tighter API surface.</p>
<h2 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h2>
<p>Due to the known semantic problems, it is not really an option to retain the current path implementation. As explained above, supporting UCS-2 also means that the various byte-slice methods in the current API are untenable, so the API also needs to change.</p>
<p>Probably the main alternative to the proposed API would be to <em>not</em> use DST/slices, and instead use owned paths everywhere (probably doing some normalization of <code>.</code> at the same time). While the resulting API would be simpler in some respects, it would also be substantially less efficient for common operations.</p>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<p>It is not clear how best to incorporate the <a href="https://github.com/SimonSapin/rust-wtf8">WTF-8 implementation</a> (or how much to incorporate) into <code>libstd</code>.</p>
<p>There has been a long debate over whether paths should implement <code>Show</code> given that they may contain non-UTF-8 data. This RFC does not take a stance on that (the API may include something like today’s <code>display</code> adapter), but a follow-up RFC will address the question more generally.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0469-feature-gate-box-patterns.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="0486-std-ascii-reform.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0469-feature-gate-box-patterns.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="0486-std-ascii-reform.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
