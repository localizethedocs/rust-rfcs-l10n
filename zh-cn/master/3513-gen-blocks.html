<!DOCTYPE HTML>
<html lang="zh_CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>3513-gen-blocks - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-b61d75f0.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Feature Name: <code>gen_blocks</code></li>
<li>Start Date: 2023-10-10</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/3513">rust-lang/rfcs#3513</a></li>
<li>Tracking Issue: <a href="https://github.com/rust-lang/rust/issues/117078">rust-lang/rust#117078</a></li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>This RFC reserves the <code>gen</code> keyword in the Rust 2024 edition for generators and adds <code>gen { .. }</code> blocks to the language.  Similar to how <code>async</code> blocks produce values that can be awaited with <code>.await</code>, <code>gen</code> blocks produce values that can be iterated over with <code>for</code>.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>Writing iterators manually can be painful.  Many iterators can be written by chaining together iterator combinators, but some need to be written with a manual implementation of <code>Iterator</code>.  This can push people to avoid iterators and do worse things such as writing loops that eagerly store values to mutable state.  With <code>gen</code> blocks, we can now write a simple <code>for</code> loop and still get a lazy iterator of values.</p>
<p>By way of example, consider these alternate ways of expressing <a href="https://en.wikipedia.org/wiki/Run-length_encoding">run-length encoding</a>:</p>
<pre><code class="language-rust">// This example uses `gen` blocks, introduced in this RFC.
fn rl_encode&lt;I: IntoIterator&lt;Item = u8&gt;&gt;(
    xs: I,
) -&gt; impl Iterator&lt;Item = u8&gt; {
    gen {
        let mut xs = xs.into_iter();
        let (Some(mut cur), mut n) = (xs.next(), 0) else { return };
        for x in xs {
            if x == cur &amp;&amp; n &lt; u8::MAX {
                n += 1;
            } else {
                yield n; yield cur;
                (cur, n) = (x, 0);
            }
        }
        yield n; yield cur;
    }.into_iter()
}

// This example uses a manual implementation of `Iterator`.
fn rl_encode&lt;I: IntoIterator&lt;Item = u8&gt;&gt;(
    xs: I,
) -&gt; impl Iterator&lt;Item = u8&gt; {
    struct RlEncode&lt;I: IntoIterator&lt;Item = u8&gt;&gt; {
        into_xs: Option&lt;I&gt;,
        xs: Option&lt;&lt;I as IntoIterator&gt;::IntoIter&gt;,
        cur: Option&lt;&lt;I as IntoIterator&gt;::Item&gt;,
        n: u8,
        yield_x: Option&lt;&lt;I as IntoIterator&gt;::Item&gt;,
    }
    impl&lt;I: IntoIterator&lt;Item = u8&gt;&gt; Iterator for RlEncode&lt;I&gt; {
        type Item = u8;
        fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
            let xs = self.xs.get_or_insert_with(|| unsafe {
                self.into_xs.take().unwrap_unchecked().into_iter()
            });
            if let Some(x) = self.yield_x.take() {
                return Some(x);
            }
            loop {
                match (xs.next(), self.cur) {
                    (Some(x), Some(cx))
                        if x == cx &amp;&amp; self.n &lt; u8::MAX =&gt; self.n += 1,
                    (Some(x), Some(cx)) =&gt; {
                        let n_ = self.n;
                        (self.cur, self.n) = (Some(x), 0);
                        self.yield_x = Some(cx);
                        return Some(n_);
                    }
                    (Some(x), None) =&gt; {
                        (self.cur, self.n) = (Some(x), 0);
                    }
                    (None, Some(cx)) =&gt; {
                        self.cur = None;
                        self.yield_x = Some(cx);
                        return Some(self.n);
                    }
                    (None, None) =&gt; return None,
                }
            }
        }
    }
    RlEncode {
        into_xs: Some(xs), xs: None, cur: None, n: 0, yield_x: None,
    }
}

// This example uses `iter::from_fn`.
fn rl_encode&lt;I: IntoIterator&lt;Item = u8&gt;&gt;(
    xs: I,
) -&gt; impl Iterator&lt;Item = u8&gt; {
    let (mut cur, mut n, mut yield_x) = (None, 0, None);
    let (mut into_xs, mut xs) = (Some(xs), None);
    core::iter::from_fn(move || loop {
        let xs = xs.get_or_insert_with(|| unsafe {
            into_xs.take().unwrap_unchecked().into_iter()
        });
        if let Some(x) = yield_x.take() {
            return Some(x);
        }
        match (xs.next(), cur) {
            (Some(x), Some(cx)) if x == cx &amp;&amp; n &lt; u8::MAX =&gt; n += 1,
            (Some(x), Some(cx)) =&gt; {
                let n_ = n;
                (cur, n) = (Some(x), 0);
                yield_x = Some(cx);
                return Some(n_);
            }
            (Some(x), None) =&gt; (cur, n) = (Some(x), 0),
            (None, Some(cx)) =&gt; {
                cur = None;
                yield_x = Some(cx);
                return Some(n);
            }
            (None, None) =&gt; return None,
        }
    })
}</code></pre>
<p>Iterators created with <code>gen</code> blocks return <code>None</code> from <code>next</code> once the <code>gen</code> block has returned (either implicitly at the end of the scope or explicitly with the <code>return</code> statement) and are fused (after <code>next</code> returns <code>None</code> once, it will keep returning <code>None</code> forever).</p>
<h2 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h2>
<h3 id="new-keyword"><a class="header" href="#new-keyword">New keyword</a></h3>
<p>Starting in the 2024 edition, <code>gen</code> is a keyword that cannot be used for naming any items or bindings.  This means during the migration to the 2024 edition, all variables, functions, modules, types, etc. named <code>gen</code> must be renamed or be referred to via <code>r#gen</code>.</p>
<h3 id="return-value"><a class="header" href="#return-value">Return value</a></h3>
<p><code>gen</code> blocks must diverge or return the unit type.  Specifically, the trailing expression must be of the unit or <code>!</code> type, and any <code>return</code> statements in the block must either be given no argument at all or given an argument of the unit or <code>!</code> type.</p>
<h4 id="diverging"><a class="header" href="#diverging">Diverging</a></h4>
<p>For example, a <code>gen</code> block that produces the infinite sequence <code>0, 1, 0, 1, 0, 1, ..</code> will never return <code>None</code> from <code>next</code> and will only drop its captured state when the iterator is dropped.  E.g.:</p>
<pre><code class="language-rust">gen {
    loop {
        yield 0;
        yield 1;
    }
}</code></pre>
<p>If a <code>gen</code> block panics, the behavior is similar to that of <code>return</code>, except that the call to <code>next</code> unwinds instead of returning <code>None</code>.</p>
<h3 id="error-handling"><a class="header" href="#error-handling">Error handling</a></h3>
<p>Within <code>gen</code> blocks, the <code>?</code> operator behaves as follows.  When its argument is a value indicating “do not short circuit” (e.g. <code>Option::Some(..)</code>, <code>Result::Ok(..)</code>, <code>ControlFlow::Continue(..)</code>), that value becomes the result of the expression as usual.  When its argument is a value indicating that short-circuiting is desired (e.g. <code>Option::None</code>, <code>Result::Err(..)</code>, <code>ControlFlow::Break(..)</code>), the value is first yielded (after being converted by <code>FromResidual::from_residual</code> as usual), then the block returns immediately.</p>
<p>Even when <code>?</code> is used within a <code>gen</code> block, the block must return a value of type unit or <code>!</code>.  That is, it does not return a value of <code>Some(..)</code>, <code>Ok(..)</code>, or <code>Continue(..)</code> as other such blocks might.</p>
<p>However, note that when <code>?</code> is used within a <code>gen</code> block, all <code>yield</code> statements will need to be given an argument of a compatible type.  For example, if <code>None?</code> is used in an expression, then all <code>yield</code> statements will need to be given arguments of some <code>Option</code> type (or of the <code>!</code> type) .</p>
<h3 id="fusing"><a class="header" href="#fusing">Fusing</a></h3>
<p>Iterators produced by <code>gen</code> return <code>None</code> from <code>next</code> repeatedly after having once returned <code>None</code> from <code>next</code>.  However, they do not implement <code>FusedIterator</code>, as that is not a language item, but may do so in the future (see the future possibilities).</p>
<h3 id="holding-borrows-across-yields"><a class="header" href="#holding-borrows-across-yields">Holding borrows across yields</a></h3>
<p>Since the <code>Iterator::next</code> method takes <code>&amp;mut self</code> instead of <code>Pin&lt;&amp;mut Self&gt;</code>, we cannot create self-referential <code>gen</code> blocks without taking other steps (see the open questions).  Self-referential <code>gen</code> blocks occur when holding a borrow to a local variable across a yield point.  E.g.:</p>
<pre><code class="language-rust">gen {
    let xs = vec![1, 2, 3, 4];
    for x in xs.iter() {
        yield x * 2;
    }
    //~^ ERROR borrow may still be in use when `gen` block yields
}</code></pre>
<p>This may in fact be a severe and surprising limitation, and whether we should take the steps necessary to address this before stabilization is left as an open question.</p>
<h2 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h2>
<h3 id="new-keyword-1"><a class="header" href="#new-keyword-1">New keyword</a></h3>
<p>In the 2024 edition we reserve <code>gen</code> as a keyword.  Rust 2021 will use <code>k#gen</code> to access the same feature.  What to do about earlier editions is left as an open question.</p>
<h3 id="error-handling-1"><a class="header" href="#error-handling-1">Error handling</a></h3>
<p><code>foo?</code> in <code>gen</code> blocks will stop iteration after the first error as if it desugared to:</p>
<pre><code class="language-rust">match foo.branch() {
    ControlFlow::Break(err) =&gt; {
        yield &lt;_ as FromResidual&gt;::from_residual(err);
        return
    },
    ControlFlow::Continue(val) =&gt; val,
}</code></pre>
<h3 id="implementation"><a class="header" href="#implementation">Implementation</a></h3>
<p>This feature is mostly implemented via existing coroutines, though there are some special cases.</p>
<p>We could say that <code>gen</code> blocks are the same as unstable coroutines…</p>
<ul>
<li>…without arguments,</li>
<li>…with an additional check forbidding holding borrows across <code>yield</code> points,</li>
<li>…with an automatic implementation of a trait allowing the type to be used in <code>for</code> loops (see the open questions),</li>
<li>…that do not panic if invoked again after returning.</li>
</ul>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p>The main drawback is that this adds a language feature for something that can already be written entirely (if more painfully) in user code.</p>
<p>In contrast to full coroutines (currently unstable), <code>gen</code> blocks cannot hold references across <code>yield</code> points (see the open questions, and see <a href="https://doc.rust-lang.org/1.77.0/core/iter/fn.from_coroutine.html"><code>from_coroutine</code></a> which has an <code>Unpin</code> bound on the generator it takes to produce an <code>Iterator</code>).</p>
<p>Reserving  the <code>gen</code> keyword will require some adaptation from the ecosystem mostly due to the <code>rand</code> crate which has <code>gen</code> methods on its traits.</p>
<h2 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h2>
<h3 id="keyword"><a class="header" href="#keyword">Keyword</a></h3>
<p>We could use <code>iter</code> as the keyword.</p>
<p>Due to unstable coroutines having originally been named “generators” within <code>rustc</code> and nightly Rust, some of the authors connect “generators” with this more powerful control flow construct that can do everything that <code>gen</code> blocks and <code>async</code> blocks can do and more.</p>
<p>There is some appeal in syntactically connecting the <code>Iterator</code> trait with <code>iter</code> blocks, but that would require us to carve out many exceptions for this keyword as <code>iter</code> is widely used for module names and method names, not just in the ecosystem, but also in <code>libstd</code> and <code>libcore</code>.  To what degree this might be worse than the situation for the <code>gen</code> keyword we leave as an open question.</p>
<p>Not using the <code>gen</code> keyword now would leave open the possibility of using the <code>gen</code> keyword in the future for a kind of block that might produce types that implement a more powerful <code>Generator</code> trait (perhaps one that takes <code>self</code> by pinned reference) or that implement <code>Coroutine</code>.</p>
<h3 id="do-not-do-this"><a class="header" href="#do-not-do-this">Do not do this</a></h3>
<h4 id="add-more-combinators"><a class="header" href="#add-more-combinators">Add more combinators</a></h4>
<p>One alternative is to instead add more helper methods to <code>Iterator</code>.</p>
<p>However, it is already difficult for new users of Rust to become familiar with all of the many existing methods on <code>Iterator</code>.  Further, some of the new methods we might want would need to be quite generic (similar to <a href="https://doc.rust-lang.org/1.77.0/std/primitive.array.html#method.try_map"><code>array::try_map</code></a>).</p>
<h4 id="use-crates"><a class="header" href="#use-crates">Use crates</a></h4>
<p>We could suggest that people use crates like <a href="https://crates.io/crates/genawaiter"><code>genawaiter</code></a>, <a href="https://crates.io/crates/propane"><code>propane</code></a>, or <a href="https://crates.io/crates/iterator_item"><code>iterator_item</code></a> instead.  <code>genawaiter</code> works on stable Rust and provides <code>gen!</code> macro blocks that behave like <code>gen</code> blocks, but it doesn’t have compiler support for nice diagnostics or language support for the <code>?</code> operator.  The <code>propane</code> and <code>iterator_item</code> crates use the <code>Coroutine</code> trait from nightly and work mostly like <code>gen</code> would (but therefore require unstable Rust).</p>
<h4 id="use-iterfrom_fn"><a class="header" href="#use-iterfrom_fn">Use <code>iter::from_fn</code></a></h4>
<p>The standard library includes <a href="https://doc.rust-lang.org/1.77.0/std/array/fn.from_fn.html"><code>std::iter::from_fn</code></a> which can be used in some cases, but as we saw in the <a href="#motivation">motivating example</a>, often the improvement over writing out a manual implementation of <code>Iterator</code> is limited.</p>
<h3 id="have-trailing-expressions-yield-one-last-element"><a class="header" href="#have-trailing-expressions-yield-one-last-element">Have trailing expressions yield one last element</a></h3>
<p>Trailing expressions could have a meaningful value that is yielded before terminating iteration.</p>
<p>However, if we were to do this, we would need to add some other way to immediately terminate iteration without yielding a value.  We could do something magical where returning <code>()</code> terminates the iteration, so that this code…</p>
<pre><code class="language-rust">fn foo() -&gt; impl Iterator&lt;Item = i32&gt; {
    gen { 42 }
}</code></pre>
<p>…could be a way to specify <code>std::iter::once(42)</code>.  However, then logically this code…</p>
<pre><code class="language-rust">fn foo() -&gt; impl Iterator&lt;Item = i32&gt; {
    gen { 42; } // Note the semicolon.
}</code></pre>
<p>…would then not return a value due to the semicolon.</p>
<p>Further, this would make it unclear what the behavior of this…</p>
<pre><code class="language-rust">fn foo() -&gt; impl Iterator&lt;Item = ()&gt; { gen {} }</code></pre>
<p>…should be, as it could reasonably be either <code>std::iter::once(())</code> or <code>std::iter::empty::&lt;()&gt;()</code>.</p>
<p>Note that, under this RFC, because <code>return</code> within <code>gen</code> blocks accepts an argument of type <code>()</code> and <code>yield</code> within <code>gen</code> blocks returns the <code>()</code> type, it is possible to yield one last element concisely with <code>return yield EXPR</code>.</p>
<h2 id="prior-art"><a class="header" href="#prior-art">Prior art</a></h2>
<h3 id="clu-alphard"><a class="header" href="#clu-alphard">CLU, Alphard</a></h3>
<p>The idea of generators that yield their values goes back at least as far as the Alphard language from circa 1975 (see <a href="https://web.archive.org/web/20150926014020/http://repository.cmu.edu/cgi/viewcontent.cgi?article=1868&amp;context=isr">“Alphard: Form and Content”</a>, Mary Shaw, 1981).  This was later refined into the idea of iterators in the CLU language (see <a href="https://web.archive.org/web/20030917041834/http://www.lcs.mit.edu/publications/pubs/pdf/MIT-LCS-TR-561.pdf">“A History of CLU”</a>, Barbara Liskov, 1992 and <a href="https://web.archive.org/web/20211105171453/https://pmg.csail.mit.edu/ftp.lcs.mit.edu/pub/pclu/CLU/3.Documents/MIT-LCS-TR-225.pdf">“CLU Reference Manual”</a>, Liskov et al., 1979).</p>
<p>The CLU language opened an iterator context with the <code>iter</code> keyword and produced values with <code>yield</code> statements.  E.g.:</p>
<pre><code>odds = iter () yields (int)
  x: int := 1
  while x &lt;= 20 do
    yield x
    x := x + 2
  end
end odds
</code></pre>
<h3 id="icon"><a class="header" href="#icon">Icon</a></h3>
<p>In <a href="https://web.archive.org/web/20230721102710/https://www2.cs.arizona.edu/icon/ftp/doc/lb1up.pdf">Icon</a> (introduced circa 1977), generators are woven deeply into the language, and any function can return a sequence of values.  When done explicitly, the <code>suspend</code> keyword is used.  E.g.:</p>
<pre><code>procedure range(i, j)
  while i &lt; j do {
    suspend i
    i +:= 1
  }
  fail
end
</code></pre>
<h3 id="python"><a class="header" href="#python">Python</a></h3>
<p>In Python, any function that contains a <code>yield</code> statement returns a generator.  E.g.:</p>
<pre><code class="language-python">def odd_dup(xs):
  for x in xs:
    if x % 2 == 1:
      yield x * 2
</code></pre>
<h3 id="ecmascript--javascript"><a class="header" href="#ecmascript--javascript">ECMAScript / JavaScript</a></h3>
<p>In JavaScript, <code>yield</code> can be used within <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*"><code>function*</code></a> generator functions.  E.g.:</p>
<pre><code class="language-javascript">function* oddDupUntilNegative(xs) {
  for (const x of xs) {
    if (x &lt; 0) {
      return;
    } else if (x % 2 == 1) {
      yield x * 2;
    }
  }
}
</code></pre>
<p>These generator functions are general coroutines.  <code>yield</code> forms an expression that returns the value passed to <code>next</code>.  E.g.:</p>
<pre><code class="language-javascript">function* dup(x) {
  while (true) {
    x = yield x * 2;
  }
}

const g = dup(2);
console.assert(g.next().value === 4);
console.assert(g.next(3).value === 6);
</code></pre>
<h3 id="ruby"><a class="header" href="#ruby">Ruby</a></h3>
<p>In Ruby, <code>yield</code> can be used with the <a href="https://ruby-doc.org/3.2.2/Enumerator.html"><code>Enumerator</code></a> class to implement an iterator.  E.g.:</p>
<pre><code class="language-ruby">def odd_dup_until_negative xs
  Enumerator.new do |y|
    xs.each do |x|
      if x &lt; 0
        return
      elsif x % 2 == 1
        y.yield x * 2
      end
    end
  end
end
</code></pre>
<p>Ruby also uses <code>yield</code> for a general coroutine mechanism with the <a href="https://ruby-doc.org/3.2.2/Fiber.html"><code>Fiber</code></a> class.  E.g.:</p>
<pre><code class="language-ruby">def dup
  Fiber.new do |x|
    while true
      x = Fiber.yield x * 2
    end
  end
end

g = dup
4 == (g.resume 2)
6 == (g.resume 3)
</code></pre>
<h3 id="kotlin"><a class="header" href="#kotlin">Kotlin</a></h3>
<p>In Kotlin, a lazy <a href="https://kotlinlang.org/docs/sequences.html#from-elements"><code>Sequence</code></a> can be built using <code>sequence</code> expressions and <code>yield</code>.  E.g.:</p>
<pre><code class="language-kotlin">fun oddDup(xs: Iterable&lt;Int&gt;): Sequence&lt;Int&gt; {
    return sequence {
        for (x in xs) {
            if (x % 2 == 1) {
                yield(x * 2);
            }
        }
    };
}

fun main() {
    for (x in oddDup(listOf(1, 2, 3, 4, 5))) {
        println(x);
    }
}
</code></pre>
<h3 id="swift"><a class="header" href="#swift">Swift</a></h3>
<p>In Swift, <a href="https://developer.apple.com/documentation/swift/asyncstream"><code>AsyncStream</code></a> is used with <code>yield</code> to produce asynchronous generators.  E.g.:</p>
<pre><code class="language-swift">import Foundation

let sequence = AsyncStream { k in
    for x in 0..&lt;20 {
        if x % 2 == 1 {
            k.yield(x * 2)
        }
    }
    k.finish()
}

let semaphore = DispatchSemaphore(value: 0)
Task {
    for await elem in sequence {
        print(elem)
    }
    semaphore.signal()
}
semaphore.wait()
</code></pre>
<p>Synchronous generators are not yet available in Swift, but <a href="https://forums.swift.org/t/is-it-possible-to-make-an-iterator-that-yelds/53995/7">may be</a> something they are planning.</p>
<h3 id="c"><a class="header" href="#c">C#</a></h3>
<p>In C#, within an <a href="https://learn.microsoft.com/en-us/dotnet/csharp/iterators"><code>iterator</code></a>, the <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/statements/yield"><code>yield</code></a> statement is used to either yield the next value or to stop iteration.  E.g.:</p>
<pre><code class="language-csharp">IEnumerable&lt;int&gt; OddDupUntilNegative(IEnumerable&lt;int&gt; xs)
{
    foreach (int x in xs)
    {
        if (x &lt; 0)
        {
            yield break;
        }
        else if (x % 2 == 1)
        {
            yield return x * 2;
        }
    }
}
</code></pre>
<p>Analogously with this RFC and with <code>async</code> blocks in Rust (but unlike <code>async Task</code> in C#), execution of C# iterators does not start until they are iterated.</p>
<h3 id="d"><a class="header" href="#d">D</a></h3>
<p>In D, <code>yield</code> is used when constructing a <a href="https://dlang.org/library/std/concurrency/generator.html"><code>Generator</code></a>.  E.g.:</p>
<pre><code class="language-dlang">import std.concurrency;
import std.stdio: writefln;

auto odd_dup(int[] xs) {
    return new Generator!int({
        foreach(x; xs) {
            if (x % 2 == 1) {
                yield(x * 2);
            }
        }
    });
}

void main() {
    auto xs = odd_dup([1, 2, 3, 4, 5]);
    foreach (x; xs) {
        writefln("%d", x);
    }
}
</code></pre>
<p>As in Ruby, generators in D are built on top of a more general <a href="https://dlang.org/library/core/thread/fiber/fiber.html"><code>Fiber</code></a> class that also uses <code>yield</code>.</p>
<h3 id="dart"><a class="header" href="#dart">Dart</a></h3>
<p>In Dart, there are both synchronous and asynchronous <a href="https://dart.dev/language/functions#generators">generator functions</a>.  Synchronous generator functions return an <code>Iteratable</code>.  E.g.:</p>
<pre><code class="language-dart">Iterable&lt;int&gt; oddDup(Iterable&lt;int&gt; xs) sync* {
    for (final x in xs) {
        if (x % 2 == 1) {
            yield x * 2;
        }
    }
}

void main() {
    oddDup(List&lt;int&gt;.generate(20, (x) =&gt; x + 1)).forEach(print);
}
</code></pre>
<p>Asynchronous generator functions return a <code>Stream</code> object.  E.g.:</p>
<pre><code class="language-dart">Stream&lt;int&gt; oddDup(Iterable&lt;int&gt; xs) async* {
    for (final x in xs) {
        if (x % 2 == 1) {
            yield x * 2;
        }
    }
}

void main() {
  oddDup(List&lt;int&gt;.generate(20, (x) =&gt; x + 1)).forEach(print);
}
</code></pre>
<h3 id="f"><a class="header" href="#f">F#</a></h3>
<p>In F#, generators can be expressed with <a href="https://learn.microsoft.com/en-us/dotnet/fsharp/language-reference/sequences">sequence expressions</a> using <code>yield</code>.  E.g.:</p>
<pre><code class="language-fsharp">let oddDup xs = seq {
  for x in xs do
    if x % 2 = 1 then
      yield x * 2 }

for x in oddDup (seq { 1 .. 20 }) do
  printfn "%d" x
</code></pre>
<h3 id="racket"><a class="header" href="#racket">Racket</a></h3>
<p>In Racket, generators can be built using <a href="https://docs.racket-lang.org/reference/Generators.html"><code>generator</code></a> and <code>yield</code>.  E.g.:</p>
<pre><code class="language-racket">#lang racket
(require racket/generator)

(define (odd-dup xs)
  (generator ()
    (for ([x xs])
      (when (odd? x)
        (yield (* 2 x))))))

(define g (odd-dup '(1 2 3 4 5)))
(= (g) 2)
(= (g) 6)
(= (g) 10)
</code></pre>
<p>Note that because of the expressive power of <a href="https://docs.racket-lang.org/reference/cont.html"><code>call/cc</code></a> (and continuations in general), generators can be written in Racket (and in other Scheme dialects) as a normal library.</p>
<h3 id="haskell-idris-clean-etc"><a class="header" href="#haskell-idris-clean-etc">Haskell, Idris, Clean, etc.</a></h3>
<p>In <a href="https://www.haskell.org/">Haskell</a> (and in similar languages such as <a href="https://www.idris-lang.org/">Idris</a>, <a href="https://wiki.clean.cs.ru.nl/Clean">Clean</a>, etc.), all functions are lazy unless specially annotated.  Consequently, Haskell does not need a special <code>yield</code> operator.  Any function can be a generator by recursively building a list of elements that will be lazily returned one at a time.  E.g.:</p>
<pre><code class="language-haskell">oddDup :: (Integral x) =&gt; [x] -&gt; [x]
oddDup [] = []
oddDup (x:xs)
  | odd x = x * 2 : oddDup xs
  | otherwise = oddDup xs

main :: IO ()
main = putStrLn $ show $ take 5 $ oddDup [1..20]
</code></pre>
<h3 id="koka"><a class="header" href="#koka">Koka</a></h3>
<p>The <a href="https://koka-lang.github.io/">Koka</a> language, by contrast, does not lean on laziness.  Instead, like Scheme, Koka provides powerful general control flow constructs from which generators, async, coroutines, and other such things fall out naturally.  Unlike Scheme, these powerful control flow constructs are <em>typed</em> and are called effect handlers.  E.g.:</p>
<pre><code class="language-koka">effect yield&lt;a&gt;
  fun yield(x : a) : ()

fun odd_dup(xs : list&lt;int&gt;) : yield&lt;int&gt; ()
  match xs
    Cons(x,xx) -&gt;
      if x % 2 == 1 then
        yield(x * 2)
      odd_dup(xx)
    Nil -&gt; ()

fun main() : console ()
  with fun yield(i : int)
    println(i.show)
  list(1,20).odd_dup
</code></pre>
<p>Note that there is no library being used here and that <code>yield</code> is not a keyword or feature of the language.  In Koka, the code above is all that is needed to express generators.</p>
<h3 id="rust"><a class="header" href="#rust">Rust</a></h3>
<p>In Rust, <code>async</code> blocks are built on top of the coroutine transformation.  Using a no-op <code>Waker</code>, it’s possible to expose this transformation.  With that, we can build generators.  Without the assistance of macros, the result looks like this:</p>
<pre><code class="language-rust">let odd_dup = |xs| {
    Gen::new(async move |mut y| {
        for x in xs {
            if x % 2 == 1 {
                y.r#yield(x * 2).await;
            }
        }
    })
};

let odd_dup = pin!(odd_dup(1u8..20));
let odd_dup = odd_dup.init();

for (i, x) in odd_dup.enumerate() {
    assert_eq!((i as u8 * 2 + 1) * 2, x);
}</code></pre>
<p>Crates such as <a href="https://crates.io/crates/genawaiter"><code>genawaiter</code></a> use this technique.</p>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<h3 id="whether-to-implement-iterator"><a class="header" href="#whether-to-implement-iterator">Whether to implement <code>Iterator</code></a></h3>
<p>There may be benefits to having the type returned by <code>gen</code> blocks <em>not</em> implement <code>Iterator</code> directly.  Instead, these blocks would return a type that implements either <code>IntoIterator</code> or a new <code>IntoGenerator</code> trait.  Such a design could leave us more appealing options for supporting self-referential <code>gen</code> blocks.  We leave this as an open question.</p>
<h3 id="self-referential-gen-blocks"><a class="header" href="#self-referential-gen-blocks">Self-referential <code>gen</code> blocks</a></h3>
<p>We can allow <code>gen</code> blocks to hold borrows across <code>yield</code> points.  Should this be part of the initial stabilization?</p>
<p>Here are some options for how we might do this, either before or after stabilization:</p>
<ul>
<li>Add a separate trait for pinned iteration that is also usable with <code>gen</code> and <code>for</code>.
<ul>
<li><em>Downside</em>: We would have very similar traits for the same thing.</li>
</ul>
</li>
<li>Backward compatibly add a way to change the argument type of <code>Iterator::next</code>.
<ul>
<li><em>Downside</em>: It’s unclear whether this is possible.</li>
</ul>
</li>
<li>Implement <code>Iterator</code> for <code>Pin&lt;&amp;mut G&gt;</code> instead of for <code>G</code> directly (for some type <code>G</code> that can be produced by <code>gen</code> blocks).
<ul>
<li><em>Downside</em>: The <code>next</code> method would take a double indirected reference of the form <code>&amp;mut Pin&lt;&amp;mut G&gt;</code> which may present challenges for optimization.</li>
</ul>
</li>
</ul>
<p>If we were to stabilize <code>gen</code> blocks that could not hold borrows across <code>yield</code> points, this would be a serious usability limitation that users might find surprising.  Consequently, whether we should choose to address this before stabilization is an open question.</p>
<h3 id="keyword-1"><a class="header" href="#keyword-1">Keyword</a></h3>
<p>Should we use <code>iter</code> as the keyword since we’re producing <code>Iterator</code>s?</p>
<p>Alternatively, we could use <code>gen</code> as proposed in this RFC and then later extend its abilities to include those of more powerful generators or coroutines, thereby justifying use of the more general name.</p>
<h3 id="contextual-keyword"><a class="header" href="#contextual-keyword">Contextual keyword</a></h3>
<p>Popular crates (like <code>rand</code>) have methods named <a href="https://docs.rs/rand/latest/rand/trait.Rng.html#method.gen"><code>gen</code></a>.  If we reserve <code>gen</code> as a full keyword, users of Rust 2024 and later editions would need to call these methods as <code>r#gen</code> until these crates update to make some accommodation.</p>
<p>We could instead choose to make <code>gen</code> a contextual keyword and only forbid it in:</p>
<ul>
<li>bindings</li>
<li>field names (due to destructuring bindings)</li>
<li>enum variants</li>
<li>type names</li>
</ul>
<h3 id="iteratorsize_hint"><a class="header" href="#iteratorsize_hint"><code>Iterator::size_hint</code></a></h3>
<p>Should we try to compute a conservative <code>size_hint</code>?</p>
<p>Doing this would reveal information from the body of a generator.  But, at least for simple cases, users would likely expect <code>size_hint</code> to not just be the default.</p>
<p>It is backward compatible to later add support for opportunistically implementing <code>size_hint</code>.</p>
<h3 id="implement-other-iterator-traits"><a class="header" href="#implement-other-iterator-traits">Implement other <code>Iterator</code> traits</a></h3>
<p>Might we later want to or be able to implement traits such as <code>DoubleEndedIterator</code>, <code>ExactSizeIterator</code>, etc.?</p>
<h3 id="what-to-do-about-rust-2015-and-rust-2018"><a class="header" href="#what-to-do-about-rust-2015-and-rust-2018">What to do about Rust 2015 and Rust 2018</a></h3>
<p>In <a href="https://github.com/rust-lang/rfcs/pull/3101">RFC 3101</a> we reserved prefixed identifiers such as <code>prefix#ident</code>.  For this reason, we can make <code>gen</code> blocks available in Rust 2021 using <code>k#gen</code> as was anticipated in the (currently pending) <a href="https://github.com/rust-lang/rfcs/pull/3098">RFC 3098</a>.</p>
<p>Whether and how to make this feature available in Rust 2015 and Rust 2018, however, we leave as an open question.</p>
<h2 id="future-possibilities"><a class="header" href="#future-possibilities">Future possibilities</a></h2>
<h3 id="yield-from-forwarding-operator"><a class="header" href="#yield-from-forwarding-operator"><code>yield from</code> (forwarding operator)</a></h3>
<p>Python has the ability to <code>yield from</code> an iterator.  Effectively this is syntactic sugar for looping over all elements of the iterator and yielding each individually.  There is a wide design space here, but some options are included in the following subsections.</p>
<h4 id="do-nothing-just-use-loops"><a class="header" href="#do-nothing-just-use-loops">Do nothing, just use loops</a></h4>
<p>Instead of adding special support for this, we could expect that users would write, e.g.:</p>
<pre><code class="language-rust">for x in iter {
    yield x
}</code></pre>
<h4 id="language-support"><a class="header" href="#language-support">Language support</a></h4>
<p>We could do something like postfix <code>yield</code>, e.g.:</p>
<pre><code class="language-rust">iter.yield</code></pre>
<p>Alternatively, we could use an entirely new keyword.</p>
<h4 id="stdlib-macro"><a class="header" href="#stdlib-macro">stdlib macro</a></h4>
<p>We could add a macro to the standard library and prelude.  The macro would expand to a <code>for</code> loop + <code>yield</code>.  E.g.:</p>
<pre><code class="language-rust">yield_all!(iter)</code></pre>
<h3 id="complete-coroutine-support"><a class="header" href="#complete-coroutine-support">Complete <code>Coroutine</code> support</a></h3>
<p>We have a <code>Coroutine</code> trait on nightly (previously called <code>Generator</code>) that is more powerful than the <code>Iterator</code> API could possibly be:</p>
<ol>
<li><code>resume</code> takes <code>Pin&lt;&amp;mut Self&gt;</code>, allowing self-references across yield points.</li>
<li><code>yield</code> returns the argument passed to <code>resume</code>.</li>
</ol>
<p>We could perhaps argue for coroutines to be <code>gen</code> closures while leaving <code>gen</code> blocks as a simpler concept.</p>
<p>There are many open questions here, so we leave this to future work.</p>
<h3 id="async-interactions"><a class="header" href="#async-interactions"><code>async</code> interactions</a></h3>
<p>We could support using <code>await</code> in <code>gen async</code> blocks in a similar way to how we support <code>?</code> being used within <code>gen</code> blocks.  Without a solution for self-referential generators, we’d have the limitation that these blocks could not hold references across <code>await</code> points.</p>
<p>The solution space here is large.  This RFC is forward compatible with the solutions we can foresee, so we leave this to later work.</p>
<h3 id="try-interactions"><a class="header" href="#try-interactions"><code>try</code> interactions</a></h3>
<p>We could allow <code>gen try fn foo() -&gt; i32</code> to mean something akin to <code>gen fn foo() -&gt; Result&lt;i32, E&gt;</code>.  Whatever we do here, it should mirror whatever <code>try fn</code> means in the future.</p>
<h3 id="gen-fn"><a class="header" href="#gen-fn"><code>gen fn</code></a></h3>
<p>This RFC does not introduce <code>gen fn</code>.  The syntax design space for this is large and there are open questions around the difference between returning or yielding a type.  The options currently known include, e.g.:</p>
<pre><code class="language-rust">fn foo(..) yield .. { .. }
fn foo(..) yields .. { .. }
fn foo(..) =&gt; .. { .. }
// Each of the below may instead be combined
// with `yield`, `yields`, or `=&gt;`.
fn* foo(..) -&gt; .. { .. }
gen fn foo(..) -&gt; .. { .. }
gen foo(..) -&gt; .. { .. }
generator fn foo(..) -&gt; .. { .. }</code></pre>
<h3 id="implement-fusediterator"><a class="header" href="#implement-fusediterator">Implement <code>FusedIterator</code></a></h3>
<p>The iterators produced by <code>gen</code> blocks are fused but do not implement <code>FusedIterator</code> because it is not a language item.  We may in the future want for these iterators to implement <code>FusedIterator</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="3509-prelude-2024-future.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="3514-float-semantics.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="3509-prelude-2024-future.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="3514-float-semantics.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
