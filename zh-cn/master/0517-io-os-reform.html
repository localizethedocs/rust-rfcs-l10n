<!DOCTYPE HTML>
<html lang="zh_CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0517-io-os-reform - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-b61d75f0.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2014-12-07</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/517">rust-lang/rfcs#517</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/21070">rust-lang/rust#21070</a></li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>This RFC proposes a significant redesign of the <code>std::io</code> and <code>std::os</code> modules in preparation for API stabilization. The specific problems addressed by the redesign are given in the <a href="#problems">Problems</a> section below, and the key ideas of the design are given in <a href="#vision-for-io">Vision for IO</a>.</p>
<h2 id="note-about-rfc-structure"><a class="header" href="#note-about-rfc-structure">Note about RFC structure</a></h2>
<p>This RFC was originally posted as a single monolithic file, which made it difficult to discuss different parts separately.</p>
<p>It has now been split into a skeleton that covers (1) the problem statement, (2) the overall vision and organization, and (3) the <code>std::os</code> module.</p>
<p>Other parts of the RFC are marked with <code>(stub)</code> and will be filed as follow-up PRs against this RFC.</p>
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of contents</a></h2>
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#table-of-contents">Table of contents</a></li>
<li><a href="#problems">Problems</a>
<ul>
<li><a href="#atomicity-and-the-readerwriter-traits">Atomicity and the <code>Reader</code>/<code>Writer</code> traits</a></li>
<li><a href="#timeouts">Timeouts</a></li>
<li><a href="#posix-and-libuv-bias">Posix and libuv bias</a></li>
<li><a href="#unicode">Unicode</a></li>
<li><a href="#stdio">stdio</a></li>
<li><a href="#overly-high-level-abstractions">Overly high-level abstractions</a></li>
<li><a href="#the-error-chaining-pattern">The error chaining pattern</a></li>
</ul>
</li>
<li><a href="#detailed-design">Detailed design</a>
<ul>
<li><a href="#vision-for-io">Vision for IO</a>
<ul>
<li><a href="#goals">Goals</a></li>
<li><a href="#design-principles">Design principles</a>
<ul>
<li><a href="#what-cross-platform-means">What cross-platform means</a></li>
<li><a href="#relation-to-the-system-level-apis">Relation to the system-level APIs</a></li>
<li><a href="#platform-specific-opt-in">Platform-specific opt-in</a></li>
</ul>
</li>
<li><a href="#proposed-organization">Proposed organization</a></li>
</ul>
</li>
<li><a href="#revising-reader-and-writer">Revising <code>Reader</code> and <code>Writer</code></a>
<ul>
<li><a href="#read">Read</a></li>
<li><a href="#write">Write</a></li>
</ul>
</li>
<li><a href="#string-handling">String handling</a>
<ul>
<li><a href="#key-observations">Key observations</a></li>
<li><a href="#the-design-os_str">The design: <code>os_str</code></a></li>
<li><a href="#the-future">The future</a></li>
</ul>
</li>
<li><a href="#deadlines">Deadlines</a> (stub)</li>
<li><a href="#splitting-streams-and-cancellation">Splitting streams and cancellation</a> (stub)</li>
<li><a href="#modules">Modules</a>
<ul>
<li><a href="#coreio">core::io</a>
<ul>
<li><a href="#adapters">Adapters</a></li>
<li><a href="#free-functions">Free functions</a></li>
<li><a href="#seeking">Seeking</a></li>
<li><a href="#buffering">Buffering</a></li>
<li><a href="#cursor">Cursor</a></li>
</ul>
</li>
<li><a href="#the-stdio-facade">The std::io facade</a>
<ul>
<li><a href="#error">Errors</a></li>
<li><a href="#channel-adapters">Channel adapters</a></li>
<li><a href="#stdin-stdout-stderr">stdin, stdout, stderr</a></li>
<li><a href="#printing-functions">Printing functions</a></li>
</ul>
</li>
<li><a href="#stdenv">std::env</a></li>
<li><a href="#stdfs">std::fs</a>
<ul>
<li><a href="#free-functions">Free functions</a></li>
<li><a href="#files">Files</a></li>
<li><a href="#file-kinds">File kinds</a></li>
<li><a href="#file-permissions">File permissions</a></li>
</ul>
</li>
<li><a href="#stdnet">std::net</a>
<ul>
<li><a href="#tcp">TCP</a></li>
<li><a href="#udp">UDP</a></li>
<li><a href="#addresses">Addresses</a></li>
</ul>
</li>
<li><a href="#stdprocess">std::process</a>
<ul>
<li><a href="#command">Command</a></li>
<li><a href="#child">Child</a></li>
</ul>
</li>
<li><a href="#stdos">std::os</a></li>
</ul>
</li>
<li><a href="#odds-and-ends">Odds and ends</a>
<ul>
<li><a href="#the-io-prelude">The io prelude</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#drawbacks">Drawbacks</a></li>
<li><a href="#alternatives">Alternatives</a></li>
<li><a href="#unresolved-questions">Unresolved questions</a></li>
</ul>
<h2 id="problems"><a class="header" href="#problems">Problems</a></h2>
<p>The <code>io</code> and <code>os</code> modules are the last large API surfaces of <code>std</code> that need to be stabilized. While the basic functionality offered in these modules is <em>largely</em> traditional, many problems with the APIs have emerged over time. The RFC discusses the most significant problems below.</p>
<p>This section only covers specific problems with the current library; see <a href="#vision-for-io">Vision for IO</a> for a higher-level view.  section.</p>
<h3 id="atomicity-and-the-readerwriter-traits"><a class="header" href="#atomicity-and-the-readerwriter-traits">Atomicity and the <code>Reader</code>/<code>Writer</code> traits</a></h3>
<p>One of the most pressing – but also most subtle – problems with <code>std::io</code> is the lack of <em>atomicity</em> in its <code>Reader</code> and <code>Writer</code> traits.</p>
<p>For example, the <code>Reader</code> trait offers a <code>read_to_end</code> method:</p>
<pre><code class="language-rust">fn read_to_end(&amp;mut self) -&gt; IoResult&lt;Vec&lt;u8&gt;&gt;</code></pre>
<p>Executing this method may involve many calls to the underlying <code>read</code> method. And it is possible that the first several calls succeed, and then a call returns an <code>Err</code> – which, like <code>TimedOut</code>, could represent a transient problem. Unfortunately, given the above signature, there is no choice but to simply <em>throw this data away</em>.</p>
<p>The <code>Writer</code> trait suffers from a more fundamental problem, since its primary method, <code>write</code>, may actually involve several calls to the underlying system – and if a failure occurs, there is no indication of how much was written.</p>
<p>Existing blocking APIs all have to deal with this problem, and Rust can and should follow the existing tradition here. See <a href="#revising-reader-and-writer">Revising <code>Reader</code> and <code>Writer</code></a> for the proposed solution.</p>
<h3 id="timeouts"><a class="header" href="#timeouts">Timeouts</a></h3>
<p>The <code>std::io</code> module supports “timeouts” on virtually all IO objects via a <code>set_timeout</code> method. In this design, every IO object (file, socket, etc.) has an optional timeout associated with it, and <code>set_timeout</code> mutates the associated timeout. All subsequent blocking operations are implicitly subject to this timeout.</p>
<p>This API choice suffers from two problems, one cosmetic and the other deeper:</p>
<ul>
<li>
<p>The “timeout” is <a href="https://github.com/rust-lang/rust/issues/15802">actually a <em>deadline</em></a> and should be named accordingly.</p>
</li>
<li>
<p>The stateful API has poor composability: when passing a mutable reference of an IO object to another function, it’s possible that the deadline has been changed. In other words, users of the API can easily interfere with each other by accident.</p>
</li>
</ul>
<p>See <a href="#deadlines">Deadlines</a> for the proposed solution.</p>
<h3 id="posix-and-libuv-bias"><a class="header" href="#posix-and-libuv-bias">Posix and libuv bias</a></h3>
<p>The current <code>io</code> and <code>os</code> modules were originally designed when <code>librustuv</code> was providing IO support, and to some extent they reflect the capabilities and conventions of <code>libuv</code> – which in turn are loosely based on Posix.</p>
<p>As such, the modules are not always ideal from a cross-platform standpoint, both in terms of forcing Windows programmings into a Posix mold, and also of offering APIs that are not actually usable on all platforms.</p>
<p>The modules have historically also provided <em>no</em> platform-specific APIs.</p>
<p>Part of the goal of this RFC is to set out a clear and extensible story for both cross-platform and platform-specific APIs in <code>std</code>. See <a href="#design-principles">Design principles</a> for the details.</p>
<h3 id="unicode"><a class="header" href="#unicode">Unicode</a></h3>
<p>Rust has followed the <a href="http://utf8everywhere.org/">utf8 everywhere</a> approach to its strings. However, at the borders to platform APIs, it is revealed that the world is not, in fact, UTF-8 (or even Unicode) everywhere.</p>
<p>Currently our story for platform APIs is that we either assume they can take or return Unicode strings (suitably encoded) or an uninterpreted byte sequence. Sadly, this approach does <em>not</em> actually cover all platform needs, and is also not highly ergonomic as presently implemented. (Consider <code>os::getenv</code> which introduces replacement characters (!) versus <code>os::getenv_as_bytes</code> which yields a <code>Vec&lt;u8&gt;</code>; neither is ideal.)</p>
<p>This topic was covered in some detail in the <a href="https://github.com/rust-lang/rfcs/pull/474">Path Reform RFC</a>, but this RFC gives a more general account in <a href="#string-handling">String handling</a>.</p>
<h3 id="stdio"><a class="header" href="#stdio"><code>stdio</code></a></h3>
<p>The <code>stdio</code> module provides access to readers/writers for <code>stdin</code>, <code>stdout</code> and <code>stderr</code>, which is essential functionality. However, it <em>also</em> provides a means of changing e.g. “stdout” – but there is no connection between these two! In particular, <code>set_stdout</code> affects only the writer that <code>println!</code> and friends use, while <code>set_stderr</code> affects <code>panic!</code>.</p>
<p>This module needs to be clarified. See <a href="#the-stdio-facade">The std::io facade</a> and [Functionality moved elsewhere] for the detailed design.</p>
<h3 id="overly-high-level-abstractions"><a class="header" href="#overly-high-level-abstractions">Overly high-level abstractions</a></h3>
<p>There are a few places where <code>io</code> provides high-level abstractions over system services without also providing more direct access to the service as-is. For example:</p>
<ul>
<li>
<p>The <code>Writer</code> trait’s <code>write</code> method – a cornerstone of IO – actually corresponds to an unbounded number of invocations of writes to the underlying IO object. This RFC changes <code>write</code> to follow more standard, lower-level practice; see <a href="#revising-reader-and-writer">Revising <code>Reader</code> and <code>Writer</code></a>.</p>
</li>
<li>
<p>Objects like <code>TcpStream</code> are <code>Clone</code>, which involves a fair amount of supporting infrastructure. This RFC tackles the problems that <code>Clone</code> was trying to solve more directly; see <a href="#splitting-streams-and-cancellation">Splitting streams and cancellation</a>.</p>
</li>
</ul>
<p>The motivation for going lower-level is described in <a href="#design-principles">Design principles</a> below.</p>
<h3 id="the-error-chaining-pattern"><a class="header" href="#the-error-chaining-pattern">The error chaining pattern</a></h3>
<p>The <code>std::io</code> module is somewhat unusual in that most of the functionality it proves are used through a few key traits (like <code>Reader</code>) and these traits are in turn “lifted” over <code>IoResult</code>:</p>
<pre><code class="language-rust">impl&lt;R: Reader&gt; Reader for IoResult&lt;R&gt; { ... }</code></pre>
<p>This lifting and others makes it possible to chain IO operations that might produce errors, without any explicit mention of error handling:</p>
<pre><code class="language-rust">File::open(some_path).read_to_end()
                      ^~~~~~~~~~~ can produce an error
      ^~~~ can produce an error</code></pre>
<p>The result of such a chain is either <code>Ok</code> of the outcome, or <code>Err</code> of the first error.</p>
<p>While this pattern is highly ergonomic, it does not fit particularly well into our evolving error story (<a href="https://github.com/rust-lang/rfcs/pull/201">interoperation</a> or <a href="https://github.com/rust-lang/rfcs/pull/243">try blocks</a>), and it is the only module in <code>std</code> to follow this pattern.</p>
<p>Eventually, we would like to write</p>
<pre><code class="language-rust">File::open(some_path)?.read_to_end()</code></pre>
<p>to take advantage of the <code>FromError</code> infrastructure, hook into error handling control flow, and to provide good chaining ergonomics throughout <em>all</em> Rust APIs -- all while keeping this handling a bit more explicit via the <code>?</code> operator. (See https://github.com/rust-lang/rfcs/pull/243 for the rough direction).</p>
<p>In the meantime, this RFC proposes to phase out the use of impls for <code>IoResult</code>. This will require use of <code>try!</code> for the time being.</p>
<p>(Note: this may put some additional pressure on at least landing the basic use of <code>?</code> instead of today’s <code>try!</code> before 1.0 final.)</p>
<h2 id="detailed-design"><a class="header" href="#detailed-design">Detailed design</a></h2>
<p>There’s a lot of material here, so the RFC starts with high-level goals, principles, and organization, and then works its way through the various modules involved.</p>
<h3 id="vision-for-io"><a class="header" href="#vision-for-io">Vision for IO</a></h3>
<p>Rust’s IO story had undergone significant evolution, starting from a <code>libuv</code>-style pure green-threaded model to a dual green/native model and now to a <a href="https://github.com/rust-lang/rfcs/pull/230">pure native model</a>. Given that history, it’s worthwhile to set out explicitly what is, and is not, in scope for <code>std::io</code></p>
<h4 id="goals"><a class="header" href="#goals">Goals</a></h4>
<p>For Rust 1.0, the aim is to:</p>
<ul>
<li>
<p>Provide a <em>blocking</em> API based directly on the services provided by the native OS for native threads.</p>
<p>These APIs should cover the basics (files, basic networking, basic process management, etc) and suffice to write servers following the classic Apache thread-per-connection model. They should impose essentially zero cost over the underlying OS services; the core APIs should map down to a single syscall unless more are needed for cross-platform compatibility.</p>
</li>
<li>
<p>Provide basic blocking abstractions and building blocks (various stream and buffer types and adapters) based on traditional blocking IO models but adapted to fit well within Rust.</p>
</li>
<li>
<p>Provide hooks for integrating with low-level and/or platform-specific APIs.</p>
</li>
<li>
<p>Ensure reasonable forwards-compatibility with future async IO models.</p>
</li>
</ul>
<p>It is explicitly <em>not</em> a goal at this time to support asynchronous programming models or nonblocking IO, nor is it a goal for the blocking APIs to eventually be used in a nonblocking “mode” or style.</p>
<p>Rather, the hope is that the basic abstractions of files, paths, sockets, and so on will eventually be usable directly within an async IO programming model and/or with nonblocking APIs. This is the case for most existing languages, which offer multiple interoperating IO models.</p>
<p>The <em>long term</em> intent is certainly to support async IO in some form, but doing so will require new research and experimentation.</p>
<h4 id="design-principles"><a class="header" href="#design-principles">Design principles</a></h4>
<p>Now that the scope has been clarified, it’s important to lay out some broad principles for the <code>io</code> and <code>os</code> modules. Many of these principles are already being followed to some extent, but this RFC makes them more explicit and applies them more uniformly.</p>
<h5 id="what-cross-platform-means"><a class="header" href="#what-cross-platform-means">What cross-platform means</a></h5>
<p>Historically, Rust’s <code>std</code> has always been “cross-platform”, but as discussed in <a href="#posix-and-libuv-bias">Posix and libuv bias</a> this hasn’t always played out perfectly. The proposed policy is below. <strong>With this policies, the APIs should largely feel like part of “Rust” rather than part of any legacy, and they should enable truly portable code</strong>.</p>
<p>Except for an explicit opt-in (see <a href="#platform-specific-opt-in">Platform-specific opt-in</a> below), all APIs in <code>std</code> should be cross-platform:</p>
<ul>
<li>
<p>The APIs should <strong>only expose a service or a configuration if it is supported on all platforms</strong>, and if the semantics on those platforms is or can be made loosely equivalent. (The latter requires exercising some judgment). Platform-specific functionality can be handled separately (<a href="#platform-specific-opt-in">Platform-specific opt-in</a>) and interoperate with normal <code>std</code> abstractions.</p>
<p>This policy rules out functions like <code>chown</code> which have a clear meaning on Unix and no clear interpretation on Windows; the ownership and permissions models are <em>very</em> different.</p>
</li>
<li>
<p>The APIs should <strong>follow Rust’s conventions</strong>, including their naming, which should be platform-neutral.</p>
<p>This policy rules out names like <code>fstat</code> that are the legacy of a particular platform family.</p>
</li>
<li>
<p>The APIs should <strong>never directly expose the representation</strong> of underlying platform types, even if they happen to coincide on the currently-supported platforms. Cross-platform types in <code>std</code> should be newtyped.</p>
<p>This policy rules out exposing e.g. error numbers directly as an integer type.</p>
</li>
</ul>
<p>The next subsection gives detail on what these APIs should look like in relation to system services.</p>
<h5 id="relation-to-the-system-level-apis"><a class="header" href="#relation-to-the-system-level-apis">Relation to the system-level APIs</a></h5>
<p>How should Rust APIs map into system services? This question breaks down along several axes which are in tension with one another:</p>
<ul>
<li>
<p><strong>Guarantees</strong>. The APIs provided in the mainline <code>io</code> modules should be predominantly safe, aside from the occasional <code>unsafe</code> function. In particular, the representation should be sufficiently hidden that most use cases are safe by construction. Beyond memory safety, though, the APIs should strive to provide a clear multithreaded semantics (using the <code>Send</code>/<code>Sync</code> kinds), and should use Rust’s type system to rule out various kinds of bugs when it is reasonably ergonomic to do so (following the usual Rust conventions).</p>
</li>
<li>
<p><strong>Ergonomics</strong>. The APIs should present a Rust view of things, making use of the trait system, newtypes, and so on to make system services fit well with the rest of Rust.</p>
</li>
<li>
<p><strong>Abstraction/cost</strong>. On the other hand, the abstractions introduced in <code>std</code> must not induce significant costs over the system services – or at least, there must be a way to safely access the services directly without incurring this penalty. When useful abstractions would impose an extra cost, they must be pay-as-you-go.</p>
</li>
</ul>
<p>Putting the above bullets together, <strong>the abstractions must be safe, and they should be as high-level as possible without imposing a tax</strong>.</p>
<ul>
<li><strong>Coverage</strong>. Finally, the <code>std</code> APIs should over time strive for full coverage of non-niche, cross-platform capabilities.</li>
</ul>
<h5 id="platform-specific-opt-in"><a class="header" href="#platform-specific-opt-in">Platform-specific opt-in</a></h5>
<p>Rust is a systems language, and as such it should expose seamless, no/low-cost access to system services. In many cases, however, this cannot be done in a cross-platform way, either because a given service is only available on some platforms, or because providing a cross-platform abstraction over it would be costly.</p>
<p>This RFC proposes <em>platform-specific opt-in</em>: submodules of <code>os</code> that are named by platform, and made available via <code>#[cfg]</code> switches. For example, <code>os::unix</code> can provide APIs only available on Unix systems, and <code>os::linux</code> can drill further down into Linux-only APIs. (You could even imagine subdividing by OS versions.) This is “opt-in” in the sense that, like the <code>unsafe</code> keyword, it is very easy to audit for potential platform-specificity: just search for <code>os::anyplatform</code>. Moreover, by separating out subsets like <code>linux</code>, it’s clear exactly how specific the platform dependency is.</p>
<p>The APIs in these submodules are intended to have the same flavor as other <code>io</code> APIs and should interoperate seamlessly with cross-platform types, but:</p>
<ul>
<li>
<p>They should be named according to the underlying system services when there is a close correspondence.</p>
</li>
<li>
<p>They may reveal the underlying OS type if there is nothing to be gained by hiding it behind an abstraction.</p>
</li>
</ul>
<p>For example, the <code>os::unix</code> module could provide a <code>stat</code> function that takes a standard <code>Path</code> and yields a custom struct. More interestingly, <code>os::linux</code> might include an <code>epoll</code> function that could operate <em>directly</em> on many <code>io</code> types (e.g. various socket types), without any explicit conversion to a file descriptor; that’s what “seamless” means.</p>
<p>Each of the platform modules will offer a custom <code>prelude</code> submodule, intended for glob import, that includes all of the extension traits applied to standard IO objects.</p>
<p>The precise design of these modules is in the very early stages and will likely remain <code>#[unstable]</code> for some time.</p>
<h4 id="proposed-organization"><a class="header" href="#proposed-organization">Proposed organization</a></h4>
<p>The <code>io</code> module is currently the biggest in <code>std</code>, with an entire hierarchy nested underneath; it mixes general abstractions/tools with specific IO objects. The <code>os</code> module is currently a bit of a dumping ground for facilities that don’t fit into the <code>io</code> category.</p>
<p>This RFC proposes the revamp the organization by flattening out the hierarchy and clarifying the role of each module:</p>
<pre><code>std
  env           environment manipulation
  fs            file system
  io            core io abstractions/adapters
    prelude     the io prelude
  net           networking
  os
    unix        platform-specific APIs
    linux         ..
    windows       ..
  os_str        platform-sensitive string handling
  process       process management
</code></pre>
<p>In particular:</p>
<ul>
<li>
<p>The contents of <code>os</code> will largely move to <code>env</code>, a new module for inspecting and updating the “environment” (including environment variables, CPU counts, arguments to <code>main</code>, and so on).</p>
</li>
<li>
<p>The <code>io</code> module will include things like <code>Reader</code> and <code>BufferedWriter</code> – cross-cutting abstractions that are needed throughout IO.</p>
<p>The <code>prelude</code> submodule will export all of the traits and most of the types for IO-related APIs; a single glob import should suffice to set you up for working with IO. (Note: this goes hand-in-hand with <em>removing</em> the bits of <code>io</code> currently in the prelude, as <a href="https://github.com/rust-lang/rfcs/pull/503">recently proposed</a>.)</p>
</li>
<li>
<p>The root <code>os</code> module is used purely to house the platform submodules discussed <a href="#platform-specific-opt-in">above</a>.</p>
</li>
<li>
<p>The <code>os_str</code> module is part of the solution to the Unicode problem; see <a href="#string-handling">String handling</a> below.</p>
</li>
<li>
<p>The <code>process</code> module over time will grow to include querying/manipulating already-running processes, not just spawning them.</p>
</li>
</ul>
<h3 id="revising-reader-and-writer"><a class="header" href="#revising-reader-and-writer">Revising <code>Reader</code> and <code>Writer</code></a></h3>
<p>The <code>Reader</code> and <code>Writer</code> traits are the backbone of IO, representing the ability to (respectively) pull bytes from and push bytes to an IO object. The core operations provided by these traits follows a very long tradition for blocking IO, but they are still surprisingly subtle -- and they need to be revised.</p>
<ul>
<li>
<p><strong>Atomicity and data loss</strong>. As discussed <a href="#atomicity-and-the-reader-writer-traits">above</a>, the <code>Reader</code> and <code>Writer</code> traits currently expose methods that involve multiple actual reads or writes, and data is lost when an error occurs after some (but not all) operations have completed.</p>
<p>The proposed strategy for <code>Reader</code> operations is to (1) separate out various deserialization methods into a distinct framework, (2) <em>never</em> have the internal <code>read</code> implementations loop on errors, (3) cut down on the number of non-atomic read operations and (4) adjust the remaining operations to provide more flexibility when possible.</p>
<p>For writers, the main change is to make <code>write</code> only perform a single underlying write (returning the number of bytes written on success), and provide a separate <code>write_all</code> method.</p>
</li>
<li>
<p><strong>Parsing/serialization</strong>. The <code>Reader</code> and <code>Writer</code> traits currently provide a large number of default methods for (de)serialization of various integer types to bytes with a given endianness. Unfortunately, these operations pose atomicity problems as well (e.g., a read could fail after reading two of the bytes needed for a <code>u32</code> value).</p>
<p>Rather than complicate the signatures of these methods, the (de)serialization infrastructure is removed entirely – in favor of instead eventually introducing a much richer parsing/formatting/(de)serialization framework that works seamlessly with <code>Reader</code> and <code>Writer</code>.</p>
<p>Such a framework is out of scope for this RFC, but the endian-sensitive functionality will be provided elsewhere (likely out of tree).</p>
</li>
</ul>
<p>With those general points out of the way, let’s look at the details.</p>
<h4 id="read"><a class="header" href="#read"><code>Read</code></a></h4>
<p>The updated <code>Reader</code> trait (and its extension) is as follows:</p>
<pre><code class="language-rust">trait Read {
    fn read(&amp;mut self, buf: &amp;mut [u8]) -&gt; Result&lt;usize, Error&gt;;

    fn read_to_end(&amp;mut self, buf: &amp;mut Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; { ... }
    fn read_to_string(&amp;self, buf: &amp;mut String) -&gt; Result&lt;(), Error&gt; { ... }
}

// extension trait needed for object safety
trait ReadExt: Read {
    fn bytes(&amp;mut self) -&gt; Bytes&lt;Self&gt; { ... }

    ... // more to come later in the RFC
}
impl&lt;R: Read&gt; ReadExt for R {}</code></pre>
<p>Following the <a href="https://github.com/rust-lang/rfcs/pull/344">trait naming conventions</a>, the trait is renamed to <code>Read</code> reflecting the clear primary method it provides.</p>
<p>The <code>read</code> method should not involve internal looping (even over errors like <code>EINTR</code>). It is intended to faithfully represent a single call to an underlying system API.</p>
<p>The <code>read_to_end</code> and <code>read_to_string</code> methods now take explicit buffers as input. This has multiple benefits:</p>
<ul>
<li>
<p>Performance. When it is known that reading will involve some large number of bytes, the buffer can be preallocated in advance.</p>
</li>
<li>
<p>“Atomicity” concerns. For <code>read_to_end</code>, it’s possible to use this API to retain data collected so far even when a <code>read</code> fails in the middle. For <code>read_to_string</code>, this is not the case, because UTF-8 validity cannot be ensured in such cases; but if intermediate results are wanted, one can use <code>read_to_end</code> and convert to a <code>String</code> only at the end.</p>
</li>
</ul>
<p>Convenience methods like these will retry on <code>EINTR</code>. This is partly under the assumption that in practice, EINTR will <em>most often</em> arise when interfacing with other code that changes a signal handler. Due to the global nature of these interactions, such a change can suddenly cause your own code to get an error irrelevant to it, and the code should probably just retry in those cases. In the case where you are using EINTR explicitly, <code>read</code> and <code>write</code> will be available to handle it (and you can always build your own abstractions on top).</p>
<h5 id="removed-methods"><a class="header" href="#removed-methods">Removed methods</a></h5>
<p>The proposed <code>Read</code> trait is much slimmer than today’s <code>Reader</code>. The vast majority of removed methods are parsing/deserialization, which were discussed above.</p>
<p>The remaining methods (<code>read_exact</code>, <code>read_at_least</code>, <code>push</code>, <code>push_at_least</code>) were removed for various reasons:</p>
<ul>
<li>
<p><code>read_exact</code>, <code>read_at_least</code>: these are somewhat more obscure conveniences that are not particularly robust due to lack of atomicity.</p>
</li>
<li>
<p><code>push</code>, <code>push_at_least</code>: these are special-cases for working with <code>Vec</code>, which this RFC proposes to replace with a more general mechanism described next.</p>
</li>
</ul>
<p>To provide some of this functionality in a more composition way, extend <code>Vec&lt;T&gt;</code> with an unsafe method:</p>
<pre><code class="language-rust">unsafe fn with_extra(&amp;mut self, n: uint) -&gt; &amp;mut [T];</code></pre>
<p>This method is equivalent to calling <code>reserve(n)</code> and then providing a slice to the memory starting just after <code>len()</code> entries. Using this method, clients of <code>Read</code> can easily recover the <code>push</code> method.</p>
<h4 id="write"><a class="header" href="#write"><code>Write</code></a></h4>
<p>The <code>Writer</code> trait is cut down to even smaller size:</p>
<pre><code class="language-rust">trait Write {
    fn write(&amp;mut self, buf: &amp;[u8]) -&gt; Result&lt;uint, Error&gt;;
    fn flush(&amp;mut self) -&gt; Result&lt;(), Error&gt;;

    fn write_all(&amp;mut self, buf: &amp;[u8]) -&gt; Result&lt;(), Error&gt; { .. }
    fn write_fmt(&amp;mut self, fmt: &amp;fmt::Arguments) -&gt; Result&lt;(), Error&gt; { .. }
}</code></pre>
<p>The biggest change here is to the semantics of <code>write</code>. Instead of repeatedly writing to the underlying IO object until all of <code>buf</code> is written, it attempts a <em>single</em> write and on success returns the number of bytes written. This follows the long tradition of blocking IO, and is a more fundamental building block than the looping write we currently have. Like <code>read</code>, it will propagate EINTR.</p>
<p>For convenience, <code>write_all</code> recovers the behavior of today’s <code>write</code>, looping until either the entire buffer is written or an error occurs. To meaningfully recover from an intermediate error and keep writing, code should work with <code>write</code> directly. Like the <code>Read</code> conveniences, <code>EINTR</code> results in a retry.</p>
<p>The <code>write_fmt</code> method, like <code>write_all</code>, will loop until its entire input is written or an error occurs.</p>
<p>The other methods include endian conversions (covered by serialization) and a few conveniences like <code>write_str</code> for other basic types. The latter, at least, is already uniformly (and extensibly) covered via the <code>write!</code> macro. The other helpers, as with <code>Read</code>, should migrate into a more general (de)serialization library.</p>
<h3 id="string-handling"><a class="header" href="#string-handling">String handling</a></h3>
<p>The fundamental problem with Rust’s full embrace of UTF-8 strings is that not all strings taken or returned by system APIs are Unicode, let alone UTF-8 encoded.</p>
<p>In the past, <code>std</code> has assumed that all strings are <em>either</em> in some form of Unicode (Windows), <em>or</em> are simply <code>u8</code> sequences (Unix). Unfortunately, this is wrong, and the situation is more subtle:</p>
<ul>
<li>
<p>Unix platforms do indeed work with arbitrary <code>u8</code> sequences (without interior nulls) and today’s platforms usually interpret them as UTF-8 when displayed.</p>
</li>
<li>
<p>Windows, however, works with <em>arbitrary <code>u16</code> sequences</em> that are roughly interpreted at UTF-16, but may not actually be valid UTF-16 – an “encoding” often called UCS-2; see http://justsolve.archiveteam.org/wiki/UCS-2 for a bit more detail.</p>
</li>
</ul>
<p>What this means is that all of Rust’s platforms go beyond Unicode, but they do so in different and incompatible ways.</p>
<p>The current solution of providing both <code>str</code> and <code>[u8]</code> versions of APIs is therefore problematic for multiple reasons. For one, <strong>the <code>[u8]</code> versions are not actually cross-platform</strong> – even today, they panic on Windows when given non-UTF-8 data, a platform-specific behavior. But they are also incomplete, because on Windows you should be able to work directly with UCS-2 data.</p>
<h4 id="key-observations"><a class="header" href="#key-observations">Key observations</a></h4>
<p>Fortunately, there is a solution that fits well with Rust’s UTF-8 strings <em>and</em> offers the possibility of platform-specific APIs.</p>
<p><strong>Observation 1</strong>: it is possible to re-encode UCS-2 data in a way that is also compatible with UTF-8. This is the <a href="http://simonsapin.github.io/wtf-8/">WTF-8 encoding format</a> proposed by Simon Sapin. This encoding has some remarkable properties:</p>
<ul>
<li>
<p>Valid UTF-8 data is valid WTF-8 data. When decoded to UCS-2, the result is exactly what would be produced by going straight from UTF-8 to UTF-16. In other words, making up some methods:</p>
<pre><code class="language-rust">my_ut8_data.to_wtf8().to_ucs2().as_u16_slice() == my_utf8_data.to_utf16().as_u16_slice()</code></pre>
</li>
<li>
<p>Valid UTF-16 data re-encoded as WTF-8 produces the corresponding UTF-8 data:</p>
<pre><code class="language-rust">my_utf16_data.to_wtf8().as_bytes() == my_utf16_data.to_utf8().as_bytes()</code></pre>
</li>
</ul>
<p>These two properties mean that, when working with Unicode data, the WTF-8 encoding is highly compatible with both UTF-8 <em>and</em> UTF-16. In particular, the conversion from a Rust string to a WTF-8 string is a no-op, and the conversion in the other direction is just a validation.</p>
<p><strong>Observation 2</strong>: all platforms can <em>consume</em> Unicode data (suitably re-encoded), and it’s also possible to validate the data they produce as Unicode and extract it.</p>
<p><strong>Observation 3</strong>: the non-Unicode spaces on various platforms are deeply incompatible: there is no standard way to port non-Unicode data from one to another. Therefore, the only cross-platform APIs are those that work entirely with Unicode.</p>
<h4 id="the-design-os_str"><a class="header" href="#the-design-os_str">The design: <code>os_str</code></a></h4>
<p>The observations above lead to a somewhat radical new treatment of strings, first proposed in the <a href="https://github.com/rust-lang/rfcs/pull/474">Path Reform RFC</a>. This RFC proposes to introduce new string and string slice types that (opaquely) represent <em>platform-sensitive strings</em>, housed in the <code>std::os_str</code> module.</p>
<p>The <code>OsString</code> type is analogous to <code>String</code>, and <code>OsStr</code> is analogous to <code>str</code>. Their backing implementation is platform-dependent, but they offer a cross-platform API:</p>
<pre><code class="language-rust">pub mod os_str {
    /// Owned OS strings
    struct OsString {
        inner: imp::Buf
    }
    /// Slices into OS strings
    struct OsStr {
        inner: imp::Slice
    }

    // Platform-specific implementation details:
    #[cfg(unix)]
    mod imp {
        type Buf = Vec&lt;u8&gt;;
        type Slice = [u8];
        ...
    }

    #[cfg(windows)]
    mod imp {
        type Buf = Wtf8Buf; // See https://github.com/SimonSapin/rust-wtf8
        type Slice = Wtf8;
        ...
    }

    impl OsString {
        pub fn from_string(String) -&gt; OsString;
        pub fn from_str(&amp;str) -&gt; OsString;
        pub fn as_slice(&amp;self) -&gt; &amp;OsStr;
        pub fn into_string(Self) -&gt; Result&lt;String, OsString&gt;;
        pub fn into_string_lossy(Self) -&gt; String;

        // and ultimately other functionality typically found on vectors,
        // but CRUCIALLY NOT as_bytes
    }

    impl Deref&lt;OsStr&gt; for OsString { ... }

    impl OsStr {
        pub fn from_str(value: &amp;str) -&gt; &amp;OsStr;
        pub fn as_str(&amp;self) -&gt; Option&lt;&amp;str&gt;;
        pub fn to_string_lossy(&amp;self) -&gt; CowString;

        // and ultimately other functionality typically found on slices,
        // but CRUCIALLY NOT as_bytes
    }

    trait IntoOsString {
        fn into_os_str_buf(self) -&gt; OsString;
    }

    impl IntoOsString for OsString { ... }
    impl&lt;'a&gt; IntoOsString for &amp;'a OsStr { ... }

    ...
}</code></pre>
<p>These APIs make OS strings appear roughly as opaque vectors (you cannot see the byte representation directly), and can always be produced starting from Unicode data. They make it possible to collapse functions like <code>getenv</code> and <code>getenv_as_bytes</code> into a single function that produces an OS string, allowing the client to decide how (or whether) to extract Unicode data. It will be possible to do things like concatenate OS strings without ever going through Unicode.</p>
<p>It will also likely be possible to do things like search for Unicode substrings. The exact details of the API are left open and are likely to grow over time.</p>
<p>In addition to APIs like the above, there will also be platform-specific ways of viewing or constructing OS strings that reveals more about the space of possible values:</p>
<pre><code class="language-rust">pub mod os {
    #[cfg(unix)]
    pub mod unix {
        trait OsStringExt {
            fn from_vec(Vec&lt;u8&gt;) -&gt; Self;
            fn into_vec(Self) -&gt; Vec&lt;u8&gt;;
        }

        impl OsStringExt for os_str::OsString { ... }

        trait OsStrExt {
            fn as_byte_slice(&amp;self) -&gt; &amp;[u8];
            fn from_byte_slice(&amp;[u8]) -&gt; &amp;Self;
        }

        impl OsStrExt for os_str::OsStr { ... }

        ...
    }

    #[cfg(windows)]
    pub mod windows{
        // The following extension traits provide a UCS-2 view of OS strings

        trait OsStringExt {
            fn from_wide_slice(&amp;[u16]) -&gt; Self;
        }

        impl OsStringExt for os_str::OsString { ... }

        trait OsStrExt {
            fn to_wide_vec(&amp;self) -&gt; Vec&lt;u16&gt;;
        }

        impl OsStrExt for os_str::OsStr { ... }

        ...
    }

    ...
}</code></pre>
<p>By placing these APIs under <code>os</code>, using them requires a clear <em>opt in</em> to platform-specific functionality.</p>
<h4 id="the-future"><a class="header" href="#the-future">The future</a></h4>
<p>Introducing an additional string type is a bit daunting, since many existing APIs take and consume only standard Rust strings. Today’s solution demands that strings coming from the OS be assumed or turned into Unicode, and the proposed API continues to allow that (with more explicit and finer-grained control).</p>
<p>In the long run, however, robust applications are likely to work opaquely with OS strings far beyond the boundary to the system to avoid data loss and ensure maximal compatibility. If this situation becomes common, it should be possible to introduce an abstraction over various string types and generalize most functions that work with <code>String</code>/<code>str</code> to instead work generically. This RFC does <em>not</em> propose taking any such steps now – but it’s important that we <em>can</em> do so later if Rust’s standard strings turn out to not be sufficient and OS strings become commonplace.</p>
<h3 id="deadlines"><a class="header" href="#deadlines">Deadlines</a></h3>
<blockquote>
<p>To be added in a follow-up PR.</p>
</blockquote>
<h3 id="splitting-streams-and-cancellation"><a class="header" href="#splitting-streams-and-cancellation">Splitting streams and cancellation</a></h3>
<blockquote>
<p>To be added in a follow-up PR.</p>
</blockquote>
<h3 id="modules"><a class="header" href="#modules">Modules</a></h3>
<p>Now that we’ve covered the core principles and techniques used throughout IO, we can go on to explore the modules in detail.</p>
<h4 id="coreio"><a class="header" href="#coreio"><code>core::io</code></a></h4>
<p>Ideally, the <code>io</code> module will be split into the parts that can live in <code>libcore</code> (most of it) and the parts that are added in the <code>std::io</code> facade. This part of the organization is non-normative, since it requires changes to today’s <code>IoError</code> (which currently references <code>String</code>); if these changes cannot be performed, everything here will live in <code>std::io</code>.</p>
<h5 id="adapters"><a class="header" href="#adapters">Adapters</a></h5>
<p>The current <code>std::io::util</code> module offers a number of <code>Reader</code> and <code>Writer</code> “adapters”. This RFC refactors the design to more closely follow <code>std::iter</code>. Along the way, it generalizes the <code>by_ref</code> adapter:</p>
<pre><code class="language-rust">trait ReadExt: Read {
    // ... eliding the methods already described above

    // Postfix version of `(&amp;mut self)`
    fn by_ref(&amp;mut self) -&gt; &amp;mut Self { ... }

    // Read everything from `self`, then read from `next`
    fn chain&lt;R: Read&gt;(self, next: R) -&gt; Chain&lt;Self, R&gt; { ... }

    // Adapt `self` to yield only the first `limit` bytes
    fn take(self, limit: u64) -&gt; Take&lt;Self&gt; { ... }

    // Whenever reading from `self`, push the bytes read to `out`
    #[unstable] // uncertain semantics of errors "halfway through the operation"
    fn tee&lt;W: Write&gt;(self, out: W) -&gt; Tee&lt;Self, W&gt; { ... }
}

trait WriteExt: Write {
    // Postfix version of `(&amp;mut self)`
    fn by_ref&lt;'a&gt;(&amp;'a mut self) -&gt; &amp;mut Self { ... }

    // Whenever bytes are written to `self`, write them to `other` as well
    #[unstable] // uncertain semantics of errors "halfway through the operation"
    fn broadcast&lt;W: Write&gt;(self, other: W) -&gt; Broadcast&lt;Self, W&gt; { ... }
}

// An adaptor converting an `Iterator&lt;u8&gt;` to `Read`.
pub struct IterReader&lt;T&gt; { ... }</code></pre>
<p>As with <code>std::iter</code>, these adapters are object unsafe and hence placed in an extension trait with a blanket <code>impl</code>.</p>
<h5 id="free-functions"><a class="header" href="#free-functions">Free functions</a></h5>
<p>The current <code>std::io::util</code> module also includes a number of primitive readers and writers, as well as <code>copy</code>. These are updated as follows:</p>
<pre><code class="language-rust">// A reader that yields no bytes
fn empty() -&gt; Empty; // in theory just returns `impl Read`

impl Read for Empty { ... }

// A reader that yields `byte` repeatedly (generalizes today's ZeroReader)
fn repeat(byte: u8) -&gt; Repeat;

impl Read for Repeat { ... }

// A writer that ignores the bytes written to it (/dev/null)
fn sink() -&gt; Sink;

impl Write for Sink { ... }

// Copies all data from a `Read` to a `Write`, returning the amount of data
// copied.
pub fn copy&lt;R, W&gt;(r: &amp;mut R, w: &amp;mut W) -&gt; Result&lt;u64, Error&gt;</code></pre>
<p>Like <code>write_all</code>, the <code>copy</code> method will discard the amount of data already written on any error and also discard any partially read data on a <code>write</code> error. This method is intended to be a convenience and <code>write</code> should be used directly if this is not desirable.</p>
<h5 id="seeking"><a class="header" href="#seeking">Seeking</a></h5>
<p>The seeking infrastructure is largely the same as today’s, except that <code>tell</code> is removed and the <code>seek</code> signature is refactored with more precise types:</p>
<pre><code class="language-rust">pub trait Seek {
    // returns the new position after seeking
    fn seek(&amp;mut self, pos: SeekFrom) -&gt; Result&lt;u64, Error&gt;;
}

pub enum SeekFrom {
    Start(u64),
    End(i64),
    Current(i64),
}</code></pre>
<p>The old <code>tell</code> function can be regained via <code>seek(SeekFrom::Current(0))</code>.</p>
<h5 id="buffering"><a class="header" href="#buffering">Buffering</a></h5>
<p>The current <code>Buffer</code> trait will be renamed to <code>BufRead</code> for clarity (and to open the door to <code>BufWrite</code> at some later point):</p>
<pre><code class="language-rust">pub trait BufRead: Read {
    fn fill_buf(&amp;mut self) -&gt; Result&lt;&amp;[u8], Error&gt;;
    fn consume(&amp;mut self, amt: uint);

    fn read_until(&amp;mut self, byte: u8, buf: &amp;mut Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; { ... }
    fn read_line(&amp;mut self, buf: &amp;mut String) -&gt; Result&lt;(), Error&gt; { ... }
}

pub trait BufReadExt: BufRead {
    // Split is an iterator over Result&lt;Vec&lt;u8&gt;, Error&gt;
    fn split(&amp;mut self, byte: u8) -&gt; Split&lt;Self&gt; { ... }

    // Lines is an iterator over Result&lt;String, Error&gt;
    fn lines(&amp;mut self) -&gt; Lines&lt;Self&gt; { ... };

    // Chars is an iterator over Result&lt;char, Error&gt;
    fn chars(&amp;mut self) -&gt; Chars&lt;Self&gt; { ... }
}</code></pre>
<p>The <code>read_until</code> and <code>read_line</code> methods are changed to take explicit, mutable buffers, for similar reasons to <code>read_to_end</code>. (Note that buffer reuse is particularly common for <code>read_line</code>). These functions include the delimiters in the strings they produce, both for easy cross-platform compatibility (in the case of <code>read_line</code>) and for ease in copying data without loss (in particular, distinguishing whether the last line included a final delimiter).</p>
<p>The <code>split</code> and <code>lines</code> methods provide iterator-based versions of <code>read_until</code> and <code>read_line</code>, and <em>do not</em> include the delimiter in their output. This matches conventions elsewhere (like <code>split</code> on strings) and is usually what you want when working with iterators.</p>
<p>The <code>BufReader</code>, <code>BufWriter</code> and <code>BufStream</code> types stay essentially as they are today, except that for streams and writers the <code>into_inner</code> method yields the structure back in the case of a write error, and its behavior is clarified to writing out the buffered data without flushing the underlying reader:</p>
<pre><code class="language-rust">// If writing fails, you get the unwritten data back
fn into_inner(self) -&gt; Result&lt;W, IntoInnerError&lt;Self&gt;&gt;;

pub struct IntoInnerError&lt;W&gt;(W, Error);

impl IntoInnerError&lt;T&gt; {
    pub fn error(&amp;self) -&gt; &amp;Error { ... }
    pub fn into_inner(self) -&gt; W { ... }
}
impl&lt;W&gt; FromError&lt;IntoInnerError&lt;W&gt;&gt; for Error { ... }</code></pre>
<h5 id="cursor"><a class="header" href="#cursor"><code>Cursor</code></a></h5>
<p>Many applications want to view in-memory data as either an implementor of <code>Read</code> or <code>Write</code>. This is often useful when composing streams or creating test cases. This functionality primarily comes from the following implementations:</p>
<pre><code class="language-rust">impl&lt;'a&gt; Read for &amp;'a [u8] { ... }
impl&lt;'a&gt; Write for &amp;'a mut [u8] { ... }
impl Write for Vec&lt;u8&gt; { ... }</code></pre>
<p>While efficient, none of these implementations support seeking (via an implementation of the <code>Seek</code> trait). The implementations of <code>Read</code> and <code>Write</code> for these types is not quite as efficient when <code>Seek</code> needs to be used, so the <code>Seek</code>-ability will be opted-in to with a new <code>Cursor</code> structure with the following API:</p>
<pre><code class="language-rust">pub struct Cursor&lt;T&gt; {
    pos: u64,
    inner: T,
}
impl&lt;T&gt; Cursor&lt;T&gt; {
    pub fn new(inner: T) -&gt; Cursor&lt;T&gt;;
    pub fn into_inner(self) -&gt; T;
    pub fn get_ref(&amp;self) -&gt; &amp;T;
}

// Error indicating that a negative offset was seeked to.
pub struct NegativeOffset;

impl Seek for Cursor&lt;Vec&lt;u8&gt;&gt; { ... }
impl&lt;'a&gt; Seek for Cursor&lt;&amp;'a [u8]&gt; { ... }
impl&lt;'a&gt; Seek for Cursor&lt;&amp;'a mut [u8]&gt; { ... }

impl Read for Cursor&lt;Vec&lt;u8&gt;&gt; { ... }
impl&lt;'a&gt; Read for Cursor&lt;&amp;'a [u8]&gt; { ... }
impl&lt;'a&gt; Read for Cursor&lt;&amp;'a mut [u8]&gt; { ... }

impl BufRead for Cursor&lt;Vec&lt;u8&gt;&gt; { ... }
impl&lt;'a&gt; BufRead for Cursor&lt;&amp;'a [u8]&gt; { ... }
impl&lt;'a&gt; BufRead for Cursor&lt;&amp;'a mut [u8]&gt; { ... }

impl&lt;'a&gt; Write for Cursor&lt;&amp;'a mut [u8]&gt; { ... }
impl Write for Cursor&lt;Vec&lt;u8&gt;&gt; { ... }</code></pre>
<p>A sample implementation can be found in <a href="https://gist.github.com/alexcrichton/8224f57ed029929447bd">a gist</a>. Using one <code>Cursor</code> structure allows to emphasize that the only ability added is an implementation of <code>Seek</code> while still allowing all possible I/O operations for various types of buffers.</p>
<p>It is not currently proposed to unify these implementations via a trait. For example a <code>Cursor&lt;Rc&lt;[u8]&gt;&gt;</code> is a reasonable instance to have, but it will not have an implementation listed in the standard library to start out. It is considered a backwards-compatible addition to unify these various <code>impl</code> blocks with a trait.</p>
<p>The following types will be removed from the standard library and replaced as follows:</p>
<ul>
<li><code>MemReader</code> -&gt; <code>Cursor&lt;Vec&lt;u8&gt;&gt;</code></li>
<li><code>MemWriter</code> -&gt; <code>Cursor&lt;Vec&lt;u8&gt;&gt;</code></li>
<li><code>BufReader</code> -&gt; <code>Cursor&lt;&amp;[u8]&gt;</code> or <code>Cursor&lt;&amp;mut [u8]&gt;</code></li>
<li><code>BufWriter</code> -&gt; <code>Cursor&lt;&amp;mut [u8]&gt;</code></li>
</ul>
<h4 id="the-stdio-facade"><a class="header" href="#the-stdio-facade">The <code>std::io</code> facade</a></h4>
<p>The <code>std::io</code> module will largely be a facade over <code>core::io</code>, but it will add some functionality that can live only in <code>std</code>.</p>
<h5 id="errors"><a class="header" href="#errors"><code>Errors</code></a></h5>
<p>The <code>IoError</code> type will be renamed to <code>std::io::Error</code>, following our <a href="https://github.com/rust-lang/rfcs/pull/356">non-prefixing convention</a>. It will remain largely as it is today, but its fields will be made private. It may eventually grow a field to track the underlying OS error code.</p>
<p>The <code>std::io::IoErrorKind</code> type will become <code>std::io::ErrorKind</code>, and <code>ShortWrite</code> will be dropped (it is no longer needed with the new <code>Write</code> semantics), which should decrease its footprint. The <code>OtherIoError</code> variant will become <code>Other</code> now that <code>enum</code>s are namespaced. Other variants may be added over time, such as <code>Interrupted</code>, as more errors are classified from the system.</p>
<p>The <code>EndOfFile</code> variant will be removed in favor of returning <code>Ok(0)</code> from <code>read</code> on end of file (or <code>write</code> on an empty slice for example). This approach clarifies the meaning of the return value of <code>read</code>, matches Posix APIs, and makes it easier to use <code>try!</code> in the case that a “real” error should be bubbled out. (The main downside is that higher-level operations that might use <code>Result&lt;T, IoError&gt;</code> with some <code>T != usize</code> may need to wrap <code>IoError</code> in a further enum if they wish to forward unexpected EOF.)</p>
<h5 id="channel-adapters"><a class="header" href="#channel-adapters">Channel adapters</a></h5>
<p>The <code>ChanReader</code> and <code>ChanWriter</code> adapters will be left as they are today, and they will remain <code>#[unstable]</code>. The channel adapters currently suffer from a few problems today, some of which are inherent to the design:</p>
<ul>
<li>Construction is somewhat unergonomic. First a <code>mpsc</code> channel pair must be created and then each half of the reader/writer needs to be created.</li>
<li>Each call to <code>write</code> involves moving memory onto the heap to be sent, which isn’t necessarily efficient.</li>
<li>The design of <code>std::sync::mpsc</code> allows for growing more channels in the future, but it’s unclear if we’ll want to continue to provide a reader/writer adapter for each channel we add to <code>std::sync</code>.</li>
</ul>
<p>These types generally feel as if they’re from a different era of Rust (which they are!) and may take some time to fit into the current standard library. They can be reconsidered for stabilization after the dust settles from the I/O redesign as well as the recent <code>std::sync</code> redesign. At this time, however, this RFC recommends they remain unstable.</p>
<h5 id="stdin-stdout-stderr"><a class="header" href="#stdin-stdout-stderr"><code>stdin</code>, <code>stdout</code>, <code>stderr</code></a></h5>
<p>The current <code>stdio</code> module will be removed in favor of these constructors in the <code>io</code> module:</p>
<pre><code class="language-rust">pub fn stdin() -&gt; Stdin;
pub fn stdout() -&gt; Stdout;
pub fn stderr() -&gt; Stderr;</code></pre>
<ul>
<li>
<p><code>stdin</code> - returns a handle to a <strong>globally shared</strong> standard input of the process which is buffered as well. Due to the globally shared nature of this handle, all operations on <code>Stdin</code> directly will acquire a lock internally to ensure access to the shared buffer is synchronized. This implementation detail is also exposed through a <code>lock</code> method where the handle can be explicitly locked for a period of time so relocking is not necessary.</p>
<p>The <code>Read</code> trait will be implemented directly on the returned <code>Stdin</code> handle but the <code>BufRead</code> trait will not be (due to synchronization concerns). The locked version of <code>Stdin</code> (<code>StdinLock</code>) will provide an implementation of <code>BufRead</code>.</p>
<p>The design will largely be the same as is today with the <code>old_io</code> module.</p>
<pre><code class="language-rust">impl Stdin {
    fn lock(&amp;self) -&gt; StdinLock;
    fn read_line(&amp;mut self, into: &amp;mut String) -&gt; io::Result&lt;()&gt;;
    fn read_until(&amp;mut self, byte: u8, into: &amp;mut Vec&lt;u8&gt;) -&gt; io::Result&lt;()&gt;;
}
impl Read for Stdin { ... }
impl Read for StdinLock { ... }
impl BufRead for StdinLock { ... }</code></pre>
</li>
<li>
<p><code>stderr</code> - returns a <strong>non buffered</strong> handle to the standard error output stream for the process. Each call to <code>write</code> will roughly translate to a system call to output data when written to <code>stderr</code>. This handle is locked like <code>stdin</code> to ensure, for example, that calls to <code>write_all</code> are atomic with respect to one another. There will also be an RAII guard to lock the handle and use the result as an instance of <code>Write</code>.</p>
<pre><code class="language-rust">impl Stderr {
    fn lock(&amp;self) -&gt; StderrLock;
}
impl Write for Stderr { ... }
impl Write for StderrLock { ... }</code></pre>
</li>
<li>
<p><code>stdout</code> - returns a <strong>globally buffered</strong> handle to the standard output of the current process. The amount of buffering can be decided at runtime to allow for different situations such as being attached to a TTY or being redirected to an output file. The <code>Write</code> trait will be implemented for this handle, and like <code>stderr</code> it will be possible to lock it and then use the result as an instance of <code>Write</code> as well.</p>
<pre><code class="language-rust">impl Stdout {
    fn lock(&amp;self) -&gt; StdoutLock;
}
impl Write for Stdout { ... }
impl Write for StdoutLock { ... }</code></pre>
</li>
</ul>
<h5 id="windows-and-stdio"><a class="header" href="#windows-and-stdio">Windows and stdio</a></h5>
<p>On Windows, standard input and output handles can work with either arbitrary <code>[u8]</code> or <code>[u16]</code> depending on the state at runtime. For example a program attached to the console will work with arbitrary <code>[u16]</code>, but a program attached to a pipe would work with arbitrary <code>[u8]</code>.</p>
<p>To handle this difference, the following behavior will be enforced for the standard primitives listed above:</p>
<ul>
<li>
<p>If attached to a pipe then no attempts at encoding or decoding will be done, the data will be ferried through as <code>[u8]</code>.</p>
</li>
<li>
<p>If attached to a console, then <code>stdin</code> will attempt to interpret all input as UTF-16, re-encoding into UTF-8 and returning the UTF-8 data instead. This implies that data will be buffered internally to handle partial reads/writes. Invalid UTF-16 will simply be discarded returning an <code>io::Error</code> explaining why.</p>
</li>
<li>
<p>If attached to a console, then <code>stdout</code> and <code>stderr</code> will attempt to interpret input as UTF-8, re-encoding to UTF-16. If the input is not valid UTF-8 then an error will be returned and no data will be written.</p>
</li>
</ul>
<h5 id="raw-stdio"><a class="header" href="#raw-stdio">Raw stdio</a></h5>
<blockquote>
<p><strong>Note</strong>: This section is intended to be a sketch of possible raw stdio support, but it is not planned to implement or stabilize this implementation at this time.</p>
</blockquote>
<p>The above standard input/output handles all involve some form of locking or buffering (or both). This cost is not always wanted, and hence raw variants will be provided. Due to platform differences across unix/windows, the following structure will be supported:</p>
<pre><code class="language-rust">mod os {
    mod unix {
        mod stdio {
            struct Stdio { .. }

            impl Stdio {
                fn stdout() -&gt; Stdio;
                fn stderr() -&gt; Stdio;
                fn stdin() -&gt; Stdio;
            }

            impl Read for Stdio { ... }
            impl Write for Stdio { ... }
        }
    }

    mod windows {
        mod stdio {
            struct Stdio { ... }
            struct StdioConsole { ... }

            impl Stdio {
                fn stdout() -&gt; io::Result&lt;Stdio&gt;;
                fn stderr() -&gt; io::Result&lt;Stdio&gt;;
                fn stdin() -&gt; io::Result&lt;Stdio&gt;;
            }
            // same constructors StdioConsole

            impl Read for Stdio { ... }
            impl Write for Stdio { ... }

            impl StdioConsole {
                // returns slice of what was read
                fn read&lt;'a&gt;(&amp;self, buf: &amp;'a mut OsString) -&gt; io::Result&lt;&amp;'a OsStr&gt;;
                // returns remaining part of `buf` to be written
                fn write&lt;'a&gt;(&amp;self, buf: &amp;'a OsStr) -&gt; io::Result&lt;&amp;'a OsStr&gt;;
            }
        }
    }
}</code></pre>
<p>There are some key differences from today’s API:</p>
<ul>
<li>On unix, the API has not changed much except that the handles have been consolidated into one type which implements both <code>Read</code> and <code>Write</code> (although writing to stdin is likely to generate an error).</li>
<li>On windows, there are two sets of handles representing the difference between “console mode” and not (e.g. a pipe). When not a console the normal I/O traits are implemented (delegating to <code>ReadFile</code> and <code>WriteFile</code>. The console mode operations work with <code>OsStr</code>, however, to show how they work with UCS-2 under the hood.</li>
</ul>
<h5 id="printing-functions"><a class="header" href="#printing-functions">Printing functions</a></h5>
<p>The current <code>print</code>, <code>println</code>, <code>print_args</code>, and <code>println_args</code> functions will all be “removed from the public interface” by <a href="https://github.com/rust-lang/rust/issues/22607">prefixing them with <code>__</code> and marking <code>#[doc(hidden)]</code></a>. These are all implementation details of the <code>print!</code> and <code>println!</code> macros and don’t need to be exposed in the public interface.</p>
<p>The <code>set_stdout</code> and <code>set_stderr</code> functions will be removed with no replacement for now. It’s unclear whether these functions should indeed control a thread local handle instead of a global handle as whether they’re justified in the first place. It is a backwards-compatible extension to allow this sort of output to be redirected and can be considered if the need arises.</p>
<h4 id="stdenv"><a class="header" href="#stdenv"><code>std::env</code></a></h4>
<p>Most of what’s available in <code>std::os</code> today will move to <code>std::env</code>, and the signatures will be updated to follow this RFC’s <a href="#design-principles">Design principles</a> as follows.</p>
<p><strong>Arguments</strong>:</p>
<ul>
<li><code>args</code>: change to yield an iterator rather than vector if possible; in any case, it should produce an <code>OsString</code>.</li>
</ul>
<p><strong>Environment variables</strong>:</p>
<ul>
<li>
<p><code>vars</code> (renamed from <code>env</code>): yields a vector of <code>(OsString, OsString)</code> pairs.</p>
</li>
<li>
<p><code>var</code> (renamed from <code>getenv</code>): take a value bounded by <code>AsOsStr</code>, allowing Rust strings and slices to be ergonomically passed in. Yields an <code>Option&lt;OsString&gt;</code>.</p>
</li>
<li>
<p><code>var_string</code>: take a value bounded by <code>AsOsStr</code>, returning <code>Result&lt;String, VarError&gt;</code> where <code>VarError</code> represents a non-unicode <code>OsString</code> or a “not present” value.</p>
</li>
<li>
<p><code>set_var</code> (renamed from <code>setenv</code>): takes two <code>AsOsStr</code>-bounded values.</p>
</li>
<li>
<p><code>remove_var</code> (renamed from <code>unsetenv</code>): takes a <code>AsOsStr</code>-bounded value.</p>
</li>
<li>
<p><code>join_paths</code>: take an <code>IntoIterator&lt;T&gt;</code> where <code>T: AsOsStr</code>, yield a <code>Result&lt;OsString, JoinPathsError&gt;</code>.</p>
</li>
<li>
<p><code>split_paths</code> take a <code>AsOsStr</code>, yield an <code>Iterator&lt;Path&gt;</code>.</p>
</li>
</ul>
<p><strong>Working directory</strong>:</p>
<ul>
<li><code>current_dir</code> (renamed from <code>getcwd</code>): yields a <code>PathBuf</code>.</li>
<li><code>set_current_dir</code> (renamed from <code>change_dir</code>): takes an <code>AsPath</code> value.</li>
</ul>
<p><strong>Important locations</strong>:</p>
<ul>
<li><code>home_dir</code> (renamed from <code>homedir</code>): returns home directory as a <code>PathBuf</code></li>
<li><code>temp_dir</code> (renamed from <code>tmpdir</code>): returns a temporary directly as a <code>PathBuf</code></li>
<li><code>current_exe</code> (renamed from <code>self_exe_name</code>): returns the full path to the current binary as a <code>PathBuf</code> in an <code>io::Result</code> instead of an <code>Option</code>.</li>
</ul>
<p><strong>Exit status</strong>:</p>
<ul>
<li><code>get_exit_status</code> and <code>set_exit_status</code> stay as they are, but with updated docs that reflect that these only affect the return value of <code>std::rt::start</code>. These will remain <code>#[unstable]</code> for now and a future RFC will determine their stability.</li>
</ul>
<p><strong>Architecture information</strong>:</p>
<ul>
<li><code>num_cpus</code>, <code>page_size</code>: stay as they are, but remain <code>#[unstable]</code>. A future RFC will determine their stability and semantics.</li>
</ul>
<p><strong>Constants</strong>:</p>
<ul>
<li>Stabilize <code>ARCH</code>, <code>DLL_PREFIX</code>, <code>DLL_EXTENSION</code>, <code>DLL_SUFFIX</code>, <code>EXE_EXTENSION</code>, <code>EXE_SUFFIX</code>, <code>FAMILY</code> as they are.</li>
<li>Rename <code>SYSNAME</code> to <code>OS</code>.</li>
<li>Remove <code>TMPBUF_SZ</code>.</li>
</ul>
<p>This brings the constants into line with our naming conventions elsewhere.</p>
<h5 id="items-to-move-to-osplatform"><a class="header" href="#items-to-move-to-osplatform">Items to move to <code>os::platform</code></a></h5>
<ul>
<li><code>pipe</code> will move to <code>os::unix</code>. It is currently primarily used for hooking to the IO of a child process, which will now be done behind a trait object abstraction.</li>
</ul>
<h5 id="removed-items"><a class="header" href="#removed-items">Removed items</a></h5>
<ul>
<li><code>errno</code>, <code>error_string</code> and <code>last_os_error</code> provide redundant, platform-specific functionality and will be removed for now. They may reappear later in <code>os::unix</code> and <code>os::windows</code> in a modified form.</li>
<li><code>dll_filename</code>: deprecated in favor of working directly with the constants.</li>
<li><code>_NSGetArgc</code>, <code>_NSGetArgv</code>: these should never have been public.</li>
<li><code>self_exe_path</code>: deprecated in favor of <code>current_exe</code> plus path operations.</li>
<li><code>make_absolute</code>: deprecated in favor of explicitly joining with the working directory.</li>
<li>all <code>_as_bytes</code> variants: deprecated in favor of yielding <code>OsString</code> values</li>
</ul>
<h4 id="stdfs"><a class="header" href="#stdfs"><code>std::fs</code></a></h4>
<p>The <code>fs</code> module will provide most of the functionality it does today, but with a stronger cross-platform orientation.</p>
<p>Note that all path-consuming functions will now take an <code>AsPath</code>-bounded parameter for ergonomic reasons (this will allow passing in Rust strings and literals directly, for example).</p>
<h5 id="free-functions-1"><a class="header" href="#free-functions-1">Free functions</a></h5>
<p><strong>Files</strong>:</p>
<ul>
<li>
<p><code>copy</code>. Take <code>AsPath</code> bound.</p>
</li>
<li>
<p><code>rename</code>. Take <code>AsPath</code> bound.</p>
</li>
<li>
<p><code>remove_file</code> (renamed from <code>unlink</code>). Take <code>AsPath</code> bound.</p>
</li>
<li>
<p><code>metadata</code> (renamed from <code>stat</code>). Take <code>AsPath</code> bound. Yield a new struct, <code>Metadata</code>, with no public fields, but <code>len</code>, <code>is_dir</code>, <code>is_file</code>, <code>perms</code>, <code>accessed</code> and <code>modified</code> accessors. The various <code>os::platform</code> modules will offer extension methods on this structure.</p>
</li>
<li>
<p><code>set_perms</code> (renamed from <code>chmod</code>). Take <code>AsPath</code> bound, and a <code>Perms</code> value. The <code>Perms</code> type will be revamped as a struct with private implementation; see below.</p>
</li>
</ul>
<p><strong>Directories</strong>:</p>
<ul>
<li><code>create_dir</code> (renamed from <code>mkdir</code>). Take <code>AsPath</code> bound.</li>
<li><code>create_dir_all</code> (renamed from <code>mkdir_recursive</code>). Take <code>AsPath</code> bound.</li>
<li><code>read_dir</code> (renamed from <code>readdir</code>). Take <code>AsPath</code> bound. Yield a newtypes iterator, which yields a new type <code>DirEntry</code> which has an accessor for <code>Path</code>, but will eventually provide other information as well (possibly via platform-specific extensions).</li>
<li><code>remove_dir</code> (renamed from <code>rmdir</code>). Take <code>AsPath</code> bound.</li>
<li><code>remove_dir_all</code> (renamed from <code>rmdir_recursive</code>). Take <code>AsPath</code> bound.</li>
<li><code>walk_dir</code>. Take <code>AsPath</code> bound. Yield an iterator over <code>IoResult&lt;DirEntry&gt;</code>.</li>
</ul>
<p><strong>Links</strong>:</p>
<ul>
<li><code>hard_link</code> (renamed from <code>link</code>). Take <code>AsPath</code> bound.</li>
<li><code>soft_link</code> (renamed from <code>symlink</code>). Take <code>AsPath</code> bound.</li>
<li><code>read_link</code> (renamed form <code>readlink</code>). Take <code>AsPath</code> bound.</li>
</ul>
<h5 id="files"><a class="header" href="#files">Files</a></h5>
<p>The <code>File</code> type will largely stay as it is today, except that it will use the <code>AsPath</code> bound everywhere.</p>
<p>The <code>stat</code> method will be renamed to <code>metadata</code>, yield a <code>Metadata</code> structure (as described above), and take <code>&amp;self</code>.</p>
<p>The <code>fsync</code> method will be renamed to <code>sync_all</code>, and <code>datasync</code> will be renamed to <code>sync_data</code>. (Although the latter is not available on Windows, it can be considered an optimization for <code>flush</code> and on Windows behave identically to <code>sync_all</code>, just as it does on some Unix filesystems.)</p>
<p>The <code>path</code> method will remain <code>#[unstable]</code>, as we do not yet want to commit to its API.</p>
<p>The <code>open_mode</code> function will be removed in favor of and will take an <code>OpenOptions</code> struct, which will encompass today’s <code>FileMode</code> and <code>FileAccess</code> and support a builder-style API.</p>
<h5 id="file-kinds"><a class="header" href="#file-kinds">File kinds</a></h5>
<p>The <code>FileType</code> type will be removed. As mentioned above, <code>is_file</code> and <code>is_dir</code> will be provided directly on <code>Metadata</code>; the other types need to be audited for compatibility across platforms. Platform-specific kinds will be relegated to extension traits in <code>std::os::platform</code>.</p>
<p>It’s possible that an <a href="https://github.com/rust-lang/rfcs/pull/757">extensible</a> <code>Kind</code> will be added in the future.</p>
<h5 id="file-permissions"><a class="header" href="#file-permissions">File permissions</a></h5>
<p>The permission models on Unix and Windows vary greatly – even between different filesystems within the same OS. Rather than offer an API that has no meaning on some platforms, we will initially provide a very limited <code>Perms</code> structure in <code>std::fs</code>, and then rich extension traits in <code>std::os::unix</code> and <code>std::os::windows</code>. Over time, if clear cross-platform patterns emerge for richer permissions, we can grow the <code>Perms</code> structure.</p>
<p>On the Unix side, the constructors and accessors for <code>Perms</code> will resemble the flags we have today; details are left to the implementation.</p>
<p>On the Windows side, initially there will be no extensions, as Windows has a very complex permissions model that will take some time to build out.</p>
<p>For <code>std::fs</code> itself, <code>Perms</code> will provide constructors and accessors for “world readable” – and that is all. At the moment, that is all that is known to be compatible across the platforms that Rust supports.</p>
<h5 id="pathext"><a class="header" href="#pathext"><code>PathExt</code></a></h5>
<p>This trait will essentially remain stay as it is (renamed from <code>PathExtensions</code>), following the same changes made to <code>fs</code> free functions.</p>
<h5 id="items-to-move-to-osplatform-1"><a class="header" href="#items-to-move-to-osplatform-1">Items to move to <code>os::platform</code></a></h5>
<ul>
<li>
<p><code>lstat</code> will move to <code>os::unix</code> and remain <code>#[unstable]</code> <em>for now</em> since it is not yet implemented for Windows.</p>
</li>
<li>
<p><code>chown</code> will move to <code>os::unix</code> (it currently does <em>nothing</em> on Windows), and eventually <code>os::windows</code> will grow support for Windows’s permission model. If at some point a reasonable intersection is found, we will re-introduce a cross-platform function in <code>std::fs</code>.</p>
</li>
<li>
<p>In general, offer all of the <code>stat</code> fields as an extension trait on <code>Metadata</code> (e.g. <code>os::unix::MetadataExt</code>).</p>
</li>
</ul>
<h4 id="stdnet"><a class="header" href="#stdnet"><code>std::net</code></a></h4>
<p>The contents of <code>std::io::net</code> submodules <code>tcp</code>, <code>udp</code>, <code>ip</code> and <code>addrinfo</code> will be retained but moved into a single <code>std::net</code> module; the other modules are being moved or removed and are described elsewhere.</p>
<h5 id="socketaddr"><a class="header" href="#socketaddr">SocketAddr</a></h5>
<p>This structure will represent either a <code>sockaddr_in</code> or <code>sockaddr_in6</code> which is commonly just a pairing of an IP address and a port.</p>
<pre><code class="language-rust">enum SocketAddr {
    V4(SocketAddrV4),
    V6(SocketAddrV6),
}

impl SocketAddrV4 {
    fn new(addr: Ipv4Addr, port: u16) -&gt; SocketAddrV4;
    fn ip(&amp;self) -&gt; &amp;Ipv4Addr;
    fn port(&amp;self) -&gt; u16;
}

impl SocketAddrV6 {
    fn new(addr: Ipv6Addr, port: u16, flowinfo: u32, scope_id: u32) -&gt; SocketAddrV6;
    fn ip(&amp;self) -&gt; &amp;Ipv6Addr;
    fn port(&amp;self) -&gt; u16;
    fn flowinfo(&amp;self) -&gt; u32;
    fn scope_id(&amp;self) -&gt; u32;
}</code></pre>
<h5 id="ipv4addr"><a class="header" href="#ipv4addr">Ipv4Addr</a></h5>
<p>Represents a version 4 IP address. It has the following interface:</p>
<pre><code class="language-rust">impl Ipv4Addr {
    fn new(a: u8, b: u8, c: u8, d: u8) -&gt; Ipv4Addr;
    fn any() -&gt; Ipv4Addr;
    fn octets(&amp;self) -&gt; [u8; 4];
    fn to_ipv6_compatible(&amp;self) -&gt; Ipv6Addr;
    fn to_ipv6_mapped(&amp;self) -&gt; Ipv6Addr;
}</code></pre>
<h5 id="ipv6addr"><a class="header" href="#ipv6addr">Ipv6Addr</a></h5>
<p>Represents a version 6 IP address. It has the following interface:</p>
<pre><code class="language-rust">impl Ipv6Addr {
    fn new(a: u16, b: u16, c: u16, d: u16, e: u16, f: u16, g: u16, h: u16) -&gt; Ipv6Addr;
    fn any() -&gt; Ipv6Addr;
    fn segments(&amp;self) -&gt; [u16; 8]
    fn to_ipv4(&amp;self) -&gt; Option&lt;Ipv4Addr&gt;;
}</code></pre>
<h5 id="tcp"><a class="header" href="#tcp">TCP</a></h5>
<p>The current <code>TcpStream</code> struct will be pared back from where it is today to the following interface:</p>
<pre><code class="language-rust">// TcpStream, which contains both a reader and a writer

impl TcpStream {
    fn connect&lt;A: ToSocketAddrs&gt;(addr: &amp;A) -&gt; io::Result&lt;TcpStream&gt;;
    fn peer_addr(&amp;self) -&gt; io::Result&lt;SocketAddr&gt;;
    fn local_addr(&amp;self) -&gt; io::Result&lt;SocketAddr&gt;;
    fn shutdown(&amp;self, how: Shutdown) -&gt; io::Result&lt;()&gt;;
    fn try_clone(&amp;self) -&gt; io::Result&lt;TcpStream&gt;;
}

impl Read for TcpStream { ... }
impl Write for TcpStream { ... }
impl&lt;'a&gt; Read for &amp;'a TcpStream { ... }
impl&lt;'a&gt; Write for &amp;'a TcpStream { ... }
#[cfg(unix)]    impl AsRawFd for TcpStream { ... }
#[cfg(windows)] impl AsRawSocket for TcpStream { ... }</code></pre>
<ul>
<li><code>clone</code> has been replaced with a <code>try_clone</code> function. The implementation of <code>try_clone</code> will map to using <code>dup</code> on Unix platforms and <code>WSADuplicateSocket</code> on Windows platforms. The <code>TcpStream</code> itself will no longer be reference counted itself under the hood.</li>
<li><code>close_{read,write}</code> are both removed in favor of binding the <code>shutdown</code> function directly on sockets. This will map to the <code>shutdown</code> function on both Unix and Windows.</li>
<li><code>set_timeout</code> has been removed for now (as well as other timeout-related functions). It is likely that this may come back soon as a binding to <code>setsockopt</code> to the <code>SO_RCVTIMEO</code> and <code>SO_SNDTIMEO</code> options. This RFC does not currently proposed adding them just yet, however.</li>
<li>Implementations of <code>Read</code> and <code>Write</code> are provided for <code>&amp;TcpStream</code>. These implementations are not necessarily ergonomic to call (requires taking an explicit reference), but they express the ability to concurrently read and write from a <code>TcpStream</code></li>
</ul>
<p>Various other options such as <code>nodelay</code> and <code>keepalive</code> will be left <code>#[unstable]</code> for now. The <code>TcpStream</code> structure will also adhere to both <code>Send</code> and <code>Sync</code>.</p>
<p>The <code>TcpAcceptor</code> struct will be removed and all functionality will be folded into the <code>TcpListener</code> structure. Specifically, this will be the resulting API:</p>
<pre><code class="language-rust">impl TcpListener {
    fn bind&lt;A: ToSocketAddrs&gt;(addr: &amp;A) -&gt; io::Result&lt;TcpListener&gt;;
    fn local_addr(&amp;self) -&gt; io::Result&lt;SocketAddr&gt;;
    fn try_clone(&amp;self) -&gt; io::Result&lt;TcpListener&gt;;
    fn accept(&amp;self) -&gt; io::Result&lt;(TcpStream, SocketAddr)&gt;;
    fn incoming(&amp;self) -&gt; Incoming;
}

impl&lt;'a&gt; Iterator for Incoming&lt;'a&gt; {
    type Item = io::Result&lt;TcpStream&gt;;
    ...
}
#[cfg(unix)]    impl AsRawFd for TcpListener { ... }
#[cfg(windows)] impl AsRawSocket for TcpListener { ... }</code></pre>
<p>Some major changes from today’s API include:</p>
<ul>
<li>The static distinction between <code>TcpAcceptor</code> and <code>TcpListener</code> has been removed (more on this in the <a href="#sockets">socket</a> section).</li>
<li>The <code>clone</code> functionality has been removed in favor of <code>try_clone</code> (same caveats as <code>TcpStream</code>).</li>
<li>The <code>close_accept</code> functionality is removed entirely. This is not currently implemented via <code>shutdown</code> (not supported well across platforms) and is instead implemented via <code>select</code>. This functionality can return at a later date with a more robust interface.</li>
<li>The <code>set_timeout</code> functionality has also been removed in favor of returning at a later date in a more robust fashion with <code>select</code>.</li>
<li>The <code>accept</code> function no longer takes <code>&amp;mut self</code> and returns <code>SocketAddr</code>. The change in mutability is done to express that multiple <code>accept</code> calls can happen concurrently.</li>
<li>For convenience the iterator does not yield the <code>SocketAddr</code> from <code>accept</code>.</li>
</ul>
<p>The <code>TcpListener</code> type will also adhere to <code>Send</code> and <code>Sync</code>.</p>
<h5 id="udp"><a class="header" href="#udp">UDP</a></h5>
<p>The UDP infrastructure will receive a similar face-lift as the TCP infrastructure will:</p>
<pre><code class="language-rust">impl UdpSocket {
    fn bind&lt;A: ToSocketAddrs&gt;(addr: &amp;A) -&gt; io::Result&lt;UdpSocket&gt;;
    fn recv_from(&amp;self, buf: &amp;mut [u8]) -&gt; io::Result&lt;(usize, SocketAddr)&gt;;
    fn send_to&lt;A: ToSocketAddrs&gt;(&amp;self, buf: &amp;[u8], addr: &amp;A) -&gt; io::Result&lt;usize&gt;;
    fn local_addr(&amp;self) -&gt; io::Result&lt;SocketAddr&gt;;
    fn try_clone(&amp;self) -&gt; io::Result&lt;UdpSocket&gt;;
}

#[cfg(unix)]    impl AsRawFd for UdpSocket { ... }
#[cfg(windows)] impl AsRawSocket for UdpSocket { ... }</code></pre>
<p>Some important points of note are:</p>
<ul>
<li>The <code>send</code> and <code>recv</code> function take <code>&amp;self</code> instead of <code>&amp;mut self</code> to indicate that they may be called safely in concurrent contexts.</li>
<li>All configuration options such as <code>multicast</code> and <code>ttl</code> are left as <code>#[unstable]</code> for now.</li>
<li>All timeout support is removed. This may come back in the form of <code>setsockopt</code> (as with TCP streams) or with a more general implementation of <code>select</code>.</li>
<li><code>clone</code> functionality has been replaced with <code>try_clone</code>.</li>
</ul>
<p>The <code>UdpSocket</code> type will adhere to both <code>Send</code> and <code>Sync</code>.</p>
<h5 id="sockets"><a class="header" href="#sockets">Sockets</a></h5>
<p>The current constructors for <code>TcpStream</code>, <code>TcpListener</code>, and <code>UdpSocket</code> are largely “convenience constructors” as they do not expose the underlying details that a socket can be configured before it is bound, connected, or listened on. One of the more frequent configuration options is <code>SO_REUSEADDR</code> which is set by default for <code>TcpListener</code> currently.</p>
<p>This RFC leaves it as an open question how best to implement this pre-configuration. The constructors today will likely remain no matter what as convenience constructors and a new structure would implement consuming methods to transform itself to each of the various <code>TcpStream</code>, <code>TcpListener</code>, and <code>UdpSocket</code>.</p>
<p>This RFC does, however, recommend not adding multiple constructors to the various types to set various configuration options. This pattern is best expressed via a flexible socket type to be added at a future date.</p>
<h5 id="addresses"><a class="header" href="#addresses">Addresses</a></h5>
<p>For the current <code>addrinfo</code> module:</p>
<ul>
<li>The <code>get_host_addresses</code> should be renamed to <code>lookup_host</code>.</li>
<li>All other contents should be removed.</li>
</ul>
<p>For the current <code>ip</code> module:</p>
<ul>
<li>The <code>ToSocketAddr</code> trait should become <code>ToSocketAddrs</code></li>
<li>The default <code>to_socket_addr_all</code> method should be removed.</li>
</ul>
<p>The following implementations of <code>ToSocketAddrs</code> will be available:</p>
<pre><code class="language-rust">impl ToSocketAddrs for SocketAddr { ... }
impl ToSocketAddrs for SocketAddrV4 { ... }
impl ToSocketAddrs for SocketAddrV6 { ... }
impl ToSocketAddrs for (Ipv4Addr, u16) { ... }
impl ToSocketAddrs for (Ipv6Addr, u16) { ... }
impl ToSocketAddrs for (&amp;str, u16) { ... }
impl ToSocketAddrs for str { ... }
impl&lt;T: ToSocketAddrs&gt; ToSocketAddrs for &amp;T { ... }</code></pre>
<h4 id="stdprocess"><a class="header" href="#stdprocess"><code>std::process</code></a></h4>
<p>Currently <code>std::io::process</code> is used only for spawning new processes. The re-envisioned <code>std::process</code> will ultimately support inspecting currently-running processes, although this RFC does not propose any immediate support for doing so – it merely future-proofs the module.</p>
<h5 id="command"><a class="header" href="#command"><code>Command</code></a></h5>
<p>The <code>Command</code> type is a builder API for processes, and is largely in good shape, modulo a few tweaks:</p>
<ul>
<li>Replace <code>ToCStr</code> bounds with <code>AsOsStr</code>.</li>
<li>Replace <code>env_set_all</code> with <code>env_clear</code></li>
<li>Rename <code>cwd</code> to <code>current_dir</code>, take <code>AsPath</code>.</li>
<li>Rename <code>spawn</code> to <code>run</code></li>
<li>Move <code>uid</code> and <code>gid</code> to an extension trait in <code>os::unix</code></li>
<li>Make <code>detached</code> take a <code>bool</code> (rather than always setting the command to detached mode).</li>
</ul>
<p>The <code>stdin</code>, <code>stdout</code>, <code>stderr</code> methods will undergo a more significant change. By default, the corresponding options will be considered “unset”, the interpretation of which depends on how the process is launched:</p>
<ul>
<li>For <code>run</code> or <code>status</code>, these will inherit from the current process by default.</li>
<li>For <code>output</code>, these will capture to new readers/writers by default.</li>
</ul>
<p>The <code>StdioContainer</code> type will be renamed to <code>Stdio</code>, and will not be exposed directly as an enum (to enable growth and change over time). It will provide a <code>Capture</code> constructor for capturing input or output, an <code>Inherit</code> constructor (which just means to use the current IO object – it does not take an argument), and a <code>Null</code> constructor. The equivalent of today’s <code>InheritFd</code> will be added at a later point.</p>
<h5 id="child"><a class="header" href="#child"><code>Child</code></a></h5>
<p>We propose renaming <code>Process</code> to <code>Child</code> so that we can add a more general notion of non-child <code>Process</code> later on (every <code>Child</code> will be able to give you a <code>Process</code>).</p>
<ul>
<li><code>stdin</code>, <code>stdout</code> and <code>stderr</code> will be retained as public fields, but their types will change to newtyped readers and writers to hide the internal pipe infrastructure.</li>
<li>The <code>kill</code> method is dropped, and <code>id</code> and <code>signal</code> will move to <code>os::platform</code> extension traits.</li>
<li><code>signal_exit</code>, <code>signal_kill</code>, <code>wait</code>, and <code>forget</code> will all stay as they are.</li>
<li><code>set_timeout</code> will be changed to use the <code>with_deadline</code> infrastructure.</li>
</ul>
<p>There are also a few other related changes to the module:</p>
<ul>
<li>Rename <code>ProcessOutput</code> to <code>Output</code></li>
<li>Rename <code>ProcessExit</code> to <code>ExitStatus</code>, and hide its representation. Remove <code>matches_exit_status</code>, and add a <code>status</code> method yielding an <code>Option&lt;i32&gt;</code></li>
<li>Remove <code>MustDieSignal</code>, <code>PleaseExitSignal</code>.</li>
<li>Remove <code>EnvMap</code> (which should never have been exposed).</li>
</ul>
<h4 id="stdos"><a class="header" href="#stdos"><code>std::os</code></a></h4>
<p>Initially, this module will be empty except for the platform-specific <code>unix</code> and <code>windows</code> modules. It is expected to grow additional, more specific platform submodules (like <code>linux</code>, <code>macos</code>) over time.</p>
<h3 id="odds-and-ends"><a class="header" href="#odds-and-ends">Odds and ends</a></h3>
<blockquote>
<p>To be expanded in a follow-up PR.</p>
</blockquote>
<h4 id="the-io-prelude"><a class="header" href="#the-io-prelude">The <code>io</code> prelude</a></h4>
<p>The <code>prelude</code> submodule will contain most of the traits, types, and modules discussed in this RFC; it is meant to provide maximal convenience when working with IO of any kind. The exact contents of the module are left as an open question.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p>This RFC is largely about cleanup, normalization, and stabilization of our IO libraries – work that needs to be done, but that also represents nontrivial churn.</p>
<p>However, the actual implementation work involved is estimated to be reasonably contained, since all of the functionality is already in place in some form (including <code>os_str</code>, due to @SimonSapin’s <a href="https://github.com/SimonSapin/rust-wtf8">WTF-8 implementation</a>).</p>
<h2 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h2>
<p>The main alternative design would be to continue staying with the Posix tradition in terms of naming and functionality (for which there is precedent in some other languages). However, Rust is already well-known for its strong cross-platform compatibility in <code>std</code>, and making the library more Windows-friendly will only increase its appeal.</p>
<p>More radically different designs (in terms of different design principles or visions) are outside the scope of this RFC.</p>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<blockquote>
<p>To be expanded in follow-up PRs.</p>
</blockquote>
<h3 id="wide-string-representation"><a class="header" href="#wide-string-representation">Wide string representation</a></h3>
<p>(Text from @SimonSapin)</p>
<p>Rather than WTF-8, <code>OsStr</code> and <code>OsString</code> on Windows could use potentially-ill-formed UTF-16 (a.k.a. “wide” strings), with a different cost trade off.</p>
<p>Upside:</p>
<ul>
<li>No conversion between <code>OsStr</code> / <code>OsString</code> and OS calls.</li>
</ul>
<p>Downsides:</p>
<ul>
<li>More expensive conversions between <code>OsStr</code> / <code>OsString</code> and <code>str</code> / <code>String</code>.</li>
<li>These conversions have inconsistent performance characteristics between platforms. (Need to allocate on Windows, but not on Unix.)</li>
<li>Some of them return <code>Cow</code>, which has some ergonomic hit.</li>
</ul>
<p>The API (only parts that differ) could look like:</p>
<pre><code class="language-rust">pub mod os_str {
    #[cfg(windows)]
    mod imp {
        type Buf = Vec&lt;u16&gt;;
        type Slice = [u16];
        ...
    }

    impl OsStr {
        pub fn from_str(&amp;str) -&gt; Cow&lt;OsString, OsStr&gt;;
        pub fn to_string(&amp;self) -&gt; Option&lt;CowString&gt;;
        pub fn to_string_lossy(&amp;self) -&gt; CowString;
    }

    #[cfg(windows)]
    pub mod windows{
        trait OsStringExt {
            fn from_wide_slice(&amp;[u16]) -&gt; Self;
            fn from_wide_vec(Vec&lt;u16&gt;) -&gt; Self;
            fn into_wide_vec(self) -&gt; Vec&lt;u16&gt;;
        }

        trait OsStrExt {
            fn from_wide_slice(&amp;[u16]) -&gt; Self;
            fn as_wide_slice(&amp;self) -&gt; &amp;[u16];
        }
    }
}</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0509-collections-reform-part-2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="0520-new-array-repeat-syntax.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0509-collections-reform-part-2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="0520-new-array-repeat-syntax.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
