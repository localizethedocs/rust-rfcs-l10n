<!DOCTYPE HTML>
<html lang="en_US" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0509-collections-reform-part-2 - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-0060737d.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2014-12-18</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/509">rust-lang/rfcs#509</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/19986">rust-lang/rust#19986</a></li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>This RFC shores up the finer details of collections reform. In particular, where the
<a href="https://github.com/rust-lang/rfcs/blob/master/text/0235-collections-conventions.md">previous RFC</a>
focused on general conventions and patterns, this RFC focuses on specific APIs. It also patches
up any errors that were found during implementation of <a href="https://github.com/rust-lang/rfcs/blob/master/text/0235-collections-conventions.md">part 1</a>. Some of these changes
have already been implemented, and simply need to be ratified.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>Collections reform stabilizes “standard” interfaces, but there’s a lot that still needs to be
hashed out.</p>
<h2 id="detailed-design"><a class="header" href="#detailed-design">Detailed design</a></h2>
<h3 id="the-fate-of-entire-collections"><a class="header" href="#the-fate-of-entire-collections">The fate of entire collections:</a></h3>
<ul>
<li>Stable: Vec, RingBuf, HashMap, HashSet, BTreeMap, BTreeSet, DList, BinaryHeap</li>
<li>Unstable: Bitv, BitvSet, VecMap</li>
<li>Move to <a href="https://github.com/Gankro/collect-rs/">collect-rs</a> for incubation:
EnumSet, bitflags!, LruCache, TreeMap, TreeSet, TrieMap, TrieSet</li>
</ul>
<p>The stable collections have solid implementations, well-maintained APIs, are non-trivial,
fundamental, and clearly useful.</p>
<p>The unstable collections are effectively “on probation”. They’re ok, but they need some TLC and
further consideration before we commit to having them in the standard library <em>forever</em>. Bitv in
particular won’t have <em>quite</em> the right API without IndexGet <em>and</em> IndexSet.</p>
<p>The collections being moved out are in poor shape. EnumSet is weird/trivial, bitflags is awkward,
LruCache is niche. Meanwhile Tree* and Trie* have simply bit-rotted for too long, without anyone
clearly stepping up to maintain them. Their code is scary, and their APIs are out of date. Their
functionality can also already reasonably be obtained through either HashMap or BTreeMap.</p>
<p>Of course, instead of moving them out-of-tree, they could be left <code>experimental</code>, but that would
perhaps be a fate <em>worse</em> than death, as it would mean that these collections would only be
accessible to those who opt into running the Rust nightly. This way, these collections will be
available for everyone through the cargo ecosystem. Putting them in <code>collect-rs</code> also gives them
a chance to still benefit from a network effect and active experimentation. If they thrive there,
they may still return to the standard library at a later time.</p>
<h3 id="add-the-following-methods"><a class="header" href="#add-the-following-methods">Add the following methods:</a></h3>
<ul>
<li>To all collections</li>
</ul>
<pre><code>/// Moves all the elements of `other` into `Self`, leaving `other` empty.
pub fn append(&amp;mut self, other: &amp;mut Self)
</code></pre>
<p>Collections know everything about themselves, and can therefore move data more
efficiently than any more generic mechanism. Vec’s can safely trust their own capacity
and length claims. DList and TreeMap can also reuse nodes, avoiding allocating.</p>
<p>This is by-ref instead of by-value for a couple reasons. First, it adds symmetry (one doesn’t have
to be owned). Second, in the case of array-based structures, it allows <code>other</code>’s capacity to be
reused. This shouldn’t have much expense in the way of making <code>other</code> valid, as almost all of our
collections are basically a no-op to make an empty version of if necessary (usually it amounts to
zeroing a few words of memory). BTree is the only exception the author is aware of (root is pre-
allocated
to avoid an Option).</p>
<ul>
<li>To DList, Vec, RingBuf, BitV:</li>
</ul>
<pre><code>/// Splits the collection into two at the given index. Useful for similar reasons as `append`.
pub fn split_off(&amp;mut self, at: uint) -&gt; Self;
</code></pre>
<ul>
<li>To all other “sorted” collections</li>
</ul>
<pre><code>/// Splits the collection into two at the given key. Returns everything after the given key,
/// including the key.
pub fn split_off&lt;B: Borrow&lt;K&gt;&gt;(&amp;mut self, at: B) -&gt; Self;
</code></pre>
<p>Similar reasoning to <code>append</code>, although perhaps even more needed, as there’s <em>no</em> other mechanism
for moving an entire subrange of a collection efficiently like this. <code>into_iterator</code> consumes
the whole collection, and using <code>remove</code> methods will do a lot of unnecessary work. For instance,
in the case of <code>Vec</code>, using <code>pop</code> and <code>push</code> will involve many length changes, bounds checks,
unwraps, and ultimately produce a <em>reversed</em> Vec.</p>
<ul>
<li>To BitvSet, VecMap:</li>
</ul>
<pre><code>/// Reserves capacity for an element to be inserted at `len - 1` in the given
/// collection. The collection may reserve more space to avoid frequent reallocations.
pub fn reserve_len(&amp;mut self, len: uint)

/// Reserves the minimum capacity for an element to be inserted at `len - 1` in the given
/// collection.
pub fn reserve_len_exact(&amp;mut self, len: uint)
</code></pre>
<p>The “capacity” of these two collections isn’t really strongly related to the
number of elements they hold, but rather the largest index an element is stored at.
See Errata and Alternatives for extended discussion of this design.</p>
<ul>
<li>For Ringbuf:</li>
</ul>
<pre><code>/// Gets two slices that cover the whole range of the RingBuf.
/// The second one may be empty. Otherwise, it continues *after* the first.
pub fn as_slices(&amp;'a self) -&gt; (&amp;'a [T], &amp;'a [T])
</code></pre>
<p>This provides some amount of support for viewing the RingBuf like a slice. Unfortunately
the RingBuf may be wrapped, making this impossible. See Alternatives for other designs.</p>
<p>There is an implementation of this at rust-lang/rust#19903.</p>
<ul>
<li>For Vec:</li>
</ul>
<pre><code>/// Resizes the `Vec` in-place so that `len()` equals to `new_len`.
///
/// Calls either `grow()` or `truncate()` depending on whether `new_len`
/// is larger than the current value of `len()` or not.
pub fn resize(&amp;mut self, new_len: uint, value: T) where T: Clone
</code></pre>
<p>This is actually easy to implement out-of-tree on top of the current Vec API, but it has
been frequently requested.</p>
<ul>
<li>For Vec, RingBuf, BinaryHeap, HashMap and HashSet:</li>
</ul>
<pre><code>/// Clears the container, returning its owned contents as an iterator, but keeps the
/// allocated memory for reuse.
pub fn drain(&amp;mut self) -&gt; Drain&lt;T&gt;;
</code></pre>
<p>This provides a way to grab elements out of a collection by value, without
deallocating the storage for the collection itself.</p>
<p>There is a partial implementation of this at rust-lang/rust#19946.</p>
<p>==============</p>
<h3 id="deprecate"><a class="header" href="#deprecate">Deprecate</a></h3>
<ul>
<li><code>Vec::from_fn(n, f)</code> use <code>(0..n).map(f).collect()</code></li>
<li><code>Vec::from_elem(n, v)</code> use <code>repeat(v).take(n).collect()</code></li>
<li><code>Vec::grow</code> use <code>extend(repeat(v).take(n))</code></li>
<li><code>Vec::grow_fn</code> use <code>extend((0..n).map(f))</code></li>
<li><code>dlist::ListInsertion</code> in favour of inherent methods on the iterator</li>
</ul>
<p>==============</p>
<h3 id="misc-stabilization"><a class="header" href="#misc-stabilization">Misc Stabilization:</a></h3>
<ul>
<li>
<p>Rename <code>BinaryHeap::top</code> to <code>BinaryHeap::peek</code>. <code>peek</code> is a more clear name than <code>top</code>, and is
already used elsewhere in our APIs.</p>
</li>
<li>
<p><code>Bitv::get</code>, <code>Bitv::set</code>, where <code>set</code> panics on OOB, and <code>get</code> returns an Option. <code>set</code> may want
to wait on IndexSet being a thing (see Alternatives).</p>
</li>
<li>
<p>Rename SmallIntMap to VecMap. (already done)</p>
</li>
<li>
<p>Stabilize <code>front</code>/<code>back</code>/<code>front_mut</code>/<code>back_mut</code> for peeking on the ends of Deques</p>
</li>
<li>
<p>Explicitly specify HashMap’s iterators to be non-deterministic between iterations. This would
allow e.g. <code>next_back</code> to be implemented as <code>next</code>, reducing code complexity. This can be undone
in the future backwards-compatibly, but the reverse does not hold.</p>
</li>
<li>
<p>Move <code>Vec</code> from <code>std::vec</code> to <code>std::collections::vec</code>.</p>
</li>
<li>
<p>Stabilize RingBuf::swap</p>
</li>
</ul>
<p>==============</p>
<h3 id="clarifications-and-errata-from-part-1"><a class="header" href="#clarifications-and-errata-from-part-1">Clarifications and Errata from Part 1</a></h3>
<ul>
<li>
<p>Not every collection can implement every kind of iterator. This RFC simply wishes to clarify
that iterator implementation should be a “best effort” for what makes sense for the collection.</p>
</li>
<li>
<p>Bitv was marked as having <em>explicit</em> growth capacity semantics, when in fact it is implicit
growth. It has the same semantics as Vec.</p>
</li>
<li>
<p>BitvSet and VecMap are part of a surprise <em>fourth</em> capacity class, which isn’t really based on
the number of elements contained, but on the maximum index stored. This RFC proposes the name of
<em>maximum growth</em>.</p>
</li>
<li>
<p><code>reserve(x)</code> should specifically reserve space for <code>x + len()</code> elements, as opposed to e.g. <code>x + capacity()</code> elements.</p>
</li>
<li>
<p>Capacity methods should be based on a “best effort” model:</p>
<ul>
<li>
<p><code>capacity()</code> can be regarded as a <em>lower bound</em> on the number of elements that can be
inserted before a resize occurs. It is acceptable for more elements to be insertable. A
collection may also randomly resize before capacity is met if highly degenerate behaviour
occurs. This is relevant to HashMap, which due to its use of integer multiplication cannot
precisely compute its “true” capacity. It also may wish to resize early if a long chain of
collisions occurs. Note that Vec should make <em>clear</em> guarantees about the precision of
capacity, as this is important for <code>unsafe</code> usage.</p>
</li>
<li>
<p><code>reserve_exact</code> may be subverted by the collection’s own requirements (e.g. many collections
require a capacity related to a power of two for fast modular arithmetic). The allocator may
also give the collection more space than it requests, in which case it may as well use that
space. It will still give you at least as much capacity as you request.</p>
</li>
<li>
<p><code>shrink_to_fit</code> may not shrink to the true minimum size for similar reasons as
<code>reserve_exact</code>.</p>
</li>
<li>
<p>Neither <code>reserve</code> nor <code>reserve_exact</code> can be trusted to reliably produce a specific
capacity. At best you can guarantee that there will be space for the number you ask for.
Although even then <code>capacity</code> itself may return a smaller number due to its own fuzziness.</p>
</li>
</ul>
</li>
</ul>
<p>==============</p>
<h3 id="entry-api-v20"><a class="header" href="#entry-api-v20">Entry API V2.0</a></h3>
<p>The old Entry API:</p>
<pre><code>impl Map&lt;K, V&gt; {
    fn entry&lt;'a&gt;(&amp;'a mut self, key: K) -&gt; Entry&lt;'a, K, V&gt;
}

pub enum Entry&lt;'a, K: 'a, V: 'a&gt; {
    Occupied(OccupiedEntry&lt;'a, K, V&gt;),
    Vacant(VacantEntry&lt;'a, K, V&gt;),
}

impl&lt;'a, K, V&gt; VacantEntry&lt;'a, K, V&gt; {
    fn set(self, value: V) -&gt; &amp;'a mut V
}

impl&lt;'a, K, V&gt; OccupiedEntry&lt;'a, K, V&gt; {
    fn get(&amp;self) -&gt; &amp;V
    fn get_mut(&amp;mut self) -&gt; &amp;mut V
    fn into_mut(self) -&gt; &amp;'a mut V
    fn set(&amp;mut self, value: V) -&gt; V
    fn take(self) -&gt; V
}
</code></pre>
<p>Based on feedback and collections reform landing, this RFC proposes the following new API:</p>
<pre><code>impl Map&lt;K, V&gt; {
    fn entry&lt;'a, O: ToOwned&lt;K&gt;&gt;(&amp;'a mut self, key: &amp;O) -&gt; Entry&lt;'a, O, V&gt;
}

pub enum Entry&lt;'a, O: 'a, V: 'a&gt; {
    Occupied(OccupiedEntry&lt;'a, O, V&gt;),
    Vacant(VacantEntry&lt;'a, O, V&gt;),
}

impl Entry&lt;'a, O: 'a, V:'a&gt; {
    fn get(self) -&gt; Result&lt;&amp;'a mut V, VacantEntry&lt;'a, O, V&gt;&gt;
}

impl&lt;'a, K, V&gt; VacantEntry&lt;'a, K, V&gt; {
    fn insert(self, value: V) -&gt; &amp;'a mut V
}

impl&lt;'a, K, V&gt; OccupiedEntry&lt;'a, K, V&gt; {
    fn get(&amp;self) -&gt; &amp;V
    fn get_mut(&amp;mut self) -&gt; &amp;mut V
    fn into_mut(self) -&gt; &amp;'a mut V
    fn insert(&amp;mut self, value: V) -&gt; V
    fn remove(self) -&gt; V
}
</code></pre>
<p>Replacing get/get_mut with Deref is simply a nice ergonomic improvement. Renaming <code>set</code> and <code>take</code>
to <code>insert</code> and <code>remove</code> brings the API more inline with other collection APIs, and makes it
more clear what they do. The convenience method on Entry itself makes it just nicer to use.
Permitting the following <code>map.entry(key).get().or_else(|vacant| vacant.insert(Vec::new()))</code>.</p>
<p>This API should be stabilized for 1.0 with the exception of the impl on Entry itself.</p>
<h2 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h2>
<h3 id="traits-vs-inherent-impls-on-entries"><a class="header" href="#traits-vs-inherent-impls-on-entries">Traits vs Inherent Impls on Entries</a></h3>
<p>The Entry API as proposed would leave Entry and its two variants defined by each collection. We
could instead make the actual concrete VacantEntry/OccupiedEntry implementors implement a trait.
This would allow Entry to be hoisted up to root of collections, with utility functions implemented
once, as well as only requiring one import when using multiple collections. This <em>would</em> require
that the traits be imported, unless we get inherent trait implementations.</p>
<p>These traits can of course be introduced later.</p>
<p>==============</p>
<h3 id="alternatives-to-toowned-on-entries"><a class="header" href="#alternatives-to-toowned-on-entries">Alternatives to ToOwned on Entries</a></h3>
<p>The Entry API currently is a bit wasteful in the by-value key case. If, for instance, a user of a
<code>HashMap&lt;String, _&gt;</code> happens to have a String they don’t mind losing, they can’t pass the String by
-value to the Map. They must pass it by-reference, and have it get cloned.</p>
<p>One solution to this is to actually have the bound be IntoCow. This will potentially have some
runtime overhead, but it should be dwarfed by the cost of an insertion anyway, and would be a
clear win in the by-value case.</p>
<p>Another alternative would be an <em>IntoOwned</em> trait, which would have the signature <code>(self) -&gt; Owned</code>, as opposed to the current ToOwned <code>(&amp;self) -&gt; Owned</code>. IntoOwned more closely matches the
semantics we actually want for our entry keys, because we really don’t care about preserving them
after the conversion. This would allow us to dispatch to either a no-op or a full clone as
necessary. This trait would also be appropriate for the CoW type, and in fact all of our current
uses of the type. However the relationship between FromBorrow and IntoOwned is currently awkward
to express with our type system, as it would have to be implemented e.g. for <code>&amp;str</code> instead of
<code>str</code>. IntoOwned also has trouble co-existing “fully” with ToOwned due to current lack of negative
bounds in where clauses. That is, we would want a blanket impl of IntoOwned for ToOwned, but this
can’t be properly expressed for coherence reasons.</p>
<p>This RFC does not propose either of these designs in favour of choosing the conservative ToOwned
now, with the possibility of “upgrading” into IntoOwned, IntoCow, or something else when we have a
better view of the type-system landscape.</p>
<p>==============</p>
<h3 id="dont-stabilize-bitvset"><a class="header" href="#dont-stabilize-bitvset">Don’t stabilize <code>Bitv::set</code></a></h3>
<p>We could wait for IndexSet, Or make <code>set</code> return a result.
<code>set</code> really is redundant with an IndexSet implementation, and we
don’t like to provide redundant APIs. On the other hand, it’s kind of weird to have only <code>get</code>.</p>
<p>==============</p>
<h3 id="reserve_index-vs-reserve_len"><a class="header" href="#reserve_index-vs-reserve_len"><code>reserve_index</code> vs <code>reserve_len</code></a></h3>
<p><code>reserve_len</code> is primarily motivated by BitvSet and VecMap, whose capacity semantics are largely
based around the largest index they have set, and not the number of elements they contain. This
design was chosen for its equivalence to <code>with_capacity</code>, as well as possible
future-proofing for adding it to other collections like <code>Vec</code> or <code>RingBuf</code>.</p>
<p>However one could instead opt for <code>reserve_index</code>, which are effectively the same method,
but with an off-by-one. That is, <code>reserve_len(x) == reserve_index(x - 1)</code>. This more closely
matches the intent (let me have index <code>7</code>), but has tricky off-by-one with <code>capacity</code>.</p>
<p>Alternatively <code>reserve_len</code> could just be called <code>reserve_capacity</code>.</p>
<p>==============</p>
<h3 id="ringbuf-as_slice"><a class="header" href="#ringbuf-as_slice">RingBuf <code>as_slice</code></a></h3>
<p>Other designs for this usecase were considered:</p>
<pre><code>/// Attempts to get a slice over all the elements in the RingBuf, but may instead
/// have to return two slices, in the case that the elements aren't contiguous.
pub fn as_slice(&amp;'a self) -&gt; RingBufSlice&lt;'a, T&gt;

enum RingBufSlice&lt;'a, T&gt; {
    Contiguous(&amp;'a [T]),
    Split((&amp;'a [T], &amp;'a [T])),
}
</code></pre>
<pre><code>/// Gets a slice over all the elements in the RingBuf. This may require shifting
/// all the elements to make this possible.
pub fn to_slice(&amp;mut self) -&gt; &amp;[T]
</code></pre>
<p>The one settled on had the benefit of being the simplest. In particular, having the enum wasn’t
very helpful, because most code would just create an empty slice anyway in the contiguous case
to avoid code-duplication.</p>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<p><code>reserve_index</code> vs <code>reserve_len</code> and <code>Ringbuf::as_slice</code> are the two major ones.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0507-release-channels.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="0517-io-os-reform.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0507-release-channels.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="0517-io-os-reform.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
