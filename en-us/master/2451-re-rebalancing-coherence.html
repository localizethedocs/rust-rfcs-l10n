<!DOCTYPE HTML>
<html lang="en_US" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2451-re-rebalancing-coherence - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-0060737d.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Feature Name: <code>re_rebalancing_coherence</code></li>
<li>Start Date: 2018-05-30</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/2451">rust-lang/rfcs#2451</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/55437">rust-lang/rust#55437</a></li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>This RFC seeks to clarify some ambiguity from <a href="https://github.com/rust-lang/rfcs/blob/master/text/1023-rebalancing-coherence.md">RFC #1023</a>, and expands it to
allow type parameters to appear in the type for which the trait is being
implemented, regardless of whether a local type appears before them. More
concretely, it allows <code>impl&lt;T&gt; ForeignTrait&lt;LocalType&gt; for ForeignType&lt;T&gt;</code> to be
written.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>For better or worse, we allow implementing foreign traits for foreign types. For
example, <code>impl From&lt;Foo&gt; for Vec&lt;i32&gt;</code> is something any crate can write, even
though <code>From</code> is a foreign trait, and <code>Vec</code> is a foreign type. However, under
the current coherence rules, we do not allow <code>impl&lt;T&gt; From&lt;Foo&gt; for Vec&lt;T&gt;</code>.</p>
<p>There’s no good reason for this restriction. Fundamentally, allowing <code>for Vec&lt;ForeignType&gt;</code> requires all the same restrictions as allowing <code>Vec&lt;T&gt;</code>.
Disallowing type parameters to appear in the target type restricts how crates
can be extended.</p>
<p>Consider an example from Diesel. Diesel constructs an AST which represents a SQL
query, and then provides a trait to construct the final SQL. Because different
databases have different syntax, this trait is generic over the backend being
used. Diesel wants to support third party crates which add new AST nodes, as
well as crates which add support for new backends. The current rules make it
impossible to support both.</p>
<p>The Oracle database requires special syntax for inserting multiple records in a
single query. However, the impl required for this is invalid today. <code>impl&lt;'a, T, U&gt; QueryFragment&lt;Oracle&gt; for BatchInsert&lt;'a, T, U&gt;</code>. There is no reason for this
impl to be rejected. The only impl that Diesel could add which would conflict
with it would look like <code>impl&lt;'a, T&gt; QueryFragment&lt;T&gt; for BatchInsert&lt;'a, Type1, Type2&gt;</code>. Adding such an impl is already considered a major breaking change by
<a href="https://github.com/rust-lang/rfcs/blob/master/text/1023-rebalancing-coherence.md">RFC #1023</a>, which we’ll expand on below.</p>
<p>For some traits, this can be worked around by flipping the self type with the
type parameter to the trait. Diesel has done that in the past (e.g.
<code>T: NativeSqlType&lt;DB&gt;</code> became <code>DB: HasSqlType&lt;T&gt;</code>). However, that wouldn’t work
for this case. A crate which adds a new AST node would no longer be able to
implement the required trait for all backends. For example, a crate which added
the <code>LOWER</code> function from SQL (which is supported by all databases) would not be
able to write <code>impl&lt;T, DB&gt; QueryFragment&lt;Lower&lt;T&gt;&gt; for DB</code>.</p>
<p>Unless we expand the orphan rules, use cases like this one will never be
possible, and a crate like Diesel will never be able to be designed in a
completely extensible fashion.</p>
<h2 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h2>
<h3 id="definitions"><a class="header" href="#definitions">Definitions</a></h3>
<p>Local Trait: A trait which was defined in the current crate. Whether a trait is
local or not has nothing to do with type parameters. Given <code>trait Foo&lt;T, U&gt;</code>,
<code>Foo</code> is always local, regardless of the types used for <code>T</code> or <code>U</code>.</p>
<p>Local Type: A struct, enum, or union which was defined in the current crate.
This is not affected by type parameters. <code>struct Foo</code> is considered local, but
<code>Vec&lt;Foo&gt;</code> is not. <code>LocalType&lt;ForeignType&gt;</code> is local. Type aliases and trait
aliases do not affect locality.</p>
<p>Covered Type: A type which appears as a parameter to another type. For example,
<code>T</code> is uncovered, but the <code>T</code> in <code>Vec&lt;T&gt;</code> is covered. This is only relevant for
type parameters.</p>
<p>Blanket Impl: Any implementation where a type appears uncovered. <code>impl&lt;T&gt; Foo for T</code>, <code>impl&lt;T&gt; Bar&lt;T&gt; for T</code>, <code>impl&lt;T&gt; Bar&lt;Vec&lt;T&gt;&gt; for T</code>, and <code>impl&lt;T&gt; Bar&lt;T&gt; for Vec&lt;T&gt;</code> are considered blanket impls. However, <code>impl&lt;T&gt; Bar&lt;Vec&lt;T&gt;&gt; for Vec&lt;T&gt;</code> is not a blanket impl, as all instances of <code>T</code> which appear in this impl
are covered by <code>Vec</code>.</p>
<p>Fundamental Type: A type for which you cannot add a blanket impl backwards
compatibly. This includes <code>&amp;</code>, <code>&amp;mut</code>, and <code>Box</code>. Any time a type <code>T</code> is
considered local, <code>&amp;T</code>, <code>&amp;mut T</code>, and <code>Box&lt;T&gt;</code> are also considered local.
Fundamental types cannot cover other types. Any time the term “covered type” is
used, <code>&amp;T</code>, <code>&amp;mut T</code>, and <code>Box&lt;T&gt;</code> are not considered covered.</p>
<h3 id="what-is-coherence-and-why-do-we-care"><a class="header" href="#what-is-coherence-and-why-do-we-care">What is coherence and why do we care?</a></h3>
<p>Let’s start with a quick refresher on coherence and the orphan rules. Coherence
means that for any given trait and type, there is one specific implementation
that applies. This is important for Rust to be easy to reason about. When you
write <code>&lt;Foo as Bar&gt;::trait_method</code>, the compiler needs to know what actual
implementation to use.</p>
<p>In languages without coherence, the compiler has to have some way to choose
which implementation to use when multiple implementations could apply. Scala
does this by having complex scope resolution rules for “implicit” parameters.
Haskell (when a discouraged flag is enabled) does this by picking an impl
arbitrarily.</p>
<p>Rust’s solution is to enforce that there is only one impl to choose from at all.
While the rules required to enforce this are quite complex, the result is easy
to reason about, and is generally considered to be quite important for Rust.
New features like specialization allow more than one impl to apply, but for any
given type and trait, there will always be exactly one which is most specific,
and deterministically be chosen.</p>
<p>An important piece of enforcing coherence is restricting “orphan impls”. An impl
is orphaned if it is implementing a trait you don’t own for a type you don’t
own. Rust’s rules around this balance two separate, but related goals:</p>
<ul>
<li>Ensuring that two crates can’t write impls that would overlap (e.g. no crate
other than <code>std</code> can write <code>impl From&lt;usize&gt; for Vec&lt;i32&gt;</code>. If they could,
your program might stop compiling just by using two crates with an overlapping
impl).</li>
<li>Restricting the impls that can be written so crates can add implementations
for traits/types they do own without worrying about breaking downstream
crates.</li>
</ul>
<h3 id="teaching-users"><a class="header" href="#teaching-users">Teaching users</a></h3>
<p>This change isn’t something that would end up in a guide, and is mostly
communicated through error messages. The most common one seen is <a href="https://doc.rust-lang.org/error-index.html#E0210">E0210</a>. The
text of that error will be changed to approximate the following:</p>
<blockquote>
<p>Generally speaking, Rust only permits implementing a trait for a type if either
the trait or type were defined in your program. However, Rust allows a limited
number of impls that break this rule, if they follow certain rules. This error
indicates a violation of one of those rules.</p>
<p>A trait is considered local when {definition given above}. A type is considered
local when {definition given above}.</p>
<p>When implementing a foreign trait for a foreign type, the trait must have one or
more type parameters. A type local to your crate must appear before any use of
any type parameters. This means that <code>impl&lt;T&gt; ForeignTrait&lt;LocalType&lt;T&gt;, T&gt; for ForeignType</code> is valid, but <code>impl&lt;T&gt; ForeignTrait&lt;T, LocalType&lt;T&gt;&gt; for ForeignType</code> is not.</p>
<p>The reason that Rust considers order at all is to ensure that your
implementation does not conflict with one from another crate. Without this rule,
you could write <code>impl&lt;T&gt; ForeignTrait&lt;T, LocalType&gt; for ForeignType</code>, and
another crate could write <code>impl&lt;T&gt; ForeignTrait&lt;TheirType, T&gt; for ForeignType</code>,
which would overlap. For that reason, we require that your local type come
before the type parameter, since the only alternative would be disallowing these
implementations at all.</p>
</blockquote>
<p>Additionally, the case of <code>impl&lt;T&gt; ForeignTrait&lt;LocalType&gt; for T</code> should be
special cased, and given its own error message, which approximates the
following:</p>
<blockquote>
<p>This error indicates an attempt to implement a trait from another crate for a
type parameter.</p>
<p>Rust requires that for any given trait and any given type, there is at most one
implementation of that trait. An important piece of this is that we disallow
implementing a trait from another crate for a type parameter.</p>
<p>Rust’s orphan rule always permits an impl if either the trait or the type being
implemented are local to the current crate. Therefore, we can’t allow <code>impl&lt;T&gt; ForeignTrait&lt;LocalTypeCrateA&gt; for T</code>, because it might conflict with another crate
writing <code>impl&lt;T&gt; ForeignTrait&lt;T&gt; for LocalTypeCrateB</code>, which we will always
permit.</p>
</blockquote>
<p>Finally, <a href="https://github.com/rust-lang/rfcs/blob/master/text/1105-api-evolution.md">RFC #1105</a> states that implementing any non-fundamental trait for an
existing type is not a breaking change. This directly condradicts <a href="https://github.com/rust-lang/rfcs/blob/master/text/1023-rebalancing-coherence.md">RFC #1023</a>,
which is entirely based around “blanket impls” being breaking changes.
Regardless of whether the changes proposed to the orphan rules in this proposal
are accepted, a blanket impl being a breaking change <em>must</em> be true today. Given
that the compiler currently accepts <code>impl From&lt;Foo&gt; for Vec&lt;Foo&gt;</code>, adding
<code>impl&lt;T&gt; From&lt;T&gt; for Vec&lt;T&gt;</code> must be considered a major breaking change.</p>
<p>As such, <a href="https://github.com/rust-lang/rfcs/blob/master/text/1105-api-evolution.md">RFC #1105</a> is amended to remove the statement that implementing a
non-fundamental trait is a minor breaking change, and states that adding any
blanket impl for an existing trait is a major breaking change, using the
definition of blanket impl given above.</p>
<h2 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h2>
<h3 id="concrete-orphan-rules"><a class="header" href="#concrete-orphan-rules">Concrete orphan rules</a></h3>
<p>Assumes the same definitions <a href="#definitions">as above</a>.</p>
<p>Given <code>impl&lt;P1..=Pn&gt; Trait&lt;T1..=Tn&gt; for T0</code>, an impl is valid only if at
least one of the following is true:</p>
<ul>
<li><code>Trait</code> is a local trait</li>
<li>All of
<ul>
<li>At least one of the types <code>T0..=Tn</code> must be a local type. Let <code>Ti</code> be the
first such type.</li>
<li>No uncovered type parameters <code>P1..=Pn</code> may appear in <code>T0..Ti</code> (excluding
<code>Ti</code>)</li>
</ul>
</li>
</ul>
<p>The primary change from the rules defined in <a href="https://github.com/rust-lang/rfcs/blob/master/text/1023-rebalancing-coherence.md">RFC #1023</a> is that we only
restrict the appearance of <em>uncovered</em> type parameters. Once again, it is
important to note that for the purposes of coherence, <code>#[fundamental]</code> types are
special. <code>Box&lt;T&gt;</code> is not considered covered, and <code>Box&lt;LocalType&gt;</code> is considered
local.</p>
<p>Under this proposal, the orphan rules continue to work generally as they did
before, with one notable exception; We will permit <code>impl&lt;T&gt; ForeignTrait&lt;LocalType&gt; for ForeignType&lt;T&gt;</code>. This is completely valid under the
forward compatibility rules set in <a href="https://github.com/rust-lang/rfcs/blob/master/text/1023-rebalancing-coherence.md">RFC #1023</a>. We can demonstrate that this is
the case with the following:</p>
<ul>
<li>Any valid impl of <code>ForeignTrait</code> in a child crate must reference at least one
type that is local to the child crate.</li>
<li>The only way a parent crate can reference the type of a child crate is with a
type parameter.</li>
<li>For the impl in child crate to overlap with an impl in parent crate, the type
parameter must be uncovered.</li>
<li>Adding any impl with an uncovered type parameter is considered a major
breaking change.</li>
</ul>
<p>We can also demonstrate that it is impossible for two sibling crates to write
conflicting impls, with or without this proposal.</p>
<ul>
<li>Any valid impl of <code>ForeignTrait</code> in a child crate must reference at least one
type that is local to the child crate.</li>
<li>The only way a local type of sibling crate A could overlap with a type used in
an impl from sibling crate B is if sibling crate B used a type parameter</li>
<li>Any type parameter used by sibling crate B must be preceded by a local type</li>
<li>Sibling crate A could not possibly name a type from sibling crate B, thus that
parameter can never overlap.</li>
</ul>
<h3 id="effects-on-parent-crates"><a class="header" href="#effects-on-parent-crates">Effects on parent crates</a></h3>
<p><a href="https://github.com/rust-lang/rfcs/blob/master/text/1023-rebalancing-coherence.md">RFC #1023</a> is amended to state that adding a new impl to an existing trait is
considered a breaking change unless, given <code>impl&lt;P1..=Pn&gt; Trait&lt;T1..=Tn&gt; for T0</code>:</p>
<ul>
<li>At least one of the types <code>T0..=Tn</code> must be a local type, added in this
revision. Let <code>Ti</code> be the first such type.</li>
<li>No uncovered type parameters <code>P1..=Pn</code> appear in <code>T0..Ti</code> (excluding <code>Ti</code>)</li>
</ul>
<p>The more general way to put this rule is: “Adding an impl to an existing trait
is a breaking change if it could possibly conflict with a legal impl in a
downstream crate”.</p>
<p>This clarification is true regardless of whether the changes in this proposal
are accepted or not. Given that the compiler currently accepts <code>impl From&lt;Foo&gt; for Vec&lt;Foo&gt;</code>, adding the impl <code>impl&lt;T&gt; From&lt;T&gt; for Vec&lt;T&gt;</code> <em>must</em> be considered a
major breaking change.</p>
<p>To be specific, the following adding any of the following impls would be
considered a breaking change:</p>
<ul>
<li><code>impl&lt;T&gt; OldTrait&lt;T&gt; for OldType</code></li>
<li><code>impl&lt;T&gt; OldTrait&lt;AnyType&gt; for T</code></li>
<li><code>impl&lt;T&gt; OldTrait&lt;T&gt; for ForeignType</code></li>
</ul>
<p>However, the following impls would not be considered a breaking change:</p>
<ul>
<li><code>impl NewTrait&lt;AnyType&gt; for AnyType</code></li>
<li><code>impl&lt;T&gt; OldTrait&lt;T&gt; for NewType</code></li>
<li><code>impl&lt;T&gt; OldTrait&lt;NewType, T&gt; for OldType</code></li>
</ul>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p>The current rules around coherence are complex and hard to explain. While this
proposal feels like a natural extension of the current rules, and something many
expect to work, it does make them slightly more complex.</p>
<p>The orphan rules are often taught as “for an impl <code>impl Trait for Type</code>, either
Trait or Type must be local to your crate”. While this has never been actually
true, it’s a reasonable hand-wavy explanation, and this gets us even further
from it. Even though <code>impl From&lt;Foo&gt; for Vec&lt;()&gt;</code> has always been accepted,
<code>impl&lt;T&gt; From&lt;Foo&gt; for Vec&lt;T&gt;</code> <em>feels</em> even less local. While <code>Vec&lt;()&gt;</code> only
applies to <code>std</code>, <code>Vec&lt;T&gt;</code> now applies to types from <code>std</code> and any other crate.</p>
<h2 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h2>
<ul>
<li>
<p>Rework coherence even more deeply. The rules around the orphan rule are
complex and hard to explain. Even <code>--explain E0210</code> doesn’t actually try to
give the rationale behind them, and just states the fairly arcane formula from
the original RFC. While this proposal is a natural extension of the current
rules, and something that many expect to “just work”, it ultimately makes them
even more complex.</p>
<p>In particular, this keeps the “ordering” rule. It still serves <em>a</em> purpose
with this proposal, but much less of one. By keeping it, we are able to allow
<code>impl&lt;T&gt; SomeTrait&lt;LocalType, T&gt; for ForeignType</code>, because no sibling crate
can write an overlapping impl. However, this is not something that the
majority of library authors are aware of, and requires API designers to order
their type parameters based on how likely they are to be overridden by other
crates.</p>
<p>We could instead provide a mechanism for traits to opt into a redesigned
coherence system, and potentially default to that in a future edition.
However, that would likely cause a lot of confusion in the community. This
proposal is a strict addition to the set of impls which are allowed with the
current rules, without an increase in risk or impls which are breaking
changes. It seems like a reasonably conservative move, even if we eventually
want to overhaul coherence.</p>
</li>
<li>
<p>Get rid of the orphan rule entirely. A long standing pain point for crates
like Diesel has been integration with other crates. Diesel doesn’t want to
care about chrono, and chrono doesn’t want to care about Diesel. A database
access library shouldn’t dictate your choice of time libraries, vice versa.</p>
<p>However, due to the way Rust works today, one of them has to. Nobody can
create a <code>diesel-chrono</code> crate due to the orphan rule. Maybe if we just
allowed crates to have incompatible impls, and set a standard of “don’t write
orphan impls unless that’s the entire point of your crate”, it wouldn’t
actually be that bad.</p>
</li>
</ul>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<ul>
<li>Are there additional implementations which are clearly acceptable under the
current restrictions, which are disallowed with this extension? Should we
allow them if so?</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="2438-deny-integer-literal-overflow-lint.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="2457-non-ascii-idents.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="2438-deny-integer-literal-overflow-lint.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="2457-non-ascii-idents.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
