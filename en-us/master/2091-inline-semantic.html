<!DOCTYPE HTML>
<html lang="en_US" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2091-inline-semantic - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-0060737d.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Feature Name: <code>track_caller</code></li>
<li>Start Date: 2017-07-31</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/2091">rust-lang/rfcs#2091</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/47809">rust-lang/rust#47809</a></li>
</ul>
<hr>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Enable accurate caller location reporting during panic in <code>{Option, Result}::{unwrap, expect}</code> with
the following changes:</p>
<ol>
<li>Support the <code>#[track_caller]</code> function attribute, which guarantees a function has access to the
caller information.</li>
<li>Add an intrinsic function <code>caller_location()</code> (safe wrapper: <code>Location::caller()</code>) to retrieve
the caller‚Äôs source location.</li>
</ol>
<p>Example:</p>
<pre><code class="language-rust">#![feature(track_caller)]
use std::panic::Location;

#[track_caller]
fn unwrap(self) -&gt; T {
    panic!("{}: oh no", Location::caller());
}

let n: Option&lt;u32&gt; = None;
let m = n.unwrap();</code></pre>
<!-- TOC updateOnSave:false -->
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#guide-level-explanation">Guide-level explanation</a>
<ul>
<li><a href="#lets-reimplement-unwrap">Let‚Äôs reimplement <code>unwrap()</code></a></li>
<li><a href="#track-the-caller">Track the caller</a></li>
<li><a href="#location-type">Location type</a></li>
<li><a href="#propagation-of-tracker">Propagation of tracker</a></li>
<li><a href="#why-do-we-use-implicit-caller-location">Why do we use implicit caller location</a></li>
</ul>
</li>
<li><a href="#reference-level-explanation">Reference-level explanation</a>
<ul>
<li><a href="#survey-of-panicking-standard-functions">Survey of panicking standard functions</a></li>
<li><a href="#procedural-attribute-macro">Procedural attribute macro</a></li>
<li><a href="#redirection-mir-inlining">Redirection (MIR inlining)</a></li>
<li><a href="#standard-libraries">Standard libraries</a></li>
<li><a href="#my-fault-vs-your-fault">‚ÄúMy fault‚Äù vs ‚ÄúYour fault‚Äù</a></li>
<li><a href="#location-detail-control">Location detail control</a></li>
</ul>
</li>
<li><a href="#drawbacks">Drawbacks</a>
<ul>
<li><a href="#code-bloat">Code bloat</a></li>
<li><a href="#narrow-solution-scope">Narrow solution scope</a></li>
<li><a href="#confusing-scoping-rule">Confusing scoping rule</a></li>
</ul>
</li>
<li><a href="#rationale-and-alternatives">Rationale and alternatives</a>
<ul>
<li><a href="#rationale">Rationale</a></li>
<li><a href="#alternatives">Alternatives</a>
<ul>
<li><a href="#-name-of-everything-">üö≤ Name of everything üö≤</a></li>
<li><a href="#using-an-abi-instead-of-an-attribute">Using an ABI instead of an attribute</a></li>
<li><a href="#repurposing-file-line-column">Repurposing <code>file!()</code>, <code>line!()</code>, <code>column!()</code></a></li>
<li><a href="#inline-mir">Inline MIR</a></li>
<li><a href="#default-function-arguments">Default function arguments</a></li>
<li><a href="#semantic-inlining">Semantic inlining</a></li>
<li><a href="#design-by-contract">Design-by-contract</a></li>
</ul>
</li>
<li><a href="#non-viable-alternatives">Non-viable alternatives</a>
<ul>
<li><a href="#macros">Macros</a></li>
<li><a href="#backtrace">Backtrace</a></li>
<li><a href="#sourcecontext-generic-parameter"><code>SourceContext</code> generic parameter</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#unresolved-questions">Unresolved questions</a></li>
</ul>
<!-- /TOC -->
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>It is well-known that the error message reported by <code>unwrap()</code> is useless:</p>
<pre><code class="language-text">thread 'main' panicked at 'called `Option::unwrap()` on a `None` value', /checkout/src/libcore/option.rs:335
note: Run with `RUST_BACKTRACE=1` for a backtrace.
</code></pre>
<p>There have been numerous discussions (<a href="https://internals.rust-lang.org/t/rfrfc-better-option-result-error-messages/2904">a</a>, <a href="https://internals.rust-lang.org/t/line-info-for-unwrap-expect/3753">b</a>, <a href="https://internals.rust-lang.org/t/better-panic-location-reporting-for-unwrap-and-friends/5042">c</a>) that want <code>unwrap()</code> and friends to provide
better information to locate the panic. <a href="https://github.com/rust-lang/rfcs/pull/1669">RFC 1669</a> attempted to address this by
introducing the <code>unwrap!(x)</code> macro to the standard library, but it was closed since the <code>x.unwrap()</code>
convention is too entrenched.</p>
<p>This RFC introduces line numbers into <code>unwrap()</code> without requiring users to adapt a new
idiom, i.e. the user should be able to see the precise location without changing any source
code.</p>
<h2 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h2>
<h3 id="lets-reimplement-unwrap"><a class="header" href="#lets-reimplement-unwrap">Let‚Äôs reimplement <code>unwrap()</code></a></h3>
<p><code>unwrap()</code> and <code>expect()</code> are two methods on <code>Option</code> and <code>Result</code> that are commonly used when you
are <em>absolutely sure</em> they contain a successful value and you want to extract it.</p>
<pre><code class="language-rust">// 1.rs
use std::env::args;
fn main() {
    println!("args[1] = {}", args().nth(1).unwrap());
    println!("args[2] = {}", args().nth(2).unwrap());
    println!("args[3] = {}", args().nth(3).unwrap());
}</code></pre>
<p>If the assumption is wrong, they will panic and tell you that an error is unexpected.</p>
<pre><code class="language-text">$ ./1
thread 'main' panicked at 'called `Option::unwrap()` on a `None` value', 1.rs:4:29
note: Run with `RUST_BACKTRACE=1` for a backtrace.

$ ./1 arg1
args[1] = arg1
thread 'main' panicked at 'called `Option::unwrap()` on a `None` value', 1.rs:5:29
note: Run with `RUST_BACKTRACE=1` for a backtrace.

$ ./1 arg1 arg2
args[1] = arg1
args[2] = arg2
thread 'main' panicked at 'called `Option::unwrap()` on a `None` value', 1.rs:6:29
note: Run with `RUST_BACKTRACE=1` for a backtrace.

$ ./1 arg1 arg2 arg3
args[1] = arg1
args[2] = arg2
args[3] = arg3
</code></pre>
<p>Let‚Äôs say you are unhappy with these built-in functions, e.g. you want to provide an alternative
error message:</p>
<pre><code class="language-rust">// 2.rs
use std::env::args;
pub fn my_unwrap&lt;T&gt;(input: Option&lt;T&gt;) -&gt; T {
    match input {
        Some(t) =&gt; t,
        None =&gt; panic!("nothing to see here, move along"),
    }
}
fn main() {
    println!("args[1] = {}", my_unwrap(args().nth(1)));
    println!("args[2] = {}", my_unwrap(args().nth(2)));
    println!("args[3] = {}", my_unwrap(args().nth(3)));
}</code></pre>
<p>This trivial implementation, however, will only report the panic that happens inside <code>my_unwrap</code>. This is
pretty useless since it is the caller of <code>my_unwrap</code> that made the wrong assumption!</p>
<pre><code class="language-text">$ ./2
thread 'main' panicked at 'nothing to see here, move along', 2.rs:5:16
note: Run with `RUST_BACKTRACE=1` for a backtrace.

$ ./2 arg1
args[1] = arg1
thread 'main' panicked at 'nothing to see here, move along', 2.rs:5:16
note: Run with `RUST_BACKTRACE=1` for a backtrace.

$ ./2 arg1 arg2
args[1] = arg1
args[2] = arg2
thread 'main' panicked at 'nothing to see here, move along', 2.rs:5:16
note: Run with `RUST_BACKTRACE=1` for a backtrace.

$ ./2 arg1 arg2 arg3
args[1] = arg1
args[2] = arg2
args[3] = arg3
</code></pre>
<p>The trivial solution would require the user to provide <code>file!()</code>, <code>line!()</code> and <code>column!()</code>. A
slightly more ergonomic solution would be changing <code>my_unwrap</code> into a macro, allowing these constants to
be automatically provided.</p>
<pre><code class="language-rust">pub fn my_unwrap_at_source_location&lt;T&gt;(input: Option&lt;T&gt;, file: &amp;str, line: u32, column: u32) -&gt; T {
    match input {
        Some(t) =&gt; t,
        None =&gt; panic!("nothing to see at {}:{}:{}, move along", file, line, column),
    }
}

macro_rules! my_unwrap {
    ($input:expr) =&gt; {
        my_unwrap_at_source_location($input, file!(), line!(), column!())
    }
}
println!("args[1] = {}", my_unwrap!(args().nth(1)));
//                                ^ tell user to add an `!`.
...</code></pre>
<p>What if you have already published the <code>my_unwrap</code> crate that has thousands of users, and you
want to maintain API stability? Before Rust 1.XX, the builtin <code>unwrap()</code> had the same problem!</p>
<h3 id="track-the-caller"><a class="header" href="#track-the-caller">Track the caller</a></h3>
<p>The reason the <code>my_unwrap!</code> macro works is because it copy-and-pastes the entire content of its macro
definition every time it is used.</p>
<pre><code class="language-rust">println!("args[1] = {}", my_unwrap!(args().nth(1)));
println!("args[2] = {}", my_unwrap!(args().nth(2)));
...

// is equivalent to:

println!("args[1] = {}", my_unwrap(args().nth(1), file!(), line!(), column!()));
println!("args[1] = {}", my_unwrap(args().nth(2), file!(), line!(), column!()));
...</code></pre>
<p>What if we could instruct the compiler to automatically fill in the file, line, and column?
Rust 1.YY introduced the <code>#[track_caller]</code> attribute for exactly this reason:</p>
<pre><code class="language-rust">// 3.rs
#![feature(track_caller)]
use std::env::args;
#[track_caller]  // &lt;-- Just add this!
pub fn my_unwrap&lt;T&gt;(input: Option&lt;T&gt;) -&gt; T {
    match input {
        Some(t) =&gt; t,
        None =&gt; panic!("nothing to see here, move along"),
    }
}
fn main() {
    println!("args[1] = {}", my_unwrap(args().nth(1)));
    println!("args[2] = {}", my_unwrap(args().nth(2)));
    println!("args[3] = {}", my_unwrap(args().nth(3)));
}</code></pre>
<p>Now we have truly reproduced how the built-in <code>unwrap()</code> is implemented.</p>
<pre><code class="language-text">$ ./3
thread 'main' panicked at 'nothing to see here, move along', 3.rs:12:29
note: Run with `RUST_BACKTRACE=1` for a backtrace.

$ ./3 arg1
args[1] = arg1
thread 'main' panicked at 'nothing to see here, move along', 3.rs:13:29
note: Run with `RUST_BACKTRACE=1` for a backtrace.

$ ./3 arg1 arg2
args[1] = arg1
args[2] = arg2
thread 'main' panicked at 'nothing to see here, move along', 3.rs:14:29
note: Run with `RUST_BACKTRACE=1` for a backtrace.

$ ./3 arg1 arg2 arg3
args[1] = arg1
args[2] = arg2
args[3] = arg3
</code></pre>
<p><code>#[track_caller]</code> is an automated version of what you‚Äôve seen in the last section. The attribute
copies <code>my_unwrap</code> to a new function <code>my_unwrap_at_source_location</code> which accepts the caller‚Äôs
location as an additional argument. The attribute also instructs the compiler to replace
<code>my_unwrap(x)</code> with <code>my_unwrap_at_source_location(x, file!(), line!(), column!())</code> (sort of)
whenever it sees it. This allows us to maintain the stability guarantee while allowing the user to
get the new behavior with just one recompile.</p>
<h3 id="location-type"><a class="header" href="#location-type">Location type</a></h3>
<p>Let‚Äôs enhance <code>my_unwrap</code> to also log a message to the log file before panicking. We would need to
get the caller‚Äôs location as a value. This is supported using the method <code>Location::caller()</code>:</p>
<pre><code class="language-rust">use std::panic::Location;
#[track_caller]
pub fn my_unwrap&lt;T&gt;(input: Option&lt;T&gt;) -&gt; T {
    match input {
        Some(t) =&gt; t,
        None =&gt; {
            let location = Location::caller();
            println!("unwrapping a None from {}:{}", location.file(), location.line());
            panic!("nothing to see here, move along")
        }
    }
}</code></pre>
<h3 id="propagation-of-tracker"><a class="header" href="#propagation-of-tracker">Propagation of tracker</a></h3>
<p>When your <code>#[track_caller]</code> function calls another <code>#[track_caller]</code> function, the caller location
will be propagated downwards:</p>
<pre><code class="language-rust">use std::panic::Location;
#[track_caller]
pub fn my_get_index&lt;T&gt;(input: &amp;[T], index: usize) -&gt; &amp;T {
    my_unwrap(input.get(index))        // line 4
}
indirectly_unwrap(None);    // line 6</code></pre>
<p>When you run this, the panic will refer to line 6, the original caller, instead of line 4 where
<code>my_get_index</code> calls <code>my_unwrap</code>. When a library function is marked <code>#[track_caller]</code>, it is
expected the function is short, and does not have any logic errors. This allows us to always track
the caller on failure.</p>
<p>If a panic that refers to the local location is actually needed, you may workaround by wrapping the
code in a closure which cannot track the caller:</p>
<pre><code class="language-rust">#[track_caller]
pub fn my_get_index&lt;T&gt;(input: &amp;[T], index: usize) -&gt; &amp;T {
    (|| {
        my_unwrap(input.get(index))
    })()
}</code></pre>
<h3 id="why-do-we-use-implicit-caller-location"><a class="header" href="#why-do-we-use-implicit-caller-location">Why do we use implicit caller location</a></h3>
<p>If you are learning Rust alongside other languages, you may wonder why Rust obtains the caller
information in such a strange way. There are two restrictions that force us to adopt this solution:</p>
<ol>
<li>
<p>Programmatic access to the stack backtrace is often used in interpreted or runtime-heavy
languages like Python and Java. However, the stack backtrace is not suitable as the only
solution for systems languages like Rust because optimization often collapses multiple levels
of function calls.  In some embedded systems, the backtrace may even be unavailable!</p>
</li>
<li>
<p>Solutions that use default function arguments alongside normal arguments are often used in
languages that do not perform inference higher than statement level, e.g. Swift and C#. Rust
does not (yet) support default function arguments or function overloading because they interfere
with type inference, so such solutions are ruled out.</p>
</li>
</ol>
<h2 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h2>
<h3 id="survey-of-panicking-standard-functions"><a class="header" href="#survey-of-panicking-standard-functions">Survey of panicking standard functions</a></h3>
<p>Many standard functions may panic. These are divided into three categories depending on whether they
should receive caller information despite the inlining cost associated with it.</p>
<p>The list of functions is not exhaustive. Only those with a ‚ÄúPanics‚Äù section in the documentation
are included.</p>
<ol>
<li>
<p><strong>Must have.</strong> These functions are designed to generate a panic, or used so often that indicating
a panic happening from them often gives no useful information.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">Function</th><th style="text-align: left">Panic condition</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><code>Option::expect</code></td><td style="text-align: left">self is None</td></tr>
<tr><td style="text-align: left"><code>Option::unwrap</code></td><td style="text-align: left">self is None</td></tr>
<tr><td style="text-align: left"><code>Result::expect_err</code></td><td style="text-align: left">self is Ok</td></tr>
<tr><td style="text-align: left"><code>Result::expect</code></td><td style="text-align: left">self is Err</td></tr>
<tr><td style="text-align: left"><code>Result::unwrap_err</code></td><td style="text-align: left">self is Ok</td></tr>
<tr><td style="text-align: left"><code>Result::unwrap</code></td><td style="text-align: left">self is Err</td></tr>
<tr><td style="text-align: left"><code>[T]::index_mut</code></td><td style="text-align: left">range out of bounds</td></tr>
<tr><td style="text-align: left"><code>[T]::index</code></td><td style="text-align: left">range out of bounds</td></tr>
<tr><td style="text-align: left"><code>BTreeMap::index</code></td><td style="text-align: left">key not found</td></tr>
<tr><td style="text-align: left"><code>HashMap::index</code></td><td style="text-align: left">key not found</td></tr>
<tr><td style="text-align: left"><code>str::index_mut</code></td><td style="text-align: left">range out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>str::index</code></td><td style="text-align: left">range out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>VecDeque::index_mut</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>VecDeque::index</code></td><td style="text-align: left">index out of bounds</td></tr>
</tbody>
</table>
</div>
</li>
<li>
<p><strong>Nice to have.</strong> These functions are not commonly used, or the panicking condition is pretty
rare. Often the panic information contains enough clue to fix the error without a backtrace.
Inlining them would bloat the binary size without much benefit.</p>
 <details><summary>List of category 2 functions</summary>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">Function</th><th style="text-align: left">Panic condition</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><code>std::env::args</code></td><td style="text-align: left">non UTF-8 values</td></tr>
<tr><td style="text-align: left"><code>std::env::set_var</code></td><td style="text-align: left">invalid key or value</td></tr>
<tr><td style="text-align: left"><code>std::env::vars</code></td><td style="text-align: left">non UTF-8 values</td></tr>
<tr><td style="text-align: left"><code>std::thread::spawn</code></td><td style="text-align: left">OS failed to create the thread</td></tr>
<tr><td style="text-align: left"><code>[T]::clone_from_slice</code></td><td style="text-align: left">slice lengths differ</td></tr>
<tr><td style="text-align: left"><code>[T]::copy_from_slice</code></td><td style="text-align: left">slice lengths differ</td></tr>
<tr><td style="text-align: left"><code>[T]::rotate</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>[T]::split_at_mut</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>[T]::swap</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>BinaryHeap::reserve_exact</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>BinaryHeap::reserve</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>Duration::new</code></td><td style="text-align: left">arithmetic overflow</td></tr>
<tr><td style="text-align: left"><code>HashMap::reserve</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>HashSet::reserve</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>i32::overflowing_div</code></td><td style="text-align: left">zero divisor</td></tr>
<tr><td style="text-align: left"><code>i32::overflowing_rem</code></td><td style="text-align: left">zero divisor</td></tr>
<tr><td style="text-align: left"><code>i32::wrapping_div</code></td><td style="text-align: left">zero divisor</td></tr>
<tr><td style="text-align: left"><code>i32::wrapping_rem</code></td><td style="text-align: left">zero divisor</td></tr>
<tr><td style="text-align: left"><code>Instance::duration_since</code></td><td style="text-align: left">time travel</td></tr>
<tr><td style="text-align: left"><code>Instance::elapsed</code></td><td style="text-align: left">time travel</td></tr>
<tr><td style="text-align: left"><code>Iterator::count</code></td><td style="text-align: left">extremely long iterator</td></tr>
<tr><td style="text-align: left"><code>Iterator::enumerate</code></td><td style="text-align: left">extremely long iterator</td></tr>
<tr><td style="text-align: left"><code>Iterator::position</code></td><td style="text-align: left">extremely long iterator</td></tr>
<tr><td style="text-align: left"><code>Iterator::product</code></td><td style="text-align: left">arithmetic overflow in debug build</td></tr>
<tr><td style="text-align: left"><code>Iterator::sum</code></td><td style="text-align: left">arithmetic overflow in debug build</td></tr>
<tr><td style="text-align: left"><code>LinkedList::split_off</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>LocalKey::with</code></td><td style="text-align: left">TLS has been destroyed</td></tr>
<tr><td style="text-align: left"><code>RawVec::double_in_place</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>RawVec::double</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>RawVec::reserve_exact</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>RawVec::reserve_in_place</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>RawVec::reserve</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>RawVec::shrink_to_fit</code></td><td style="text-align: left">given amount is larger than current capacity</td></tr>
<tr><td style="text-align: left"><code>RawVec::with_capacity</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>RefCell::borrow_mut</code></td><td style="text-align: left">a borrow or mutable borrow is active</td></tr>
<tr><td style="text-align: left"><code>RefCell::borrow</code></td><td style="text-align: left">a mutable borrow is active</td></tr>
<tr><td style="text-align: left"><code>str::split_at_mut</code></td><td style="text-align: left">range out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>str::split_at</code></td><td style="text-align: left">range out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>String::drain</code></td><td style="text-align: left">range out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>String::insert_str</code></td><td style="text-align: left">index out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>String::insert</code></td><td style="text-align: left">index out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>String::remove</code></td><td style="text-align: left">index out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>String::reserve_exact</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>String::reserve</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>String::splice</code></td><td style="text-align: left">range out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>String::split_off</code></td><td style="text-align: left">index out of bounds or off char boundary</td></tr>
<tr><td style="text-align: left"><code>String::truncate</code></td><td style="text-align: left">off char boundary</td></tr>
<tr><td style="text-align: left"><code>Vec::append</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>Vec::drain</code></td><td style="text-align: left">range out of bounds</td></tr>
<tr><td style="text-align: left"><code>Vec::insert</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>Vec::push</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>Vec::remove</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>Vec::reserve_exact</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>Vec::reserve</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>Vec::splice</code></td><td style="text-align: left">range out of bounds</td></tr>
<tr><td style="text-align: left"><code>Vec::split_off</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>Vec::swap_remove</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>VecDeque::append</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>VecDeque::drain</code></td><td style="text-align: left">range out of bounds</td></tr>
<tr><td style="text-align: left"><code>VecDeque::insert</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>VecDeque::reserve_exact</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>VecDeque::reserve</code></td><td style="text-align: left">capacity overflow</td></tr>
<tr><td style="text-align: left"><code>VecDeque::split_off</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>VecDeque::swap</code></td><td style="text-align: left">index out of bounds</td></tr>
<tr><td style="text-align: left"><code>VecDeque::with_capacity</code></td><td style="text-align: left">capacity overflow</td></tr>
</tbody>
</table>
</div>
 </details>
</li>
<li>
<p><strong>Not needed.</strong> Panics from these indicate silly programmer error and the panic itself has
enough clue to let programmers figure out where the error comes from.</p>
 <details><summary>List of category 3 functions</summary>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">Function</th><th style="text-align: left">Panic condition</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><code>std::atomic::fence</code></td><td style="text-align: left">using invalid atomic ordering</td></tr>
<tr><td style="text-align: left"><code>std::char::from_digit</code></td><td style="text-align: left">radix is outside <code>2 ..= 36</code></td></tr>
<tr><td style="text-align: left"><code>std::env::remove_var</code></td><td style="text-align: left">invalid key</td></tr>
<tr><td style="text-align: left"><code>std::format!</code></td><td style="text-align: left">the <code>fmt</code> method returns Err</td></tr>
<tr><td style="text-align: left"><code>std::panicking::set_hook</code></td><td style="text-align: left">called in panicking thread</td></tr>
<tr><td style="text-align: left"><code>std::panicking::take_hook</code></td><td style="text-align: left">called in panicking thread</td></tr>
<tr><td style="text-align: left"><code>[T]::chunks_mut</code></td><td style="text-align: left">chunk size == 0</td></tr>
<tr><td style="text-align: left"><code>[T]::chunks</code></td><td style="text-align: left">chunk size == 0</td></tr>
<tr><td style="text-align: left"><code>[T]::windows</code></td><td style="text-align: left">window size == 0</td></tr>
<tr><td style="text-align: left"><code>AtomicUsize::compare_exchange_weak</code></td><td style="text-align: left">using invalid atomic ordering</td></tr>
<tr><td style="text-align: left"><code>AtomicUsize::compare_exchange</code></td><td style="text-align: left">using invalid atomic ordering</td></tr>
<tr><td style="text-align: left"><code>AtomicUsize::load</code></td><td style="text-align: left">using invalid atomic ordering</td></tr>
<tr><td style="text-align: left"><code>AtomicUsize::store</code></td><td style="text-align: left">using invalid atomic ordering</td></tr>
<tr><td style="text-align: left"><code>BorrowRef::clone</code></td><td style="text-align: left">borrow counter overflows, see <a href="https://github.com/rust-lang/rust/issues/33880">issue 33880</a></td></tr>
<tr><td style="text-align: left"><code>BTreeMap::range_mut</code></td><td style="text-align: left">end of range before start of range</td></tr>
<tr><td style="text-align: left"><code>BTreeMap::range</code></td><td style="text-align: left">end of range before start of range</td></tr>
<tr><td style="text-align: left"><code>char::encode_utf16</code></td><td style="text-align: left">dst buffer smaller than <code>[u16; 2]</code></td></tr>
<tr><td style="text-align: left"><code>char::encode_utf8</code></td><td style="text-align: left">dst buffer smaller than <code>[u8; 4]</code></td></tr>
<tr><td style="text-align: left"><code>char::is_digit</code></td><td style="text-align: left">radix is outside <code>2 ..= 36</code></td></tr>
<tr><td style="text-align: left"><code>char::to_digit</code></td><td style="text-align: left">radix is outside <code>2 ..= 36</code></td></tr>
<tr><td style="text-align: left"><code>compiler_fence</code></td><td style="text-align: left">using invalid atomic ordering</td></tr>
<tr><td style="text-align: left"><code>Condvar::wait</code></td><td style="text-align: left">waiting on multiple different mutexes</td></tr>
<tr><td style="text-align: left"><code>Display::to_string</code></td><td style="text-align: left">the <code>fmt</code> method returns Err</td></tr>
<tr><td style="text-align: left"><code>ExactSizeIterator::len</code></td><td style="text-align: left">size_hint implemented incorrectly</td></tr>
<tr><td style="text-align: left"><code>i32::from_str_radix</code></td><td style="text-align: left">radix is outside <code>2 ..= 36</code></td></tr>
<tr><td style="text-align: left"><code>Iterator::step_by</code></td><td style="text-align: left">step == 0</td></tr>
</tbody>
</table>
</div>
 </details>
</li>
</ol>
<p>This RFC only advocates adding the <code>#[track_caller]</code> attribute to the <code>unwrap</code> and <code>expect</code>
functions. The <code>index</code> and <code>index_mut</code> functions should also have it if possible, but this is
currently postponed as it is not investigated yet how to insert the transformation after
monomorphization.</p>
<h3 id="procedural-attribute-macro"><a class="header" href="#procedural-attribute-macro">Procedural attribute macro</a></h3>
<p>The <code>#[track_caller]</code> attribute will modify a function at the AST and MIR levels without touching
the type-checking (HIR level) or the low-level LLVM passes.</p>
<p>It will first wrap the body of the function in a closure, and then call it:</p>
<pre><code class="language-rust">#[track_caller]
fn foo&lt;C&gt;(x: A, y: B, z: C) -&gt; R {
    bar(x, y)
}

// will become:

#[rustc_implicit_caller_location]
#[inline]
fn foo&lt;C&gt;(x: A, y: B, z: C) -&gt; R {
    std::ops::FnOnce::call_once(move |__location| {
        bar(x, y)
    }, (unsafe { std::intrinsics::caller_location() },))
}</code></pre>
<p>This is to split the function into two: the function <code>foo</code> itself, and the closure
<code>foo::{{closure}}</code> in it. (Technically: it is the simplest way to create two <code>DefId</code>s at the HIR
level as far as I know.)</p>
<p>The function signature of <code>foo</code> remains unchanged, so typechecking can proceed normally. The
attribute will be replaced by <code>#[rustc_implicit_caller_location]</code> to let the compiler internals
continue to treat it specially. <code>#[inline]</code> is added so external crates can see through <code>foo</code> to
find <code>foo::{{closure}}</code>.</p>
<p>The closure <code>foo::{{closure}}</code> is a proper function so that the compiler can write calls directly to
<code>foo::{{closure}}</code>, skipping <code>foo</code>. Multiple calls to <code>foo</code> from different locations can be done via
calling <code>foo::{{closure}}</code> directly, instead of copying the function body every time which would
bloat the binary size.</p>
<p>The intrinsic <code>caller_location()</code> is a placeholder which will be replaced by the actual caller
location when one calls <code>foo::{{closure}}</code> directly.</p>
<p>Currently the <code>foo::{{closure}}</code> cannot inherit attributes defined on the main function. To prevent
problems regarding ABI, using <code>#[naked]</code> or <code>extern "ABI"</code> together with
<code>#[rustc_implicit_caller_location]</code> should raise an error.</p>
<h3 id="redirection-mir-inlining"><a class="header" href="#redirection-mir-inlining">Redirection (MIR inlining)</a></h3>
<p>After all type-checking and validation is done, we can now inject the caller location. This is done
by redirecting all calls to <code>foo</code> to <code>foo::{{closure}}</code>.</p>
<pre><code class="language-rust">_r = call foo(_1, _2, _3) -&gt; 'bb1;

// will become:

_c = call std::intrinsics::caller_location() -&gt; 'bbt;
'bbt:
_r = call foo::{{closure}} (&amp;[closure: x: _1, y: _2], _c) -&gt; 'bb1;</code></pre>
<p>We will further replace the <code>caller_location()</code> intrinsic according to where <code>foo</code> is called.
If it is called from an ordinary function, it would be replaced by the callsite‚Äôs location:</p>
<pre><code class="language-rust">// for ordinary functions,

_c = call std::intrinsics::caller_location() -&gt; 'bbt;

// will become:

_c = Location { file: file!(), line: line!(), column: column!() };
goto -&gt; 'bbt;</code></pre>
<p>If it is called from an <code>#[rustc_implicit_caller_location]</code>‚Äôs closure e.g. <code>foo::{{closure}}</code>, the
intrinsic will be replaced by the closure argument <code>__location</code> instead, so that the caller location
can propagate directly</p>
<pre><code class="language-rust">// for #[rustc_implicit_caller_location] closures,

_c = call std::intrinsics::caller_location() -&gt; 'bbt;

// will become:

_c = __location;
goto -&gt; 'bbt;</code></pre>
<p>These steps are very similar to inlining, and thus the first proof-of-concept is implemented
directly as a variant of the MIR inliner (but a separate pass). This also means the redirection pass
currently suffers from all disadvantages of the MIR inliner, namely:</p>
<ul>
<li>
<p>Locations will not be propagated into diverging functions (<code>fn() -&gt; !</code>), since inlining them is
not supported yet.</p>
</li>
<li>
<p>MIR passes are run <em>before</em> monomorphization, meaning <code>#[track_caller]</code> currently <strong>cannot</strong> be
used on trait items:</p>
</li>
</ul>
<pre><code class="language-rust">trait Trait {
    fn unwrap(&amp;self);
}
impl Trait for u64 {
    #[track_caller] //~ ERROR: `#[track_caller]` is not supported for trait items yet.
    fn unwrap(&amp;self) {}
}</code></pre>
<p>To support trait items, the redirection pass must be run as post-monomorphized MIR pass (which does
not exist yet), or converted to queries provided after resolve, or a custom LLVM inlining pass which
can extract the caller‚Äôs source location. This prevents the <code>Index</code> trait from having
<code>#[track_caller]</code> yet.</p>
<p>We cannot hack the impl resolution method into pre-monomorphization MIR pass because of deeply
nested functions like</p>
<pre><code class="language-rust">f1::&lt;u32&gt;();

fn f1&lt;T: Trait&gt;() { f2::&lt;T&gt;(); }
fn f2&lt;T: Trait&gt;() { f3::&lt;T&gt;(); }
fn f3&lt;T: Trait&gt;() { f4::&lt;T&gt;(); }
...
fn f100&lt;T: Trait&gt;() {
    T::unwrap(); // No one will know T is u32 before monomophization.
}</code></pre>
<p>Currently the redirection pass always runs before the inlining pass. If the redirection pass is run
after the normal MIR inlining pass, the normal MIR inliner must treat
<code>#[rustc_implicit_caller_location]</code> as <code>#[inline(never)]</code>.</p>
<p>The closure <code>foo::{{closure}}</code> must never be inlined before the redirection pass.</p>
<p>When <code>#[rustc_implicit_caller_location]</code> functions are called dynamically, no inlining will occur,
and thus it cannot take the location of the caller. Currently this will report where the function is
declared. Taking the address of such functions must be allowed due to backward compatibility. (If
a post-monomorphized MIR pass exists, methods via trait objects would be another case of calling
<code>#[rustc_implicit_caller_location]</code> functions without caller location.)</p>
<pre><code class="language-rust">let f: fn(Option&lt;u32&gt;) -&gt; u32 = Option::unwrap;
let g: fn(Option&lt;u32&gt;) -&gt; u32 = Option::unwrap;
assert!(f == g); // This must remain `true`.
f(None);
g(None); // The effect of these two calls must be the same.</code></pre>
<h3 id="standard-libraries"><a class="header" href="#standard-libraries">Standard libraries</a></h3>
<p>The <code>caller_location()</code> intrinsic returns the <code>Location</code> structure which encodes the file, line and
column of the callsite. This shares the same structure as the existing type <code>std::panic::Location</code>.
Therefore, the type is promoted to a lang-item, and moved into <code>core::panicking::Location</code>. It is
re-exported from <code>libstd</code>.</p>
<p>Thanks to how <code>#[track_caller]</code> is implemented, we could provide a safe wrapper around the
<code>caller_location()</code> intrinsic:</p>
<pre><code class="language-rust">impl&lt;'a&gt; Location&lt;'a&gt; {
    #[track_caller]
    pub fn caller() -&gt; Location&lt;'static&gt; {
        unsafe {
            ::intrinsics::caller_location()
        }
    }
}</code></pre>
<p>The <code>panic!</code> macro is modified to use <code>Location::caller()</code> (or the intrinsic directly) so it can
report the caller location inside <code>#[track_caller]</code>.</p>
<pre><code class="language-rust">macro_rules! panic {
    ($msg:expr) =&gt; {
        let loc = $crate::panicking::Location::caller();
        $crate::panicking::panic(&amp;($msg, loc.file(), loc.line(), loc.column()))
    };
    ...
}</code></pre>
<p>Actually this is now more natural for <code>core::panicking::panic_fmt</code> to take <code>Location</code> directly
instead of tuples, so one should consider changing their signature, but this is out-of-scope for
this RFC.</p>
<p><code>panic!</code> is often used outside of <code>#[track_caller]</code> functions. In those cases, the
<code>caller_location()</code> intrinsic will pass unchanged through all MIR passes into trans. As a fallback,
the intrinsic will expand to <code>Location { file: file!(), line: line!(), col: column!() }</code> during
trans.</p>
<h3 id="my-fault-vs-your-fault"><a class="header" href="#my-fault-vs-your-fault">‚ÄúMy fault‚Äù vs ‚ÄúYour fault‚Äù</a></h3>
<p>In a <code>#[track_caller]</code> function, we expect all panics being attributed to the caller (thus the
attribute name). However, sometimes the code panics not due to the caller, but the implementation
itself. It may be important to distinguish between ‚Äúmy fault‚Äù (implementation error) and
‚Äúyour fault‚Äù (caller violating API requirement). As an example,</p>
<pre><code class="language-rust">use std::collections::HashMap;
use std::hash::Hash;

fn count_slices&lt;T: Hash + Eq&gt;(array: &amp;[T], window: usize) -&gt; HashMap&lt;&amp;[T], usize&gt; {
    if !(0 &lt; window &amp;&amp; window &lt;= array.len()) {
        panic!("invalid window size");
        // ^ triggering this panic is "your fault"
    }
    let mut result = HashMap::new();
    for w in array.windows(window) {
        if let Some(r) = result.get_mut(w) {
            *r += 1;
        } else {
            panic!("why??");
            // ^ triggering this panic is "my fault"
            //   (yes this code is wrong and entry API should be used)
        }
    }

    result
}</code></pre>
<p>One simple solution is to separate the ‚Äúmy fault‚Äù panic and ‚Äúyour fault‚Äù panic into two, but since
<a href="https://github.com/rust-lang/rust/pull/39229#issuecomment-274348420">declarative macro 1.0 is insta-stable</a>, this RFC would prefer to postpone introducing
any new public macros until ‚ÄúMacros 2.0‚Äù lands, where stability and scoping are better handled.</p>
<p>For comparison, the Swift language does
<a href="https://stackoverflow.com/questions/29673027/difference-between-precondition-and-assert-in-swift">distinguish between the two kinds of panics semantically</a>. The ‚Äúyour fault‚Äù ones are
called <code>precondition</code>, while the ‚Äúmy fault‚Äù ones are called <code>assert</code>, though they don‚Äôt deal with
caller location, and practically they are equivalent to Rust‚Äôs <code>assert!</code> and <code>debug_assert!</code>.
Nevertheless, this also suggests we can still separate existing panicking macros into the ‚Äúmy fault‚Äù
and ‚Äúyour fault‚Äù camps accordingly:</p>
<ul>
<li>Definitely ‚Äúmy fault‚Äù (use actual location): <code>debug_assert!</code> and friends, <code>unreachable!</code>,
<code>unimplemented!</code></li>
<li>Probably ‚Äúyour fault‚Äù (propagate caller location): <code>assert!</code> and friends, <code>panic!</code></li>
</ul>
<p>The question is, should calling <code>unwrap()</code>, <code>expect()</code> and <code>x[y]</code> (<code>index()</code>) be ‚Äúmy fault‚Äù or ‚Äúyour
fault‚Äù? Let‚Äôs consider existing implementation of <code>index()</code> methods:</p>
<pre><code class="language-rust">// Vec::index
fn index(&amp;self, index: usize) -&gt; &amp;T {
    &amp;(**self)[index]
}

// BTreeMap::index
fn index(&amp;self, key: &amp;Q) -&gt; &amp;V {
    self.get(key).expect("no entry found for key")
}

// Wtf8::index
fn index(&amp;self, range: ops::RangeFrom&lt;usize&gt;) -&gt; &amp;Wtf8 {
    // is_code_point_boundary checks that the index is in [0, .len()]
    if is_code_point_boundary(self, range.start) {
        unsafe { slice_unchecked(self, range.start, self.len()) }
    } else {
        slice_error_fail(self, range.start, self.len())
    }
}</code></pre>
<p>If they all get <code>#[track_caller]</code>, the <code>x[y]</code>, <code>expect()</code> and <code>slice_error_fail()</code> should all report
‚Äúyour fault‚Äù, i.e. caller location should be propagated downstream. It does mean that the current
default of caller-location-propagation-by-default is more common. This also means ‚Äúmy fault‚Äù
happening during development may become harder to spot. This can be solved using <code>RUST_BACKTRACE=1</code>,
or workaround by splitting into two functions:</p>
<pre><code class="language-rust">use std::collections::HashMap;
use std::hash::Hash;

#[track_caller]
fn count_slices&lt;T: Hash + Eq&gt;(array: &amp;[T], window: usize) -&gt; HashMap&lt;&amp;[T], usize&gt; {
    if !(0 &lt; window &amp;&amp; window &lt;= array.len()) {
        panic!("invalid window size");  // &lt;-- your fault
    }
    (|| {
        let mut result = HashMap::new();
        for w in array.windows(window) {
            if let Some(r) = result.get_mut(w) {
                *r += 1;
            } else {
                panic!("why??"); // &lt;-- my fault (caller propagation can't go into closures)
            }
        }
        result
    })()
}</code></pre>
<p>Anyway, treating everything as ‚Äúyour fault‚Äù will encourage that <code>#[track_caller]</code> functions should
be short, which goes in line with the <a href="#survey-of-panicking-standard-functions">‚Äúmust have‚Äù list</a> in
the RFC. Thus the RFC will remain advocating for propagating caller location implicitly.</p>
<h3 id="location-detail-control"><a class="header" href="#location-detail-control">Location detail control</a></h3>
<p>An unstable flag <code>-Z location-detail</code> is added to <code>rustc</code> to control how much factual detail will
be emitted when using <code>caller_location()</code>. The user can toggle <code>file</code>, <code>line</code> and <code>column</code> separately,
e.g. when compiling with:</p>
<pre><code class="language-sh">rustc -Zlocation-detail=line
</code></pre>
<p>only the line number will be real. The file and column will always be a dummy value like</p>
<pre><code>thread 'main' panicked at 'error message', &lt;redacted&gt;:192:0
</code></pre>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<h3 id="code-bloat"><a class="header" href="#code-bloat">Code bloat</a></h3>
<p>Previously, all calls to <code>unwrap()</code> and <code>expect()</code> referred to the same location. Therefore, the
panicking branch will only needed to reuse a pointer to a single global tuple.</p>
<p>After this RFC is implemented, the panicking branch will need to allocate space to store the varying caller location,
so the number of instructions per <code>unwrap()</code>/<code>expect()</code> will increase.</p>
<p>The optimizer will lose the opportunity to consolidate all jumps to the panicking branch. Before
this RFC, LLVM would optimize <code>a.unwrap() + b.unwrap()</code>, to something like</p>
<pre><code class="language-rust">if (a.tag != SOME || b.tag != SOME) {
    panic(&amp;("called `Option::unwrap()` on a `None` value", "src/libcore/option.rs", 335, 20));
}
a.value_of_some + b.value_of_some</code></pre>
<p>After this RFC, LLVM can only lower this to</p>
<pre><code class="language-rust">if (a.tag != SOME) {
    panic(&amp;("called `Option::unwrap()` on a `None` value", "1.rs", 1, 1));
}
if (b.tag != SOME) {
    panic(&amp;("called `Option::unwrap()` on a `None` value", "1.rs", 1, 14));
}
a.value_of_some + b.value_of_some</code></pre>
<p>One can use <code>-Z location-detail</code> to get the old optimization behavior.</p>
<h3 id="narrow-solution-scope"><a class="header" href="#narrow-solution-scope">Narrow solution scope</a></h3>
<p><code>#[track_caller]</code> is only useful in solving the ‚Äúget caller location‚Äù problem. Introducing an
entirely new feature just for this problem seems wasteful.</p>
<p><a href="#default-function-arguments">Default function arguments</a> is another possible solution for this
problem but with much wider application.</p>
<h3 id="confusing-scoping-rule"><a class="header" href="#confusing-scoping-rule">Confusing scoping rule</a></h3>
<p>Consts, statics and closures are separate MIR items, meaning the following marked places will <em>not</em>
get caller locations:</p>
<pre><code class="language-rust">#[track_caller]
fn foo() {
    static S: Location = Location::caller(); // will get actual location instead
    let f = || Location::caller();   // will get actual location instead
    Location::caller(); // this one will get caller location
}</code></pre>
<p>This is confusing, but if we don‚Äôt support this, we will need two <code>panic!</code> macros which is not a
better solution.</p>
<p>Clippy could provide a lint against using <code>Location::caller()</code> outside of <code>#[track_caller]</code>.</p>
<h2 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h2>
<h3 id="rationale"><a class="header" href="#rationale">Rationale</a></h3>
<p>This RFC tries to abide by the following restrictions:</p>
<ol>
<li>
<p><strong>Precise caller location</strong>. Standard library functions which commonly panic will report the
source location as where the user called them. The source location should never point inside the
standard library. Examples of these functions include <code>Option::unwrap</code> and <code>HashMap::index</code>.</p>
</li>
<li>
<p><strong>Source compatibility</strong>. Users should never need to modify existing source code to benefit from
the improved precision.</p>
</li>
<li>
<p><strong>Debug-info independence</strong>. The precise caller location can still be reported even after
stripping of debug information, which is very common on released software.</p>
</li>
<li>
<p><strong>Interface independence</strong>. The implementation of a trait should be able to decide whether to
accepts the caller information; it shouldn‚Äôt require the trait itself to enforce it. It
should not affect the signature of the function. This is an extension of rule 2, since the
<code>Index</code> trait is involved in <code>HashMap::index</code>. The stability of <code>Index</code> must be upheld, e.g. it
should remain object-safe, and existing implementations should not be forced to accept the caller
location.</p>
</li>
</ol>
<p>Restriction 4 ‚Äúinterface independence‚Äù is currently not implemented due to lack of
post-monomorphized MIR pass, but implementing <code>#[track_caller]</code> as a language feature follows this
restriction.</p>
<h3 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h3>
<h4 id="-name-of-everything-"><a class="header" href="#-name-of-everything-">üö≤ Name of everything üö≤</a></h4>
<ul>
<li>Is <code>#[track_caller]</code> an accurate description?</li>
<li>Should we move <code>std::panic::Location</code> into <code>core</code>, or just use a 3-tuple to represent the
location? Note that the former is advocated in <a href="https://github.com/rust-lang/rfcs/pull/2070">RFC 2070</a>.</li>
<li>Is <code>Location::caller()</code> properly named?</li>
</ul>
<h4 id="using-an-abi-instead-of-an-attribute"><a class="header" href="#using-an-abi-instead-of-an-attribute">Using an ABI instead of an attribute</a></h4>
<pre><code class="language-rust">pub extern "implicit-caller-location" fn my_unwrap() {
    panic!("oh no");
}</code></pre>
<p>Compared with attributes, an ABI is a more natural way to tell the post-typechecking steps about
implicit parameters, pioneered by the <code>extern "rust-call"</code> ABI. However, creating a new ABI will
change the type of the function as well, causing the following statement to fail:</p>
<pre><code class="language-rust">let f: fn(Option&lt;u32&gt;) -&gt; u32 = Option::unwrap;
//~^ ERROR: [E0308]: mismatched types</code></pre>
<p>Making this pass will require supporting implicitly coercing <code>extern "implicit-caller-location" fn</code>
pointer to a normal function pointer. Also, an ABI is not powerful enough to implicitly insert a
parameter, making it less competitive than just using an attribute.</p>
<h4 id="repurposing-file-line-column"><a class="header" href="#repurposing-file-line-column">Repurposing <code>file!()</code>, <code>line!()</code>, <code>column!()</code></a></h4>
<p>We could change the meaning of <code>file!()</code>, <code>line!()</code> and <code>column!()</code> so they are only converted to
real constants after redirection (a MIR or trans pass) instead of early during macro expansion (an
AST pass). Inside <code>#[track_caller]</code> functions, these macros behave as this RFC‚Äôs
<code>caller_location()</code>. The drawback is using these macro will have different values at compile time
(e.g. inside <code>include!(file!())</code>) vs. runtime.</p>
<h4 id="inline-mir"><a class="header" href="#inline-mir">Inline MIR</a></h4>
<p>Introduced as an <a href="https://github.com/rust-lang/rfcs/pull/1669#issuecomment-231031865">alternative to RFC 1669</a>, instead of the <code>caller_location()</code> intrinsic,
we could provide a full-fledged inline MIR macro <code>mir!</code> similar to the inline assembler:</p>
<pre><code class="language-rust">#[track_caller]
fn unwrap(self) -&gt; T {
    let file: &amp;'static str;
    let line: u32;
    let column: u32;
    unsafe {
        mir! {
            StorageLive(file);
            file = const $CallerFile;
            StorageLive(line);
            line = const $CallerLine;
            StorageLive(column);
            column = const $CallerColumn;
            goto -&gt; 'c;
        }
    }
    'c: {
        panic!("{}:{}:{}: oh no", file, line, column);
    }
}</code></pre>
<p>The problem of <code>mir!</code> in this context is trying to kill a fly with a sledgehammer. <code>mir!</code> is a very
generic mechanism which requires stabilizing the MIR syntax and considering the interaction with
the surrounding code. Besides, <code>#[track_caller]</code> itself still exists and the magic constants
<code>$CallerFile</code> etc are still magical.</p>
<h4 id="default-function-arguments"><a class="header" href="#default-function-arguments">Default function arguments</a></h4>
<p>Assume this is solved by implementing <a href="https://github.com/rust-lang/rfcs/issues/323">RFC issue 323</a>.</p>
<pre><code class="language-rust">fn unwrap(file: &amp;'static str = file!(), line: u32 = line!(), column: u32 = column!()) -&gt; T {
    panic!("{}:{}:{}: oh no", file, line, column);
}</code></pre>
<p>Default arguments was a serious contender to the better-caller-location problem as this is usually
how other languages solve it.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th style="text-align: left">Language</th><th style="text-align: left">Syntax</th></tr>
</thead>
<tbody>
<tr><td style="text-align: left"><a href="https://developer.apple.com/swift/blog/?id=15">Swift</a></td><td style="text-align: left"><code>func unwrap(file: String = #file, line: Int = #line) -&gt; T</code></td></tr>
<tr><td style="text-align: left"><a href="https://dlang.org/spec/traits.html#specialkeywords">D</a></td><td style="text-align: left"><code>T unwrap(string file = __FILE__, size_t line = __LINE__)</code></td></tr>
<tr><td style="text-align: left"><a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/caller-information">C#</a> 5+</td><td style="text-align: left"><code>T Unwrap([CallerFilePath] string file = "&lt;n/a&gt;", [CallerLineNumber] int line = 0)</code></td></tr>
<tr><td style="text-align: left"><a href="https://ghc.haskell.org/trac/ghc/wiki/ExplicitCallStack/ImplicitLocations">Haskell</a> with GHC</td><td style="text-align: left"><code>unwrap :: (?callstack :: CallStack) =&gt; Maybe t -&gt; t</code></td></tr>
<tr><td style="text-align: left"><a href="https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html#index-_005f_005fbuiltin_005fLINE">C++</a> with GCC 4.8+</td><td style="text-align: left"><code>T unwrap(const char* file = __builtin_FILE(), int line = __builtin_LINE())</code></td></tr>
</tbody>
</table>
</div>
<p>A naive solution will violate restriction 4 ‚Äúinterface independence‚Äù: adding the <code>file, line, column</code>
arguments to <code>index()</code> will change its signature. This can be resolved if this is taken into
account.</p>
<pre><code class="language-rust">impl&lt;'a, K, Q, V&gt; Index&lt;&amp;'a Q&gt; for BTreeMap&lt;K, V&gt;
where
    K: Ord + Borrow&lt;Q&gt;,
    Q: Ord + ?Sized,
{
    type Output = V;

    // This should satisfy the trait even if the trait specifies
    // `fn index(&amp;self, idx: Idx) -&gt; &amp;Self::Output`
    #[inline]
    fn index(&amp;self, key: &amp;Q, file: &amp;'static str = file!(), line: u32 = line!(), column: u32 = column!()) -&gt; &amp;V {
        self.get(key).expect("no entry found for key", file, line, column)
    }
}</code></pre>
<p>This can be resolved if the future default argument proposal takes this into account. But again,
this feature itself is going to be large and controversial.</p>
<h4 id="semantic-inlining"><a class="header" href="#semantic-inlining">Semantic inlining</a></h4>
<p>Treat <code>#[track_caller]</code> as the same as a very forceful <code>#[inline(always)]</code>. This eliminates the
procedural macro pass. This was the approach suggested in the first edition of this RFC, since the
target functions (<code>unwrap</code>, <code>expect</code>, <code>index</code>) are just a few lines long. However, it experienced
push-back from the community as:</p>
<ol>
<li>Inlining causes debugging to be difficult.</li>
<li>It does not work with recursive functions.</li>
<li>People do want to apply the attribute to long functions.</li>
<li>The expected usage of ‚Äúsemantic inlining‚Äù and traditional inlining differ a lot, continue calling
it inlining may confuse beginners.</li>
</ol>
<p>Therefore the RFC is changed to the current form, and the inlining pass is now described as just an
implementation detail.</p>
<h4 id="design-by-contract"><a class="header" href="#design-by-contract">Design-by-contract</a></h4>
<p>This is inspired when investigating the difference in
<a href="#my-fault-vs-your-fault">‚Äúmy fault‚Äù vs ‚Äúyour fault‚Äù</a>. We incorporate ideas from <a href="https://en.wikipedia.org/wiki/Design_by_contract">design-by-contract</a>
(DbC) by specifying that ‚Äúyour fault‚Äù is a kind of contract violation. Preconditions are listed as
part of the function signature, e.g.</p>
<pre><code class="language-rust">// declaration
extern {
    #[precondition(fd &gt;= 0, "invalid file descriptor {}", fd)]
    fn close_fd(fd: c_int);
}

// declaration + definition
#[precondition(option.is_some(), "Trying to unwrap None")]
fn unwrap&lt;T&gt;(option: Option&lt;T&gt;) -&gt; T {
    match option {
        Some(t) =&gt; t,
        None =&gt; unsafe { std::mem::unchecked_unreachable() },
    }
}</code></pre>
<p>Code that appears in the <code>#[precondition]</code> attribute should be copied to caller site, so when the
precondition is violated, they can get the caller‚Äôs location.</p>
<p>Specialization should be treated like subtyping, where preconditions can be <em>weakened</em>:</p>
<pre><code class="language-rust">trait Foo {
    #[precondition(condition_1)]
    fn foo();
}

impl&lt;T: Debug&gt; Foo for T {
    #[precondition(condition_2a)]
    #[precondition(condition_2b)]
    default fn foo() { ... }
}

impl Foo for u32 {
    #[precondition(condition_3)]
    fn foo() { ... }
}

assert!(condition_3 || (condition_2a &amp;&amp; condition_2b) || condition_1);
// ^ automatically inserted when the following is called...
&lt;u32 as Foo&gt;::foo();</code></pre>
<p>Before Rust 1.0, there was the <a href="https://crates.io/crates/hoare"><code>hoare</code></a> compiler plugin which introduces DbC using the similar
syntax. However, the conditions are expanded inside the function, so the assertions will not fail
with the caller‚Äôs location. A proper solution will be similar to what this RFC proposes.</p>
<h3 id="non-viable-alternatives"><a class="header" href="#non-viable-alternatives">Non-viable alternatives</a></h3>
<p>Many alternatives have been proposed before but failed to satisfy the restrictions laid out in the
<a href="#rationale">Rationale</a> subsection, thus should <em>not</em> be considered viable alternatives within this
RFC, at least at the time being.</p>
<h4 id="macros"><a class="header" href="#macros">Macros</a></h4>
<p>The <code>unwrap!()</code> macro introduced in <a href="https://github.com/rust-lang/rfcs/pull/1669">RFC 1669</a> allows the user to write <code>unwrap!(x)</code> instead of
<code>x.unwrap()</code>.</p>
<p>A similar solution is introducing a <code>loc!()</code> macro that expands to
<code>concat!(file!(), ":", line!(), ":", column!())</code>, so user writes <code>x.expect(loc!())</code> instead of
<code>x.unwrap()</code>.</p>
<p>There is even the <a href="https://github.com/abonander/better_unwraps"><code>better_unwrap</code> crate</a> that
automatically rewrites all <code>unwrap()</code> and <code>expect()</code> inside a module to provide the caller location
through a procedural attribute.</p>
<p>All of these are non-viable since they require the user to actively change their source code, thus
violating restriction 2 ‚Äúsource compatibility‚Äù, <del>unless we are willing to drop the <code>!</code> from
macros</del>.</p>
<p>All pre-typeck rewrites are prone to false-positive failures affecting unrelated types that have an
<code>unwrap()</code> method. Post-typeck rewrites are no different from this RFC.</p>
<h4 id="backtrace"><a class="header" href="#backtrace">Backtrace</a></h4>
<p>When given debug information (DWARF section/file on Linux, <code>*.pdb</code> file on Windows, <code>*.dSYM</code> folder
on macOS), the program is able to obtain the source code location for each address. This solution is
often used in runtime-heavy languages like Python, Java and <a href="https://golang.org/pkg/runtime/#Caller">Go</a>.</p>
<p>For Rust, however:</p>
<ul>
<li>
<p>The debug information is usually not provided in release mode.</p>
<p>In particular, <code>cargo</code> defaults to disabling debug symbols in release mode (this default can
certainly be changed). <code>rustc</code> itself is tested in CI and distributed in release mode, so
getting a usable location in release mode is a real concern (see also <a href="https://github.com/rust-lang/rfcs/issues/1417">RFC 1417</a> for why it was
disabled in the official distribution in the first place).</p>
<p>Even if this is generated, the debug symbols are generally not distributed to end-users, which
means the error reports will only contain numerical addresses. This can be seen as a benefit, as
the implementation detail won‚Äôt be exposed, but how to submit/analyze an error report would be
out-of-scope for this RFC.</p>
</li>
<li>
<p>There are multiple issues preventing us from relying on debug info nowadays.</p>
<p>Issues <a href="https://github.com/rust-lang/rust/issues/24346">24346</a>  (<em>Backtrace does not include file and line number on non-Linux platforms</em>) and
<a href="https://github.com/rust-lang/rust/issues/42295">42295</a>  (<em>Slow backtrace on panic</em>) and are still not entirely fixed. Even after the debuginfo
is properly handled, if we decide not to expose the whole the full stacktrace, we may still need
to reopen pull request <a href="https://github.com/rust-lang/rust/issues/40264">40264</a>  (<em>Ignore more frames on backtrace unwinding</em>).</p>
<p>These signal that debuginfo support is not reliable enough if we want to solve the unwrap/expect
issue now.</p>
</li>
</ul>
<p>These drawbacks are the main reason why restriction 3 ‚Äúdebug-info independence‚Äù is added to the
motivation.</p>
<p>(A debuginfo-based stack trace proposal can be found at <a href="https://github.com/rust-lang/rfcs/pull/2154">RFC 2154</a>.)</p>
<h4 id="sourcecontext-generic-parameter"><a class="header" href="#sourcecontext-generic-parameter"><code>SourceContext</code> generic parameter</a></h4>
<p>Introduced as an <a href="https://github.com/rust-lang/rfcs/pull/1669#issuecomment-231896669">alternative in RFC 1669</a>, inspired by GHC‚Äôs implicit parameter:</p>
<pre><code class="language-rust">fn unwrap&lt;C: SourceContext = CallerSourceContext&gt;(self) -&gt; T {
    panic!("{}: oh no", C::default());
}</code></pre>
<p>The <code>CallerSourceContext</code> lang item will instruct the compiler to create a new type implementing
<code>SourceContext</code> whenever <code>unwrap()</code> is instantiated.</p>
<p>Unfortunately this violates restriction 4 ‚Äúinterface independence‚Äù. This solution cannot apply to
<code>HashMap::index</code> as this will require a change of the method signature of <code>index()</code> which has been
stabilized. Methods applying this solution will also lose object-safety.</p>
<p>The same drawback exists if we base the solution on <a href="https://github.com/rust-lang/rfcs/pull/2000">RFC 2000</a>  (<em>const generics</em>).</p>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<ul>
<li>
<p>If we want to support adding <code>#[track_caller]</code> to trait methods, the redirection
pass/query/whatever should be placed after monomorphization, not before. Currently the RFC
simply prohibit applying <code>#[track_caller]</code> to trait methods as a future-proofing measure.</p>
</li>
<li>
<p>Diverging functions should be supported.</p>
</li>
<li>
<p>The closure <code>foo::{{closure}}</code> should inherit most attributes applied to the function <code>foo</code>, in
particular <code>#[inline]</code>, <code>#[cold]</code>, <code>#[naked]</code> and also the ABI. Currently a procedural macro
won‚Äôt see any of these, nor would there be anyway to apply these attributes to a closure.
Therefore, <code>#[rustc_implicit_caller_location]</code> currently will reject <code>#[naked]</code> and ABI, and
leaving <code>#[inline]</code> and <code>#[cold]</code> mean no-op. There is no semantic reason why these cannot be
used though.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="2089-implied-bounds.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="2093-infer-outlives.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="2089-implied-bounds.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="2093-infer-outlives.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
