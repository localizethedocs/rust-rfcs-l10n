<!DOCTYPE HTML>
<html lang="en_US" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0599-default-object-bound - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-0060737d.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2015-02-12</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/599">rust-lang/rfcs#599</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/22211">rust-lang/rust#22211</a></li>
</ul>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Add a default lifetime bound for object types, so that it is no longer
necessary to write things like <code>Box&lt;Trait+'static&gt;</code> or <code>&amp;'a (Trait+'a)</code>. The default will be based on the context in which the
object type appears. Typically, object types that appear underneath a
reference take the lifetime of the innermost reference under which
they appear, and otherwise the default is <code>'static</code>. However,
user-defined types with <code>T:'a</code> annotations override the default.</p>
<p>Examples:</p>
<ul>
<li><code>&amp;'a &amp;'b SomeTrait</code> becomes <code>&amp;'a &amp;'b (SomeTrait+'b)</code></li>
<li><code>&amp;'a Box&lt;SomeTrait&gt;</code> becomes <code>&amp;'a Box&lt;SomeTrait+'a&gt;</code></li>
<li><code>Box&lt;SomeTrait&gt;</code> becomes <code>Box&lt;SomeTrait+'static&gt;</code></li>
<li><code>Rc&lt;SomeTrait&gt;</code> becomes <code>Rc&lt;SomeTrait+'static&gt;</code></li>
<li><code>std::cell::Ref&lt;'a, SomeTrait&gt;</code> becomes <code>std::cell::Ref&lt;'a, SomeTrait+'a&gt;</code></li>
</ul>
<p>Cases where the lifetime bound is either given explicitly or can be
inferred from the traits involved are naturally unaffected.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<h3 id="current-situation"><a class="header" href="#current-situation">Current situation</a></h3>
<p>As described in <a href="https://github.com/rust-lang/rfcs/blob/master/text/0034-bounded-type-parameters.md">RFC 34</a>, object types carry a single lifetime
bound. Sometimes, this bound can be inferred based on the traits
involved. Frequently, however, it cannot, and in that case the
lifetime bound must be given explicitly. Some examples of situations
where an error would be reported are as follows:</p>
<pre><code class="language-rust">struct SomeStruct {
    object: Box&lt;Writer&gt;, // &lt;-- ERROR No lifetime bound can be inferred.
}

struct AnotherStruct&lt;'a&gt; {
    callback: &amp;'a Fn(),  // &lt;-- ERROR No lifetime bound can be inferred.
}</code></pre>
<p>Errors of this sort are a <a href="https://github.com/rust-lang/rust/issues/16948">common source of confusion</a> for new
users (partly due to a poor error message). To avoid errors, those examples
would have to be written as follows:</p>
<pre><code class="language-rust">struct SomeStruct {
    object: Box&lt;Writer+'static&gt;,
}

struct AnotherStruct&lt;'a&gt; {
    callback: &amp;'a (Fn()+'a),
}</code></pre>
<p>Ever since it was introduced, there has been a desire to make this
fully explicit notation more compact for common cases. In practice,
the object bounds are almost always tightly linked to the context in
which the object appears: it is relatively rare, for example, to have
a boxed object type that is not bounded by <code>'static</code> or <code>Send</code> (e.g.,
<code>Box&lt;Trait+'a&gt;</code>). Similarly, it is unusual to have a reference to an
object where the object itself has a distinct bound (e.g., <code>&amp;'a (Trait+'b)</code>). This is not to say these situations <em>never</em> arise; as
we’ll see below, both of these do arise in practice, but they are
relatively unusual (and in fact there is never a good reason to do
<code>&amp;'a (Trait+'b)</code>, though there can be a reason to have <code>&amp;'a mut (Trait+'b)</code>; see <a href="#detailed-design">“Detailed Design”</a> for full details).</p>
<p>The need for a shorthand is made somewhat more urgent by
<a href="https://github.com/rust-lang/rfcs/pull/458">RFC 458</a>, which disconnects the <code>Send</code> trait from the <code>'static</code>
bound. This means that object types now are written <code>Box&lt;Foo+Send&gt;</code>
would have to be written <code>Box&lt;Foo+Send+'static&gt;</code>.</p>
<p>Therefore, the following examples would require explicit bounds:</p>
<pre><code class="language-rust">trait Message : Send { }
Box&lt;Message&gt; // ERROR: 'static no longer inferred from `Send` supertrait
Box&lt;Writer+Send&gt; // ERROR: 'static no longer inferred from `Send` bound</code></pre>
<h3 id="the-proposed-rule"><a class="header" href="#the-proposed-rule">The proposed rule</a></h3>
<p>This RFC proposes to use the context in which an object type appears
to derive a sensible default. Specifically, the default begins as
<code>'static</code>.  Type constructors like <code>&amp;</code> or user-defined structs can
alter that default for their type arguments, as follows:</p>
<ul>
<li>The default begins as <code>'static</code>.</li>
<li><code>&amp;'a X</code> and <code>&amp;'a mut X</code> change the default for object bounds within <code>X</code> to be <code>'a</code></li>
<li>The defaults for user-defined types like <code>SomeType&lt;X&gt;</code> are driven by
the where-clauses defined on <code>SomeType</code>, see the next section for
details. The high-level idea is that if the where-clauses on
<code>SomeType</code> indicate the <code>X</code> will be borrowed for a lifetime <code>'a</code>,
then the default for objects appearing in <code>X</code> becomes <code>'a</code>.</li>
</ul>
<p>The motivation for these rules is basically that objects which are not
contained within a reference default to <code>'static</code>, and otherwise the
default is the lifetime of the reference. This is almost always what
you want. As evidence, consider the following statistics, which show
the frequency of trait references from three Rust projects. The final
column shows the percentage of uses that would be correctly predicted
by the proposed rule.</p>
<p>As these statistics were gathered using <code>ack</code> and some simple regular
expressions, they only include cover those cases where an explicit
lifetime bound was required today. In function signatures, lifetime
bounds can always be omitted, and it is impossible to distinguish
<code>&amp;SomeTrait</code> from <code>&amp;SomeStruct</code> using only a regular
expression. However, we believe that the proposed rule would be
compatible with the existing defaults for function signatures in all
or virtually all cases.</p>
<p>The first table shows the results for objects that appear within a <code>Box</code>:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>package</th><th><code>Box&lt;Trait+Send&gt;</code></th><th><code>Box&lt;Trait+'static&gt;</code></th><th><code>Box&lt;Trait+'other&gt;</code></th><th>%</th></tr>
</thead>
<tbody>
<tr><td>iron</td><td>6</td><td>0</td><td>0</td><td>100%</td></tr>
<tr><td>cargo</td><td>7</td><td>0</td><td>7</td><td>50%</td></tr>
<tr><td>rust</td><td>53</td><td>28</td><td>20</td><td>80%</td></tr>
</tbody>
</table>
</div>
<p>Here <code>rust</code> refers to both the standard library and rustc. As you can
see, cargo (and rust, specifically libsyntax) both have objects that
encapsulate borrowed references, leading to types
<code>Box&lt;Trait+'src&gt;</code>. This pattern is not aided by the current defaults
(though it is also not made any <em>more</em> explicit than it already
is). However, this is the minority.</p>
<p>The next table shows the results for references to objects.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>package</th><th><code>&amp;(Trait+Send)</code></th><th><code>&amp;'a [mut] (Trait+'a)</code></th><th><code>&amp;'a mut (Trait+'b)</code></th><th>%</th></tr>
</thead>
<tbody>
<tr><td>iron</td><td>0</td><td>0</td><td>0</td><td>100%</td></tr>
<tr><td>cargo</td><td>0</td><td>0</td><td>5</td><td>0%</td></tr>
<tr><td>rust</td><td>1</td><td>9</td><td>0</td><td>100%</td></tr>
</tbody>
</table>
</div>
<p>As before, the defaults would not help cargo remove its existing
annotations (though they do not get any worse), though all other cases
are resolved. (Also, from casual examination, it appears that cargo
could in fact employ the proposed defaults without a problem, though
the types would be different than the types as they appear in the
source today, but this has not been fully verified.)</p>
<h2 id="detailed-design"><a class="header" href="#detailed-design">Detailed design</a></h2>
<p>This section extends the high-level rule above with support for
user-defined types, and also describes potential interactions with
other parts of the system.</p>
<p><strong>User-defined types.</strong> The way that user-defined types like
<code>SomeType&lt;...&gt;</code> will depend on the where-clauses attached to
<code>SomeType</code>:</p>
<ul>
<li>If <code>SomeType</code> contains a single where-clause like <code>T:'a</code>, where
<code>T</code> is some type parameter on <code>SomeType</code> and <code>'a</code> is some
lifetime, then the type provided as value of <code>T</code> will have a
default object bound of <code>'a</code>. An example of this is
<code>std::cell::Ref</code>: a usage like <code>Ref&lt;'x, X&gt;</code> would change the
default for object types appearing in <code>X</code> to be <code>'a</code>.</li>
<li>If <code>SomeType</code> contains no where-clauses of the form <code>T:'a</code> then
the default is not changed. An example of this is <code>Box</code> or
<code>Rc</code>. Usages like <code>Box&lt;X&gt;</code> would therefore leave the default
unchanged for object types appearing in <code>X</code>, which probably means
that the default would be <code>'static</code> (though <code>&amp;'a Box&lt;X&gt;</code> would
have a default of <code>'a</code>).</li>
<li>If <code>SomeType</code> contains multiple where-clausess of the form <code>T:'a</code>,
then the default is cleared and explicit lifetiem bounds are
required. There are no known examples of this in the standard
library as this situation arises rarely in practice.</li>
</ul>
<p>The motivation for these rules is that <code>T:'a</code> annotations are only
required when a reference to <code>T</code> with lifetime <code>'a</code> appears somewhere
within the struct body. For example, the type <code>std::cell::Ref</code> is
defined:</p>
<pre><code class="language-rust">pub struct Ref&lt;'b, T:'b&gt; {
    value: &amp;'b T,
    borrow: BorrowRef&lt;'b&gt;,
}</code></pre>
<p>Because the field <code>value</code> has type <code>&amp;'b T</code>, the declaration <code>T:'b</code> is
required, to indicate that borrowed pointers within <code>T</code> must outlive
the lifetime <code>'b</code>. This RFC uses this same signal to control the
defaults on objects types.</p>
<p>It is important that the default is <em>not</em> driven by the actual types
of the fields within <code>Ref</code>, but solely by the where-clauses declared
on <code>Ref</code>. This is both because it better serves to separate interface
and implementation and because trying to examine the types of the
fields to determine the default would create a cycle in the case of
recursive types.</p>
<p><strong>Precedence of this rule with respect to other defaults.</strong> This rule
takes precedence over the existing existing defaults that are applied
in function signatures as well as those that are intended (but not yet
implemented) for <code>impl</code> declarations. Therefore:</p>
<pre><code class="language-rust">fn foo1(obj: &amp;SomeTrait) { }
fn foo2(obj: Box&lt;SomeTrait&gt;) { }</code></pre>
<p>expand under this RFC to:</p>
<pre><code class="language-rust">// Under this RFC:
fn foo1&lt;'a&gt;(obj: &amp;'a (SomeTrait+'a)) { }
fn foo2(obj: Box&lt;SomeTrait+'static&gt;) { }</code></pre>
<p>whereas today those same functions expand to:</p>
<pre><code class="language-rust">// Under existing rules:
fn foo1&lt;'a,'b&gt;(obj: &amp;'a (SomeTrait+'b)) { }
fn foo2(obj: Box&lt;SomeTrait+'static&gt;) { }</code></pre>
<p>The reason for this rule is that we wish to ensure that if one writes
a struct declaration, then any types which appear in the struct
declaration can be safely copy-and-pasted into a fn signature. For example:</p>
<pre><code class="language-rust">struct Foo {
    x: Box&lt;SomeTrait&gt;, // equiv to `Box&lt;SomeTrait+'static&gt;`
}

fn bar(foo: &amp;mut Foo, x: Box&lt;SomeTrait&gt;) {
    foo.x = x; // (*)
}</code></pre>
<p>The goal is to ensure that the line marked with <code>(*)</code> continues to
compile. If we gave the fn signature defaults precedence over the
object defaults, the assignment would in this case be illegal, because
the expansion of <code>Box&lt;SomeTrait&gt;</code> would be different.</p>
<p><strong>Interaction with object coercion.</strong> The rules specify that <code>&amp;'a SomeTrait</code> and <code>&amp;'a mut SomeTrait</code> are expanded to <code>&amp;'a (SomeTrait+'a)</code>and <code>&amp;'a mut (SomeTrait+'a)</code> respectively. Today, in fn
signatures, one would get the expansions <code>&amp;'a (SomeTrait+'b)</code> and <code>&amp;'a mut (SomeTrait+'b)</code>, respectively. In the case of a shared reference
<code>&amp;'a SomeTrait</code>, this difference is basically irrelevant, as the
lifetime bound can always be approximated to be shorter when needed.</p>
<p>In the case a mutable reference <code>&amp;'a mut SomeTrait</code>, however, using
two lifetime variables is <em>in principle</em> a more general expansion. The
reason has to do with “variance” – specifically, because the proposed
expansion places the <code>'a</code> lifetime qualifier in the reference of a
mutable reference, the compiler will be unable to allow <code>'a</code> to be
approximated with a shorter lifetime. You may have experienced this if
you have types like <code>&amp;'a mut &amp;'a mut Foo</code>; the compiler is also forced
to be conservative about the lifetime <code>'a</code> in that scenario.</p>
<p>However, in the specific case of object types, this concern is
ameliorated by the existing object coercions. These coercions permit
<code>&amp;'a mut (SomeTrait+'a)</code> to be coerced to <code>&amp;'b mut (SomeTrait+'c)</code>
where <code>'a : 'b</code> and <code>'a : 'c</code>. The reason that this is legal is
because unsized types (like object types) cannot be assigned, thus
sidestepping the variance concerns. This means that programs like the
following compile successfully (though you will find that you get
errors if you replace the object type <code>(Counter+'a)</code> with the
underlying type <code>&amp;'a mut u32</code>):</p>
<pre><code class="language-rust">#![allow(unused_variables)]
#![allow(dead_code)]

trait Counter {
    fn inc_and_get(&amp;mut self) -&gt; u32;
}

impl&lt;'a&gt; Counter for &amp;'a mut u32 {
    fn inc_and_get(&amp;mut self) -&gt; u32 {
        **self += 1;
        **self
    }
}

fn foo&lt;'a&gt;(x: &amp;'a u32, y: &amp;'a mut (Counter+'a)) {
}

fn bar&lt;'a&gt;(x: &amp;'a mut (Counter+'a)) {
    let value = 2_u32;
    foo(&amp;value, x)
}

fn main() {
}</code></pre>
<p>This may seem surprising, but it’s a reflection of the fact that
object types give the user less power than if the user had direct
access to the underlying data; the user is confined to accessing the
underlying data through a known interface.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p><strong>A. Breaking change.</strong> This change has the potential to break some
existing code, though given the statistics gathered we believe the
effect will be minimal (in particular, defaults are only permitted in
fn signatures today, so in most existing code explicit lifetime bounds
are used).</p>
<p><strong>B. Lifetime errors with defaults can get confusing.</strong> Defaults
always carry some potential to surprise users, though it’s worth
pointing out that the current rules are also a big source of
confusion. Further improvements like the current system for suggesting
alternative fn signatures would help here, of course (and are an
expected subject of investigation regardless).</p>
<p><strong>C. Inferring <code>T:'a</code> annotations becomes inadvisable.</strong> It has
sometimes been proposed that we should infer the <code>T:'a</code> annotations
that are currently required on structs. Adopting this RFC makes that
inadvisable because the effect of inferred annotations on defaults
would be quite subtle (one could ignore them, which is suboptimal, or
one could try to use them, but that makes the defaults that result
quite non-obvious, and may also introduce cyclic dependencies in the
code that are very difficult to resolve, since inferring the bounds
needed without knowing object lifetime bounds would be challenging).
However, there are good reasons not to want to infer those bounds in
any case.  In general, Rust has adopted the principle that type
definitions are always fully explicit when it comes to reference
lifetimes, even though fn signatures may omit information (e.g.,
omitted lifetimes, lifetime elision, etc). This principle arose from
past experiments where we used extensive inference in types and found
that this gave rise to particularly confounding errors, since the
errors were based on annotations that were inferred and hence not
always obvious.</p>
<h2 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h2>
<ol>
<li>
<p><strong>Leave things as they are with an improved error message.</strong>
Besides the general dissatisfaction with the current system, a big
concern here is that if <a href="https://github.com/rust-lang/rfcs/pull/458">RFC 458</a> is accepted (which seems
likely), this implies that object types like <code>SomeTrait+Send</code> will now
require an explicit region bound. Most of the time, that would be
<code>SomeTrait+Send+'static</code>, which is very long indeed. We considered the
option of introducing a new trait, let’s call it <code>Own</code> for now, that
is basically <code>Send+'static</code>. However, that required (1) finding a
reasonable name for <code>Own</code>; (2) seems to lessen one of the benefits of
<a href="https://github.com/rust-lang/rfcs/pull/458">RFC 458</a>, which is that lifetimes and other properties can be
considered orthogonally; and (3) does nothing to help with cases like
<code>&amp;'a mut FnMut()</code>, which one would still have to write as <code>&amp;'a mut (FnMut()+'a)</code>.</p>
</li>
<li>
<p><strong>Do not drive defaults with the <code>T:'a</code> annotations that appear on
structs.</strong> An earlier iteration of this RFC omitted the consideration
of <code>T:'a</code> annotations from user-defined structs. While this retains
the option of inferring <code>T:'a</code> annotations, it means that objects
appearing in user-defined types like <code>Ref&lt;'a, Trait&gt;</code> get the wrong
default.</p>
</li>
</ol>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<p>None.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0593-forbid-Self-definitions.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="0601-replace-be-with-become.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0593-forbid-Self-definitions.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="0601-replace-be-with-become.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
