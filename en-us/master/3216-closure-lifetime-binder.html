<!DOCTYPE HTML>
<html lang="en_US" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>3216-closure-lifetime-binder - The Rust RFC Book</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-0060737d.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-5025baa3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rust RFC Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/rust-lang/rfcs" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <ul>
<li>Feature Name: <code>closure_lifetime_binder</code></li>
<li>Start Date: 2022-01-06</li>
<li>RFC PR: <a href="https://github.com/rust-lang/rfcs/pull/3216">rust-lang/rfcs#3216</a></li>
<li>Rust Issue: <a href="https://github.com/rust-lang/rust/issues/97362">rust-lang/rust#97362</a></li>
</ul>
<p>This RFC went through a pre-RFC phase at <a href="https://internals.rust-lang.org/t/pre-rfc-allow-for-a-syntax-with-closures-for-explicit-higher-ranked-lifetimes/15888">https://internals.rust-lang.org/t/pre-rfc-allow-for-a-syntax-with-closures-for-explicit-higher-ranked-lifetimes/15888</a></p>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Allow explicitly specifying lifetimes on closures via <code>for&lt;'a&gt; |arg: &amp;'a u8| { ... }</code>. This will always result in a higher-ranked closure which can accept <em>any</em> lifetime (as in <code>fn bar&lt;'a&gt;(val: &amp;'a u8) {}</code>). Closures defined without the <code>for&lt;'a&gt;</code> syntax retain their current behavior: lifetimes will be inferred as either some local region (via an inference variable), or a higher-ranked lifetime.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>There are several open issues around closure lifetimes (https://github.com/rust-lang/rust/issues/91966 and https://github.com/rust-lang/rust/issues/41078), all of which stem from type inference incorrectly choosing either a higher-ranked lifetime, or a local lifetime.</p>
<p>This can be illustrated in the following cases:</p>
<ol>
<li>We infer a higher-ranked region ( <code>for&lt;'a&gt; fn(&amp;'a u8)</code> ) when we really want some specific (local) region. This occurs in the following code:</li>
</ol>
<pre><code class="language-rust">fn main () {
    let mut fields: Vec&lt;&amp;str&gt; = Vec::new();
    let pusher = |a: &amp;str| fields.push(a);
}</code></pre>
<p>which gives the error:</p>
<pre><code>error[E0521]: borrowed data escapes outside of closure
 --&gt; src/main.rs:3:28
  |
2 |     let mut fields: Vec&lt;&amp;str&gt; = Vec::new();
  |         ---------- `fields` declared here, outside of the closure body
3 |     let pusher = |a: &amp;str| fields.push(a);
  |                   -        ^^^^^^^^^^^^^^ `a` escapes the closure body here
  |                   |
  |                   `a` is a reference that is only valid in the closure body
</code></pre>
<p>The issue is that <code>Vec&lt;&amp;str&gt;</code> is not higher-ranked, so we can only push an <code>&amp;'0 str</code> for some specific lifetime <code>'0</code> . The <code>pusher</code> closure signature requires that it accept <em>any</em> lifetime, which leads to a compiler error.</p>
<ol start="2">
<li>We infer some specific region when we really want a higher-ranked region. This occurs in the following code:</li>
</ol>
<pre><code class="language-rust">use std::cell::Cell;

fn main() {
    let static_cell: Cell&lt;&amp;'static u8&gt; = Cell::new(&amp;25);
    let closure = |s| {};
    closure(static_cell);
    let val = 30;
    let short_cell: Cell&lt;&amp;u8&gt; = Cell::new(&amp;val);
    closure(short_cell);
}</code></pre>
<p>The above code uses <code>Cell</code> to force invariance, since otherwise, region subtyping will make this example work even without a higher-ranked region. The above code produces the following error:</p>
<pre><code>error[E0597]: `val` does not live long enough
  --&gt; src/main.rs:8:43
   |
4  |     let static_cell: Cell&lt;&amp;'static u8&gt; = Cell::new(&amp;25);
   |                      ----------------- type annotation requires that `val` is borrowed for `'static`
...
8  |     let short_cell: Cell&lt;&amp;u8&gt; = Cell::new(&amp;val);
   |                                           ^^^^ borrowed value does not live long enough
9  |     closure(short_cell);
10 | }
   | - `val` dropped here while still borrowed
</code></pre>
<p>Here, the closure gets inferred to <code>|s: Cell&lt;&amp;'static u8&gt;|</code> , so it cannot accept a <code>Cell&lt;&amp;'0 u8&gt;</code> for some shorter lifetime <code>&amp;'0</code> . What we really want is <code>for&lt;'a&gt; |s: Cell&lt;&amp;'a u8&gt;|</code> , so that the closure can accept both <code>Cell</code> s.</p>
<p>It might be possible to create an ‘ideal’ closure lifetime inference algorithm, which always correctly decides between either a higher-ranked lifetime, or some local lifetime. Even if we were to implement this, however, the behavior of closure lifetimes would likely remain opaque to the majority of users. By allowing users to explicitly ‘desugar’ a closure, we can make it easier to teach how closures work. Users can also take advantage of the <code>for&lt;&gt;</code> syntax to explicitly indicate that a particular closure is higher-ranked - just as they can explicitly provide a type annotation for the parameters and return type - to improve the readability of their code.</p>
<p>Additionally, the Rust compiler currently accepts the following trait impls (and may eventually do so without any warnings):</p>
<pre><code class="language-rust">trait Trait {}
impl&lt;T&gt; Trait for fn(&amp;T) { }
impl&lt;T&gt; Trait for fn(T) { }</code></pre>
<p>See https://github.com/rust-lang/rust/pull/72493#issuecomment-633307151</p>
<p>These impls are accepted because <code>for&lt;'a&gt; fn(&amp;'a T)</code> and <code>fn(T)</code> are distinct types. While this not does <em>directly</em> apply to closures, closures <em>can</em> be cast to function pointers, which will have a different impl of <code>Trait</code> apply depending on whether they contain a higher-ranked lifetime parameter. Thus, the closure lifetimes inferred by the compiler can end up influencing what code is executed at runtime (provided that the user inserts the necessary cast to the correct function pointer type). While this is definitely an unusual case, it highlights the subtlety of lifetimes. Allowing greater control over how closure lifetimes are determined will allow users to better understand and control the behavior of their code in unusual situations like this one.</p>
<h2 id="guide-level-explanation"><a class="header" href="#guide-level-explanation">Guide-level explanation</a></h2>
<p>When writing a closure, you will often take advantage of type inference to avoid the need to explicitly specify types. For example:</p>
<pre><code class="language-rust">fn func(_: impl Fn(&amp;i32) -&gt; &amp;i32) {}

fn main() {
    func(|arg| { arg });
}</code></pre>
<p>Here, the type of <code>arg</code> will be inferred to <code>&amp;i32</code>, and the return type will also be <code>&amp;i32</code>. We can write this explicitly:</p>
<pre><code class="language-rust">fn func(_: impl Fn(&amp;i32) -&gt; &amp;i32) {}

fn main() {
    func(|arg: &amp;i32| -&gt; &amp;i32 { arg });
}</code></pre>
<p>Notice that we’ve <em>elided</em> the lifetime in <code>&amp;i32</code>. When a lifetime is written this way, Rust will infer its value based on how it’s used.</p>
<p>In this case, our closure needs to be able to accept an <code>&amp;i32</code> with <em>any</em> lifetime. This is because our closure needs to implement <code>Fn(&amp;i32) -&gt; &amp;i32</code> - this is syntactic sugar for <code>for&lt;'a&gt; Fn(&amp;'a i32) -&gt; &amp;'a i32</code>.</p>
<p>We can make this explicit by writing our closure in the following way:</p>
<pre><code class="language-rust">fn func(_: impl Fn(&amp;i32) -&gt; &amp;i32) {}

fn main() {
    func(for&lt;'a&gt; |arg: &amp;'a i32| -&gt; &amp;'a i32 { arg });
}</code></pre>
<p>This indicates to both the compiler and the user that this closure can accept an <code>&amp;i32</code> with <em>any</em> lifetime, and returns an <code>&amp;i32</code> with the same lifetime.</p>
<p>However, there are cases where a closure <em>cannot</em> accept any lifetime - it can only accept some particular lifetime. Consider the following code:</p>
<pre><code class="language-rust">fn main() {
    let mut values: Vec&lt;&amp;bool&gt; = Vec::new();
    let first = true;
    values.push(&amp;first);

    let mut closure = |value| values.push(value);
    let second = false;
    closure(&amp;second);
}</code></pre>
<p>In this code, <code>closure</code> takes in an <code>&amp;bool</code>, and pushes it to <code>values</code>. However, <code>closure</code> <em>cannot</em> accept an <code>&amp;bool</code> with <em>any</em> lifetime - it can only work with some specific lifetime. To see this, consider this slight modification of the program:</p>
<pre><code class="language-rust">fn main() {
    let mut values: Vec&lt;&amp;bool&gt; = Vec::new();
    let first = true;
    values.push(&amp;first);

    let mut closure = |value| values.push(value);
    { // This new scope was added
        let second = false;
        closure(&amp;second);
    } // The scope ends here, causing `second` to be dropped
    println!("Values: {:?}", values);
}</code></pre>
<p>This program fails to compile:</p>
<pre><code>error[E0597]: `second` does not live long enough
  --&gt; src/main.rs:9:17
   |
9  |         closure(&amp;second);
   |                 ^^^^^^^ borrowed value does not live long enough
10 |     }
   |     - `second` dropped here while still borrowed
11 |     println!("Values: {:?}", values);
   |                              ------ borrow later used here
</code></pre>
<p>This is because <code>closure</code> can only accept an <code>&amp;bool</code> with a lifetime that lives at least as long as <code>values</code>. If this code were to compile (that is, if <code>closure</code> could accept a <code>&amp;bool</code> with the shorter lifetime associated with <code>&amp;second</code>), then <code>values</code> would end up containing a reference to the freed stack variable <code>second</code>.</p>
<p>Since <code>closure</code> cannot accept <em>any</em> lifetime, it cannot be written as <code>for&lt;'a&gt; |value: &amp;'a bool| values.push(value)</code>. It’s natural to ask - how <em>can</em> we write down an explicit lifetime for <code>value: &amp;bool</code>?</p>
<p>Unfortunately, Rust does not currently allow the signature of such a closure to be written explicitly. Instead, you must rely on type inference to choose the correct lifetime for you.</p>
<h2 id="reference-level-explanation"><a class="header" href="#reference-level-explanation">Reference-level explanation</a></h2>
<p>We now allow closures to be written with a <code>for&lt;'a .. 'z&gt;</code> prefix, where <code>'a .. 'z</code> is a comma-separated sequence of zero or more lifetimes. The syntax is parsed identically to the <code>for&lt;'a .. 'z&gt;</code> in the function pointer type <code>for&lt;'a .. 'z&gt; fn(&amp;'a u8, &amp;'b u8) -&gt; &amp;'a u8</code>.
This can be use with or without the <code>move</code> keyword:</p>
<p><code>for&lt;'a .. 'z&gt; |arg1, arg2, ..., argN| { ... }</code>
<code>for&lt;'a .. 'z&gt; move |arg1, arg2, ..., argN| { ... }</code></p>
<p>When this syntax is used, any lifetimes specified with the <code>for&lt;&gt;</code> binder are always treated as higher-ranked, regardless of any other hints we discover during type inference. That is, a closure of the form <code>for&lt;'a, 'b&gt; |first: &amp;'a u8, second: &amp;'b bool| -&gt; &amp;'b bool</code>  will have a compiler-generated impl of the form:</p>
<pre><code class="language-rust">impl&lt;'a, 'b&gt; FnOnce(&amp;'a u8, &amp;'b bool) -&gt; &amp;'b bool for [closure type] { ... }</code></pre>
<p>Using this syntax requires that the closure signature be fully specified, without any elided lifetimes or implicit type inference variables. For example, all of the following closures do <strong>not</strong> compile:</p>
<pre><code class="language-rust">for&lt;'a&gt; |elided: &amp;u8, specified: &amp;'a bool| -&gt; () {}; // Compiler error: lifetime in &amp;u8 not specified
for&lt;'b&gt; || {}; // Compiler error: return type not specified
for&lt;'c&gt; |elided_type| -&gt; &amp;'c bool { elided_type }; // Compiler error: type of `elided_type` not specified
for&lt;&gt; || {}; // Compiler error: return type not specified</code></pre>
<p>This restriction allows us to avoid specifying how elided lifetime should be treated inside a closure with an explicit <code>for&lt;&gt;</code>. We may decide to lift this restriction in the future.</p>
<p>Additionally, this syntax is currently incompatible with async closures:</p>
<pre><code class="language-rust">for&lt;'a&gt; async |arg: &amp;'a u8| -&gt; () {}; // Compare error: `for&lt;&gt;` syntax cannot be used with async closures
for&lt;'a&gt; async move |arg: &amp;'a u8| -&gt; () {}; // Compare error: `for&lt;&gt;` syntax cannot be used with async closures</code></pre>
<p>This restriction may be lifted in the future, but the interactions between this feature and the <code>async</code> desugaring will need to be considered.</p>
<h2 id="drawbacks"><a class="header" href="#drawbacks">Drawbacks</a></h2>
<p>This slightly increases the complexity of the language and the compiler implementation. However, the syntax introduced (<code>for&lt;'a&gt;</code>) can already be used in both trait bounds and function pointer types, so we are not introducing any new concepts in the languages.</p>
<p>Previously, we only allowed the <code>for&lt;&gt;</code> syntax in a ‘type’ position: function pointers (<code>for&lt;'a&gt; fn(&amp;'a u8)</code>) and higher-ranked trait bounds (<code>where for&lt;'a&gt; T: MyTrait&lt;'a&gt;</code>). This RFC requires supporting the <code>for&lt;&gt;</code> syntax in an ‘expression’ position as well (<code>for&lt;'a&gt; |&amp;'a u8| { ... }</code>).
Crates that handle parsing Rust syntax (e.g. <code>syn</code>) will need to be updated to support this.</p>
<p>There is an ambiguity when parsing <code>for &lt;</code> in expression position: it can either be:</p>
<ol>
<li>The start of a <code>for</code> loop with a fully qualified path used as a pattern: <code>for &lt;MyType as MyTrait&gt;::Assoc { field1, field2 } in my_iter { }</code></li>
<li>The start of the generics for a higher-ranked closure: <code>for&lt;'a&gt; |my_arg: &amp;'a u8| { .. }</code></li>
</ol>
<p>However, the same kind of ambiguity exists when parsing <code>impl &lt;</code>: it can either be:</p>
<ol>
<li>A fully-qualified path: <code>impl &lt;MyType as MyTrait&gt;::Assoc { ... }</code></li>
<li>The start of the generics for an <code>impl</code> item: <code>impl&lt;T&gt; MyTrait for T { ... }</code></li>
</ol>
<p>We will handle disambiguation in the same way that we handle disambiguation for <code>impl &lt;</code> (performing additional lookahead to determine which case we are in).</p>
<p>In its initial form, this feature may be of limited usefulness - it can only be used with closures that have all higher-ranked lifetimes, prevents type elision from being used, and does not provide a way of explicitly indicating <em>non</em>-higher-ranked lifetimes. However, this proposal has been explicitly designed to be forwards-compatible with such additions. It represents a small, (hopefully) uncontroversial step towards better control over closure signatures.</p>
<h2 id="rationale-and-alternatives"><a class="header" href="#rationale-and-alternatives">Rationale and alternatives</a></h2>
<ul>
<li>We could use a syntax other than <code>for&lt;&gt;</code> for binding lifetimes - however, this syntax is already used, and has the same meaning here as it does in the other positions where it is allowed.</li>
<li>We could allow mixing elided and explicit lifetimes in a closure signature - for example, <code>for&lt;'a&gt; |first: &amp;'a u8, second: &amp;bool|</code>. However, this would force us to commit to one of several options for the interpretation of <code>second: &amp;bool</code></li>
</ul>
<ol>
<li>The lifetime in <code>&amp;bool</code> continues to be inferred as it would be without the <code>for&lt;'a&gt;</code>, and may or may not end up being higher-ranked.</li>
<li>The lifetime in <code>&amp;bool</code> is always <em>non</em>-higher-ranked (we create a region inference variable). This would allow for solving the closure inference problem in the opposite direction (a region is inferred to be higher-ranked when it really shouldn’t be).</li>
<li>Treat the signature exactly how it would be treated if it appeared in a function definition (e.g. <code>fn my_fn&lt;'a&gt;(first: &amp;'a u8, second: &amp;bool) { ... }</code>). This would provide consistently between closure and function signatures, but would inhibit the region inference variable behavior that’s unique to closures.</li>
</ol>
<p>We can choose at most one of these options. By banning this ambiguous case altogether, we can allow users to begin experimenting with the (limited) <code>for&lt;&gt;</code> closure syntax, and later reach a decision about how (or not) to explicitly indicate non-higher-ranked regions.</p>
<ul>
<li>We could try to design a ‘perfect’ or ‘ideal’ closure region inference algorithm that always correctly chooses between a higher-ranked and non-higher-ranked region, eliminating the need for users to explicitly specify their choice. Even if this is possible and easy to implement, there’s still value in allowing closures to be explicitly desugared for teaching purposes. Currently: function definitions, function pointers, and higher-ranked trait bounds (e.g. <code>Fn(&amp;u8)</code>) can all have their lifetimes (mostly) manually desugared - however, closures do not support this.</li>
<li>We could do nothing, and accept the status quo for closure region inference. Given the number of users that have run into issues in practice, this would mean keeping a fairly significant wart in the Rust language.</li>
</ul>
<h2 id="prior-art"><a class="header" href="#prior-art">Prior Art</a></h2>
<p>I previously discussed this topic in Zulip: https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/Explicit.20closure.20lifetimes</p>
<p>The <code>for&lt;&gt;</code> syntax is used with function pointers (<code>for&lt;'a&gt; fn(&amp;'a u8)</code>) and higher-ranked trait bounds (<code>fn bar&lt;T&gt;() where for&lt;'a&gt; T: Foo&lt;'a&gt; {}</code>)</p>
<p>I’m not aware of any languages that have anything analogous to Rust’s distinction between higher-ranked and non-higher-ranked lifetimes, let alone an interaction with closure/lambda type inference.</p>
<h2 id="unresolved-questions"><a class="header" href="#unresolved-questions">Unresolved questions</a></h2>
<p>None at this time</p>
<h2 id="future-possibilities"><a class="header" href="#future-possibilities">Future possibilities</a></h2>
<p>We could allow a lifetime to be explicitly indicated to be <em>non</em>-higher-ranked. The <code>'_</code> lifetime could be given special meaning in closures - for example, <code>for&lt;'a&gt; |first: &amp;'a u8, second: &amp;'_ bool| {}</code> could be used to indicate a closure that takes in a <code>&amp;u8</code> with any lifetime, and an <code>&amp;bool</code> with some specific lifetime. However, we already accept <code>|second: &amp;'_ bool| {}</code> as a closure, so this would require changing the behavior of <code>&amp;'_</code> when a <code>for&lt;&gt;</code> binder is present.</p>
<h3 id="appendix-late-bound-regions-early-bound-regions-and-region-variables"><a class="header" href="#appendix-late-bound-regions-early-bound-regions-and-region-variables">Appendix: Late-bound regions, early-bound regions, and region variables</a></h3>
<p>There are three ‘kinds’ of lifetimes we need to consider for closures:</p>
<ol>
<li>Late-bound lifetimes (also referred to as higher-ranked lifetimes). These lifetimes
can be written in function pointers using the <code>for&lt;&gt;</code> syntax (e.g. <code>for&lt;'a&gt; fn(&amp;'a u8) -&gt; &amp;'a u8</code>).
When a lifetime is used in a function argument without any other ‘restrictions’ (see below), then the corresponding function pointer type will have a late-bound lifetime. For example, the function <code>fn bar&lt;'a&gt;(val: &amp;'a u8) {}</code> can be cast to the function pointer type <code>for&lt;'a&gt; fn(&amp;'a u8)</code></li>
<li>Early-bound lifetimes. A lifetime becomes early-bound when it is ‘constrained’ in some way that prevents us from writing down the necessary bounds with a <code>for&lt;&gt;</code> binder. For example, the function <code>fn foo&lt;'a&gt;(&amp;'a u8) where &amp;'a u8: MyTrait&lt;'a&gt; {}</code> will have an early-bound lifetime <code>'a</code>, since we cannot write function pointer with a ‘higher-ranked bound’ like <code>for&lt;'a&gt; fn(&amp;'a u8) where &amp;'a u8: MyTrait&lt;'a&gt;</code></li>
<li>Region variables. This corresponds to some particular region in the enclosing function body, and cannot be explicitly named by the user. This exact region is inferred by the compiler based on the closure usage. For example:</li>
</ol>
<pre><code class="language-rust">fn main() {
    let mut values: Vec&lt;&amp;bool&gt; = Vec::new();
    let first = true;
    values.push(&amp;first);

    let mut closure = |value| values.push(value);
    let second = false;
    closure(&amp;second);
}</code></pre>
<p>Here, the closure stored in variable <code>closure</code> takes in an argument of type <code>&amp;'0 bool</code>, where <code>'0</code> is some region variable. The closure <em>cannot</em> accept a <code>&amp;bool</code> with an <em>any</em> lifetime - only lifetimes that live at least as long as <code>'0</code>.</p>
<p>This RFC is only concerned with higher-ranked (late-bound) lifetimes and region variables.</p>
<p>See https://rustc-dev-guide.rust-lang.org/early-late-bound.html#early-and-late-bound-variables and https://rust-lang.github.io/rfcs/0387-higher-ranked-trait-bounds.html#distinguishing-early-vs-late-bound-lifetimes-in-impls for more discussion about early-bound vs late-bound regions.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="3192-dyno.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="3228-process-process_group.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="3192-dyno.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="3228-process-process_group.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
